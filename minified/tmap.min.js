/**
 * TMap - A webmap framework for showing custom map data oriented
 * @version v1.0.1
 * @link http://www.tigerknows.com
 * @license MIT
 */
"use strict";!function(){function t(t,e,i){i?$.extend(t,new e(i[0])):$.extend(t,new e);for(var n in e.prototype)t[n]&&delete t[n]}function e(t,e){for(var i in e.prototype)null==t.prototype[i]&&(t.prototype[i]=e.prototype[i])}function i(t,e,i){t.prototype=$.extend(t.prototype,e.prototype,i)}function n(t,e){return function(){var i=new t;return"function"==typeof e&&e(i),i}}function s(){this.count=0,this.elapse=0,this.average=0,this.maximum=0}function r(){}function a(){var t=navigator.userAgent;navigator.appVersion,t.toLowerCase();this.trident=t.indexOf("Trident")>-1,this.presto=t.indexOf("Presto")>-1,this.tasman=t.indexOf("Tasman")>-1,this.webKit=t.indexOf("AppleWebKit")>-1,this.khtml=t.indexOf("KHTML")>-1,this.gecko=t.indexOf("Gecko")>-1&&!this.khtml,this.webApp=-1==t.indexOf("Safari"),this.msie=t.indexOf("MSIE")>-1,this.edge=t.indexOf("Edge")>-1,this.firefox=t.indexOf("Firefox")>-1,this.opera=t.indexOf("Opera")>-1,this.safari=t.indexOf("Safari")>-1,this.chrome=t.indexOf("Chrome")>-1||0,this.microsoft=this.msie||this.edge,this.ios=!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),this.android=t.indexOf("Android")>-1||t.indexOf("Linux")>-1,this.linux=t.indexOf("Linux")>-1,this.windows=t.indexOf("Windows")>-1,this.macintosh=t.indexOf("Macintosh")>-1,this.mobile=!!t.match(/AppleWebKit.*Mobile.*/)||!!t.match(/AppleWebKit/),this.iPhone=t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,this.iPad=t.indexOf("iPad")>-1,this.language=(navigator.browserLanguage||navigator.language).toLowerCase()}function o(t,e,i,n){if(this&&this instanceof o){if(arguments.length<2)throw new TypeError("tkDaemon - not enough arguments");t&&(this.owner=t),this.task=e,isFinite(i)&&i>0&&(this.rate=Math.floor(i)),n>0&&(this.length=Math.floor(n))}}function h(t,e,i,n,s){this.margin=s,this.top=t-s,this.bottom=e+s,this.left=i-s,this.right=n+s}function l(t,e){this.w=t=(t>>8)+(255&t?1:0),this.h=e=(e>>8)+(255&e?1:0),this.arr=[];for(var i=0;i<t*e;++i)this.arr.push([])}function c(t){this.capacity=t||256,this.cache={},this.size=0,this.header={},this.header.next=this.header,this.header.prev=this.header,this.delFunc=null}function u(t,e,i){function n(t,e){this.grid=new l(t,e),this.shownSet=new Set,this.shownLabels=[]}function s(t,e,i,n){var s=[0,g,d,d,w,p],r=[0,y,m,m,x,v];t.tile=i,t.context=e,e.textAlign="left",t.lctrl=n,t.fixXY=o,t.textTrim=u,5==t.j&&t.a.length>=2?t.r&&t.r.length&&!n.shownSet.has(t.r)&&T.bind(t)():(t.budget=s[t.j],t.draw=r[t.j],f(t)||t.draw())}function r(t){t.context.setTransform(e.ratio,0,0,e.ratio,0,0)}function a(t,n,s){var r=e.scale,a=r*(n+(t.tdx<<i)),o=r*(s+(t.tdy<<i));return[(e.x+a*e.cos0-o*e.sin0)/e.ratio,(e.y+a*e.sin0+o*e.cos0)/e.ratio]}function o(){var t=e.scale,n=this.a;this.tdx=this.tile.tx-e.tileX,this.tdy=this.tile.ty-e.tileY;var s=t*(n[0]+(this.tdx<<i)),r=t*(this.a[1]+(this.tdy<<i));this.x=(e.x+s*e.cos0-r*e.sin0)/e.ratio,this.y=(e.y+s*e.sin0+r*e.cos0)/e.ratio}function c(t,n){var s=e.scale;t.tdx=t.tile.tx-e.tileX,t.tdy=t.tile.ty-e.tileY;var r=s*(n.x+(t.tdx<<i)),a=s*(n.y+(t.tdy<<i));n.x=(e.x+r*e.cos0-a*e.sin0)/e.ratio,n.y=(e.y+r*e.sin0+a*e.cos0)/e.ratio}function u(){if(!this.ll){null==this.n&&(this.n=10);var t,e=this.r.length,i=this.n,n=this.context;n.font=this.n+z,(t=this.r.indexOf("\n"))>0?(this.rr=[this.r.substr(0,t),this.r.substr(t+1)],this.rrl=this.rr.map(function(t){return n.measureText(t).width}),this.ll=Math.max.apply(null,this.rrl),this.hh=i+i):e>10?(t=Math.ceil(e/2),this.rr=[this.r.substr(0,t),this.r.substr(t)],this.rrl=this.rr.map(function(t){return n.measureText(t).width}),this.ll=Math.max.apply(null,this.rrl),this.hh=i+i):(this.ll=n.measureText(this.r).width,this.hh=i)}}function f(t){var e;return t.j&&t.lctrl._couldShow(t,e=t.budget())?(t.lctrl._prepare(t,e),0):1}function d(){if(null!=this.r&&0!=this.r.length&&this.imgInfo){this.fixXY(),this.textTrim();var t=this.x,e=this.y,i=this.ll,n=this.hh;this.iw=this.imgInfo.iw,this.ih=this.imgInfo.ih;var s=new h(e-n/2,e+n/2,t-this.iw/2,t+this.iw/2+i+3,S);return s.label=this,s}}function m(){var e=this.context,i=this.x,n=this.y,s=this.imgInfo,r=0;s&&0==s.t&&s.img&&(e.drawImage(s.img,s.x,s.y,s.w,s.h,i-this.iw/2,n-this.ih/2,s.iw,s.ih),r=this.iw/2+3),e.font=this.n+z,this.imgInfo&&0!=this.imgInfo.t||(e.lineWidth=2*(this.w||(this.w=1)),e.strokeStyle=this.s||L,_(this,r,A)),e.fillStyle=this==t.poiLabel?"#f00":this.f,_(this,r,P)}function p(){this.fixXY(),this.textTrim();var t=this.x,e=this.y,i=(this.ll||0)/2,n=(this.hh||0)/2,s=new h(e-n,e+n,t-i,t+i,S);return s.label=this,s}function v(){var e=this.context;this.x,this.y;e.font=this.n+z,e.lineWidth=2*(this.w||(this.w=2)),e.strokeStyle=this.s||L,M(this,0,A),e.fillStyle=this==t.poiLabel?"#f00":this.f,M(this,0,P)}function g(){this.fixXY(),this.textTrim();var t=this.x,e=this.y,i=this.ll/2+5,n=this.hh/2+5;return new h(e-n,e+n,t-i,t+i,S)}function y(){var t=this.context,e=this.x,i=this.y,n=this.imgInfo;n&&9==n.t&&n.img&&(t.drawImage(n.img,n.x,n.y,n.w,n.h,e-this.ll/2-5,i-this.hh/2-5,this.ll+10,this.hh+10),e-=this.ll/2),t.font=this.n+z,t.fillStyle=this.f,M(this,0,P)}function w(){this.fixXY();var t,e,i=this.x,n=this.y;return t=(this.iw||0)/2,e=(this.ih||0)/2,new h(n-e,n+e,i-t,i+t,S)}function x(){var e=this.context,i=this.x,n=this.y,s=this.imgInfo;s&&0==s.t&&s.img&&e.drawImage(s.img,s.x,s.y,s.w,s.h,i-this.iw/2,n-this.ih/2,s.iw,s.ih),t.poiLabel}function _(t,e,i){var n=t.x+e,s=t.y,r=t.context;if(t.rr){s-=t.n*(t.rr.length-1)/2;for(var a=0,o=t.rr.length;a<o;++a)r[i](t.rr[a],n,s),s+=t.n}else r[i](t.r,n,s)}function M(t,e,i){var n=t.x,s=t.y+e,r=t.context;if(t.rr){0==e&&(s-=t.n*(t.rr.length-1)/2);for(var a=0,o=t.rr.length;a<o;++a)r[i](t.rr[a],n-t.rrl[a]/2,s),s+=t.n}else r[i](t.r,n-t.ll/2,s)}function k(t,e,i,n,s,r){t.context[r](e,i,n)}function b(t,e){var i=t[e]-t[e+2],n=t[e+1]-t[e+3];return Math.sqrt(i*i+n*n)}function C(t,e,i,n,s,r){var o=s<<1,l=n[o]-e,c=n[o+1]-i,u=Math.sqrt(l*l+c*c);if(u>=r){var f=r/u,d=e+l*f,m=i+c*f,p=a(t,d,m),v=p[0],g=p[1];return{sx:v,sy:g,x:d,y:m,index:s,rect:new h(g-r,g+r,v-r,v+r,0)}}}function T(){var t=this.r.length,i=this.n*B,n=(b(this.a,0),1),s=this.lctrl.grid,a=this.a[0],o=this.a[1],h=[],l=t,c=this.a.length>>1;for(this.tdx=this.tile.tx-e.tileX,this.tdy=this.tile.ty-e.tileY;l;){var u=C(this,a,o,this.a,n,i);if(u&&s.puttable(u.rect))a=u.x,o=u.y,u.rect.x=a,u.rect.y=o,n=u.index,h.push(u),--l;else{if(++n>=c)return;h=[],l=t}}var f,d=h[0],m=[0,0,0,0];for(n=1;n<t;++n){f=h[n];var p=Math.atan2(d.sy-f.sy,d.sx-f.sx),v=Math.round(p/D*2+6)%4;m[v]++,f.ang=p,1==n&&(m[v]++,d.ang=p),d=f}for(var g=3,y=0,w=0;y<4;++y)w<m[y]&&(w=m[g=y]);g=O[g],--t;var x=Math.atan2(h[0].sy-h[t].sy,h[0].sx-h[t].sx);x=-I<x&&x<=3*I,i/=2;var _=this.context,M=[this,,[]];for(_.font=this.n+z,_.lineWidth=2*(this.w||(this.w=2)),_.strokeStyle=this.s||L,_.fillStyle=this.f,_.textAlign="center",n=t;n>=0;--n){var T=this.r.charAt(n),d=h[x?t-n:n];s.putrect(d.rect),M[2].push(d.rect),a=d.sx,o=d.sy,_.translate(a,o),_.rotate(d.ang+g),k(this,T,0,0,0,A),k(this,T,0,0,0,P),r(this)}this.lctrl.shownSet.add(this.r),this.lctrl.shownLabels.push(M)}var P="fillText",A="strokeText",L="#fff",S=10,z="px 黑体",D=Math.PI,I=D/4,B=Math.SQRT2,O=[-D,D/2,0,-D/2],E=t.owner().layers;n.prototype={_couldShow:function(t,e){return null!=e&&((4==t.j||!this.shownSet.has(t.r))&&!(e&&!this.grid.puttable(e)))},_prepare:function(t,e){4!=t.j&&this.shownSet.add(t.r),this.grid.putrect(e),this.shownLabels.push([t,,[e]])},snapLabels:function(t){for(var i,n=0,s=this.shownLabels.length;n<s;++n){var r=(i=this.shownLabels[n])[2];i[1]=r.map(function(i){var n=e.ratio,s=i.label,r=i.right-i.left-2*i.margin,a=i.bottom-i.top-2*i.margin,o=i.left+i.margin,h=i.top+i.margin;return{image:t.getImageData(o*n,h*n,r*n,a*n),sx:s?s.x-o:r/2,sy:s?s.y-h:a/2}})}},putSnap:function(t){for(var i,n,s=0,r=this.shownLabels.length;s<r;++s){(n=(i=this.shownLabels[s])[0]).fixXY();var a=i[2],o=i[1];if(1==a.length)h=o[0],t.putImageData(h.image,(n.x-h.sx)*e.ratio,(n.y-h.sy)*e.ratio);else for(var h,l,u=0,f=a.length;u<f;++u)h=o[u],c(n,l=a[u]),t.putImageData(h.image,(l.x-h.sx)*e.ratio,(l.y-h.sy)*e.ratio)}}},t.shiori=function(t){t.clearRect(0,0,e.width,e.height);var i=new n(e.width,e.height);t.save(),t.lineCap=t.lineJoin="round",t.miterLimit=2,t.textBaseline="middle",t.setTransform(e.ratio,0,0,e.ratio,0,0);for(var r,a=0,o=E.length;a<o;++a)if((r=E[a]).hasLabel&&r.showLabel)for(var h,l=r.drawTiles,c=0,u=l.length;c<u;++c)if((h=l[c]).l)for(var f=0,d=h.l.length;f<d;++f)s(h.l[f],t,h,i);return t.restore(),i}}function f(e,n){function s(t){this.dataPool=t,this.queue=[],this.proqueue=new Set}function r(){t(this,s,arguments),window.XMLHttpRequest||window.ActiveXObject?(this.XHR=!0,this.netWorking=!1):alert("Your browser does not support XMLHttpRequest.")}function a(){t(this,s,arguments),this.downloadCount=0,this.netWorking=0}var o=p.domain+"/perseus/webmap";s.prototype={setTaskQueue:function(t){},startQuery:function(){}},i(r,s,{loadData:function(t,e){var i=this;i.netWorking=!0,$.ajax({type:"POST",url:o,timeout:p.timeout,data:t,dataType:"json",success:function(t,s,r){if(t){if(t instanceof Array)for(var a in t)i.dataPool.setObject(t[a]);else t&&i.dataPool.setObject(t);e&&n()}},complete:function(t,e){i.netWorking=!1,"success"!=e&&console.log("fuck")}})},setTaskQueue:function(t){this.queue&&this.queue.queryIndex==t.queryIndex||(this.queue=t,this.netWorking||this.queue.length>0&&this.startQuery())},startQuery:function(){var t,i=[];this.proqueue.clear();for(var n=0;n<4&&this.queue.length>0;)t=this.queue.pop(),this.proqueue.has(t.key)||e.get(t.key)||(this.proqueue.add(t.key),i.push(t.key),++n);i.length?(i="at=wm&v=1&key="+i.join("-"),this.loadData(i,this.queue.needDraw)):this.netWorking=!1}}),i(a,s,{setTaskQueue:function(t){this.queue=t,this.netWorking<1&&this.queue.length>0&&this.startQuery()},startQuery:function(){for(var t=this.queue.pop();(e.get(t.key)||this.proqueue.has(t.key))&&this.queue.length>0;)t=this.queue.pop();if(!e.get(t.key)&&!this.proqueue.has(t.key)){++this.netWorking,this.proqueue.add(t.key);var i=this,s=this.queue.needDraw,r=new Image;r.onerror=function(){--i.netWorking},r.onload=function(){t.img.crossOrigin="anonymous",t.layer._owner.canvases[0].glGenTexture&&(t.tex=t.layer._owner.canvases[0].glGenTexture(t.img)),i.dataPool.setTile(t),i.proqueue.delete(t.key),i.queue.length,--i.netWorking,s&&n()},r.crossOrigin="anonymous",t.img=r,t.svr=this.downloadCount++%8,t.layer.send(t)}}}),e.tssh={gMsg:new r(e),grMsg:new a(e)}}function d(t){return t<5?{"background-image":'url("img/m0.png")',color:"black",width:"53px",height:"53px","line-height":"53px"}:t<20?{"background-image":'url("img/m1.png")',color:"black",width:"56px",height:"56px","line-height":"56px"}:t<100?{"background-image":'url("img/m2.png")',color:"black",width:"66px",height:"66px","line-height":"66px"}:t<400?{"background-image":'url("img/m3.png")',color:"black",width:"78px",height:"78px","line-height":"78px"}:{"background-image":'url("img/m4.png")',color:"black",width:"90px",height:"90px","line-height":"90px"}}function m(t){this._markerClusterer=t,this._map=t.getMap(),this._minClusterSize=t.getMinClusterSize(),this._isAverageCenter=t.isAverageCenter(),this._center=null,this._markers=[],this._gridBounds=null,this._isReal=!1,this._clusterMarker=new p.TextIconOverlay(this._center,this._markers.length,{styles:this._markerClusterer.getStyles()})}var p=window.TMap={domain:"http://"+window.location.host,timeout:1e4},v={private:{}};null==Set.prototype.entries?Set.prototype.merge=function(t){if(t instanceof Set)for(var e in t)this.add(e)}:Set.prototype.merge=function(t){if(t instanceof Set){var e,i=t.entries();for(e=i.next();e.value;)this.add(e.value[0]),e=i.next()}},String.prototype.visualLength=function(t){var e=$("#tkm-text-ruler");return t&&e.css(t),e.text(this),e.width()},Date.prototype.format=function(t){var e={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S+":this.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var i in e)new RegExp("("+i+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[i]:("00"+e[i]).substr((""+e[i]).length)));return t},s.prototype={begin:function(){this.tick=Date.now()},end:function(){var t=Date.now()-this.tick;t>this.maximum&&(this.maximum=t),this.elapse+=t,this.average=this.elapse/++this.count},reset:function(){this.count=0,this.elapse=0,this.average=0,this.maximum=0}},r.prototype={_addListener:function(t,e){var i=this._listeners[e];null==i&&(this._listeners[e]=i=[]),i.push({id:this._listeners._count,f:t})},addListener:function(t,e,i){if(null==this._listeners&&(this._listeners={}),null==this._listeners._count&&(this._listeners._count=0),++this._listeners._count,e instanceof Array)for(var n=0,s=e.length;n<s;++n)this._addListener(t,e[n]);else this._addListener(t,e);return i&&t(),this._listeners._count},removeListener:function(t){if(0!=t&&null!=this._listeners){var e=0;for(var i in this._listeners){var n=this._listeners[i],s=-1;if(n instanceof Array){for(var r=0,a=n.length;r<a;++r)if(n[r].id==t||n[r].f==t){e=n[r].id,s=r;break}s>=0&&n.splice(s,1)}}return e}},_notifyListener:function(t,e){var i=this._listeners[t];if(null!=i){null==e&&(e={}),null==e.target&&(e.target=this._listenerTargetGetter?this._listenerTargetGetter(this):this),null==e.type&&(e.type=t);for(var n,s=0;n=i[s++];)n.f(e)}},listenerNotify:function(t,e){if(null!=this._listeners)if(t instanceof Array)for(var i in t)this._notifyListener(t[i],e);else this._notifyListener(t,e)}},function(){p.Dataset=function(t,e){this.maxVal=20,this.frameCount=1;var i=this;i.data=e?e(t):t,this.get=function(){return{cur:0,next:function(){if(this.cur<i.data.length){var t={};if($.extend(t,i.data[this.cur++]),null==t.x){var e=i._owner.pointToPixel(t);t.x=e.x,t.y=e.y}return t}return null}}}},p.Dataset.prototype.get=function(){return null},p.Animater={},v.private.kanimate=function(t,e,i,n){function s(){!c||u||h.frameCount<1||(1==h.frameCount?r():(P||(P=setInterval(s,t.interval||125)),r(),C._animeIsNotPausedButPlaying&&++l>=h.frameCount&&(l=0),h.update&&h.update(l)))}function r(){if(h.drawing){var e=T[l];e?k.putImageData(e,0,0):(o(),h.render(l),T[l]=k.getImageData(0,0,C.width,C.height))}else o();t._notifyFrameCallback(l)}function a(){C._animeIsNotPausedButPlaying=!C._animeIsNotPausedButPlaying,C._animeIsNotPausedButPlaying?s():(clearInterval(P),P=null)}function o(){k.setTransform(1,0,0,1,0,0),k.clearRect(0,0,b.width,b.height)}var h,l,c,u,f,d,m,p,v,g,y,w,x,_,M=t._owner,k=t.context,b=M.mapMode,C={},T={},P=null;C.setTimer=function(t){0<=t&&t<h.frameCount&&(l=t)},C.show=function(){C._animeIsNotPausedButPlaying=!0,C.animating()},C.hide=function(t){C._animeIsNotPausedButPlaying=!1,t||setTimeout(o,35)},C.pause=a,C.stutter=function(){c&&(u=!0)},C.checkStutter=function(){c&&(u=!1,C._animeIsNotPausedButPlaying&&C.animating())},C.clear=o,C.listening=function(){v=23-b.z,f=b.mctX<<v,d=b.mctY<<v,m=b.width/2,p=b.height/2,C.width=b.width,C.height=b.height,g=b.scale/(1<<v),b.rotate&&(y=g*b.cos0,w=g*b.sin0,x=-w,_=y);var t=h.bbox;if(t){for(var e=b.calcRange(),n=0;n<4;++n)e[n]<<=v;t.xl>e[1]||t.xr<e[0]||t.yt>e[3]||t.yb<e[2]?h.drawing=!1:h.drawing=!0}C.DBox=e,C.dataset=i,T={},h.modeChange()},C.animating=s,C.initContext=function(t,e){if(b.rotate){var i=(e.x-f)*g,n=(e.y-d)*g,s=i*b.cos0-n*b.sin0+m,r=i*b.sin0+n*b.cos0+p;k.setTransform(y,w,x,_,s,r)}else{var i=(e.x-f)*g+m,n=(e.y-d)*g+p;k.setTransform(g,0,0,g,i,n)}},C.isInBBox=function(t,e){return this.DBox[0]<=t&&t<=this.DBox[1]&&this.DBox[2]<=e&&e<=this.DBox[3]},C.isRectIntersect=function(t){return!(this.DBox[1]<t[0]||this.DBox[0]>t[1]||this.DBox[2]>t[3]||this.DBox[3]<t[2])},C.mapMode=b,C.dataset=i,C.options=n,t.start=function(e){c=!0,u=!1,null==C.kaListener&&(C.kaListener=b.addListener(C.listening,["zoom","move","rotate","resize"],!0)),t.show(),e?(C._animeIsNotPausedButPlaying=!1,r()):(C._animeIsNotPausedButPlaying=!0,C.animating())},t.setTimer=function(t){0<=t&&t<h.frameCount&&(l=t,r())},t.getTimer=function(){return 1==h.frameCount?0:0==l?h.frameCount-1:l-1},t.getFrameCount=function(){return h.frameCount},t.pause=a,t.isPausing=function(){return C._animeIsNotPausedButPlaying},t.stop=C.hide,t.stutter=C.stutter,t.checkStutter=C.checkStutter,t.setTimerInterval=function(e){t.interval=e,clearInterval(P),P=null,C._animeIsNotPausedButPlaying&&s()},t.uninstall=function(){b.removeListener(C.kaListener),clearInterval(P),c=!1,u=!0,C._animeIsNotPausedButPlaying=!1,h.drawing=!1,T=null,h=null,C=null,delete t.getFrameCount,delete t.isPausing,delete t.setTimer,delete t.start,delete t.pause,delete t.stop,delete t.stutter,delete t.checkStutter,delete t.uninstall,delete t.setTimerInterval},l=0,c=!1,u=!0,C._animeIsNotPausedButPlaying=!1,C.context=k,C.sv=M.mapsv,h=new e(C),t.start(!0)},p.Animater.Voronoi=function(t){function e(t){t.textBaseline="top",t.fillText("平湖溃堤淹没点图例",0,0),t.translate(0,20);var e=t.createLinearGradient(0,200,0,0);e.addColorStop(0,"rgba(0,255,0,0)"),e.addColorStop(.25,"yellow"),e.addColorStop(.5,"blue"),e.addColorStop(.75,"red"),e.addColorStop(1,"black"),t.fillStyle=e,t.fillRect(0,0,20,200),t.strokeRect(0,0,20,200),t.beginPath();for(var i=0;i<5;++i)t.moveTo(20,50*i),t.lineTo(23,50*i);t.stroke(),t.closePath(),t.fillStyle="green",t.textBaseline="bottom",t.fillText("0米",25,200),t.fillStyle="yellow",t.textBaseline="middle",t.fillText("1米",25,150),t.fillStyle="blue",t.fillText("2米",25,100),t.fillStyle="red",t.fillText("3米",25,50),t.fillStyle="black",t.textBaseline="top",t.fillText("4米及以上",25,0)}function i(t){if(t<=0)return null;if(t>=5)return"#000";var e=(256*t/5|0)<<2,i=e<256?e/255:1;return"rgba("+o[e]+","+o[e+1]+","+o[e+2]+","+i+")"}function n(t,e){var i=Math.floor(e/c),n=e%c;if(n&&i<7){var s=t.data[i],r=t.data[i+1];return n/=c,s+(r-s)*n}return t.data[i]}function s(e){t.clear();for(var s=t.context,a=0;a<r;++a){var o=h[a],l=i(n(o,e));if(null!=l){var c=o.bound;t.initContext(s,o),s.beginPath(),s.moveTo(c[0],c[1]);for(var u=2,f=c.length;u<f;u+=2)s.lineTo(c[u],c[u+1]);s.fillStyle=l,s.fill(),s.closePath()}}}var r,a,o,h=[],l={},c=10;this.DBox=null,this.drawing=!0;this.modeChange=function(){var e=t.dataset;h=[];for(var i=0,n=e.length;i<n;++i){var s=e[i];s.bound&&t.isInBBox(s.x,s.y)&&h.push(s)}r=h.length,l={}},this.render=s,this.frameCount=80,this.bbox={xl:1795215321,xr:1797133859,yt:880059313,yb:881988333},this.update=function(t){a.css({left:2.5*t+"px"})},function(i){var n=$("<canvas>").attr({width:"150px",height:"220px"}).css({position:"absolute",left:"5px",top:"5px"}),s=$("<div>").attr({width:50,style:"position:absolute;left:55px;bottom:5px;background-color:rgb(246,172,22);"}).text("暂停").click(function(){t.pause(),"暂停"==s.text()?s.text("继续"):s.text("暂停")});e(n[0].getContext("2d"));var r=$("<div>").attr({class:"tkm-animate-control-panel"}).hide().append(n,s);i.append(r)}(t.sv),function(e){var i=$("<div>").attr({class:"tkm-animate-control-slider"}).hide().append($("<div>").attr({class:"tkm-animate-control-slot"}),a=$("<div>").attr({class:"tkm-animate-control-button"}));e.append(i);for(var n=0;n<=8;++n){var r=$("<div>").attr({class:"tkm-animate-control-slotmark"}).css({left:10+200*n/8+"px"});i.append(r)}$(function(){var e,i,n=a,r=!1,o=null;n.click(function(){}).mousedown(function(s){r=!0,i=s.pageX-parseInt(n.css("left")),e=t._animeIsNotPausedButPlaying,t._animeIsNotPausedButPlaying=!1}),$(document).mousemove(function(e){if(r){var a=e.pageX-i;a<0?a=0:a>194&&(a=194),n.css({left:a}),t.setTimer(79*a/194),o||(o=setTimeout(function(){o=null,s()},66))}}).mouseup(function(){r&&(r=!1,t._animeIsNotPausedButPlaying=e,e&&t.animating())})})}(t.sv),o=function(){var t=document.createElement("canvas");t.height=1,t.width=256;var e=t.getContext("2d"),i=e.createLinearGradient(0,0,256,0);return i.addColorStop(0,"green"),i.addColorStop(.25,"yellow"),i.addColorStop(.5,"blue"),i.addColorStop(.75,"red"),i.addColorStop(1,"black"),e.fillStyle=i,e.fillRect(0,0,256,1),e.getImageData(0,0,256,1).data}()},p.Animater.scatter=function(t){var e=t.dataset,i=t.options,n=new p.Drawer.scattermap(t,e,i);this.modeChange=function(){},this.render=function(t){e.sec=t,n.render()},this.frameCount=e.frameCount,this.bbox=[-1/0,1/0,-1/0,1/0],this.drawing=!0},p.Animater.heatmap=function(t){var e;this.DBox=null,this.drawing=!0,this.modeChange=function(){e=new p.Drawer.heatmap(t,t.dataset,t.options)},this.render=function(i){t.dataset.sec=i,e.render()},this.frameCount=t.dataset.frameCount}}(),function(){var t=Math.PI,e=Math.PI/2,i=2*Math.PI,n=4*Math.PI,s=t/180,r=180/t,a=0x3a052cf8639b6a,o=window.TMap.GeoUtils=window.TMap.GeoUtils||function(){};o.ll2mct=function(t,e,r){var a=256*(1<<r);return[(t+180)/360*a,(i-Math.log(2/(1-Math.sin(e*s))-1))/n*a]},o.mct2ll=function(t,e,s){var a=1/(256*(1<<s));return[360*t*a-180,Math.asin(1-2/(1+Math.exp(i-n*e*a)))*r]},o.t2ll=function(t,e,s){var a=1/(1<<s);return[360*t*a-180,Math.asin(1-2/(1+Math.exp(i-n*e*a)))*r]},o.mct2wmt=function(t,e,s){var a=1/(256*(1<<s)),o=360*t*a-180,h=Math.asin(1-2/(1+Math.exp(i-n*e*a)))*r;return a=(1<<s)/360,[(o+180)*a,(90-h)*a]},o.wmt2mct=function(t,e,r){var a=1<<r,o=360/a,h=256*a,l=t*o-180;if(l=(l+180)/360*h,0==e)return[l,0];if(e+e==a)return[l,a<<8];var c=90-e*o;return[l,(i-Math.log(2/(1-Math.sin(c*s))-1))/n*h]},o.fixrlon=function(e){return(e%i+t)%i-t},o.fixrlat=function(i){return(i%t+e)%t-e},o.fixlon=function(t){return(t%360+180)%360-180},o.fixlat=function(t){return(t%180+90)%180-90},o.morton=function(t,e){for(var i=0,n=0;t||e;)i|=(1&t)<<n++,t>>=1,i|=(1&e)<<n++,e>>=1;return i},o.makekey=function(t,e,i){for(var n,s,r,a=0,o=0;t||e;)a|=(1&t)<<o++,t>>=1,a|=(1&e)<<o++,e>>=1,o>29&&(n=(n=a%32^i).toString(32),s=a.toString(32),a=o=0);return r=a?a.toString(32):"",null==n&&(n=(n=a%32^i).toString(32)),null==s&&(s=a?"":"0"),n+r+s};o.clamp=function(t,e,i){return t<e&&(t=e),t>=i&&(t=i-1),t},o.cloop=function(t,e){return t<0&&(t+=e),t>=e&&(t-=e),t},o.TK_EARTH_RADIUS=6378137,o.rightCoordinateSystem=function(t,e){t*=s,e*=s;var i=R*Math.cos(t)*Math.cos(e),n=R*Math.sin(t)*Math.cos(e);return[i,-(R*Math.sin(e)),n]},o.nor_points=function(t,i,n,r){if(i==r){if(t==n)return null;if(0==i)return[0,e]}t*=s,i*=s,n*=s,r*=s;var o=Math.tan(i),h=Math.tan(r);if(-a<o&&o<a&&-a<h&&h<a){var l=h*Math.sin(t)-o*Math.sin(n),c=Math.atan((o*Math.cos(n)-h*Math.cos(t))/l),u=0!=o?-Math.cos(t-c)/o:-Math.cos(n-c)/h;return[c,Math.atan(u)]}return o==h?null:-a<o&&o<a?[n+e,0]:-a<h&&h<a?[t+e,0]:null},o.dis_point_curveseg=function(t,i,n,s,r,a){var h=o.nor_points(n,s,r,a),l=o.arc_points(t,i,h[0],h[1]);return 6378137*Math.abs(l-e)},o.arc_points=function(e,i,n,r){var a=e*s,o=i*s,h=n*s,l=r*s,c=Math.cos(o)*Math.cos(l)*Math.cos(a-h)+Math.sin(o)*Math.sin(l);return c>1?0:c<-1?t:(c=Math.acos(c))<0?c+t:c},o.dis_points=function(t,e){return 6378137*o.arc_points(t.lon,t.lat,e.lon,e.lat)},o.rect_intersect=function(t,e){var i=[];return i[0]=t[0]>e[0]?t[0]:e[0],i[1]=t[1]<e[1]?t[1]:e[1],i[2]=t[2]>e[2]?t[2]:e[2],i[3]=t[3]<e[3]?t[3]:e[3],i},o.is_rect_in_rect=function(t,e){return t[0]>=e[0]&&t[1]<=e[1]&&t[2]>=e[2]&&t[3]<=e[3]},o.is_rect_away_rect=function(t,e){return t[0]>=e[1]||t[1]<=e[0]||t[2]>=e[3]||t[3]<=e[2]},o.rect_get_area=function(t){return(t[1]-t[0])*(t[3]-t[2])};var h=function(t,e){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)},l=function(t,e,i){var n=(i.x-e.x)*(t.x-e.x)+(i.y-e.y)*(t.y-e.y);if(n<=0)return h(e,t);var s=(i.x-e.x)*(i.x-e.x)+(i.y-e.y)*(i.y-e.y);if(n>=s)return h(i,t);var r=n/s,a=e.x+(i.x-e.x)*r,o=e.y+(i.y-e.y)*r;return Math.sqrt((a-t.x)*(a-t.x)+(o-t.y)*(o-t.y))},c=function(t,e,i,n){if(e.x==t.x&&e.y==t.y)return 1;if(i.x==t.x&&i.y==t.y)return 2;var s=l(t,e,i);return s>n?-1:0==s?3:0},u=function(t,e,i){for(var n=0,s=e.length-1;n<s;++n){var r=c(t,e[n],e[n+1],i);if(r>=0)return r}return-1},f=(o.point_in_line=function(t,e,i){for(var n=[],s=0,r=e.length;s<r;s+=2)n.push({x:e[s],y:e[s+1]});return u({x:t[0],y:t[1]},n,i)},function(t,e,i,n){return t*n-e*i}),d=function(t,e,i,n,s,r){var a,o,h,l,c;if(t[n].y>=t[s].y?(a=t[n].x,o=t[n].y,h=t[s].x,l=t[s].y):(a=t[s].x,o=t[s].y,h=t[n].x,l=t[n].y),i<l||o<i);else if(l<i&&i<o){if(h<e){if(a<e)r=!r;else if((c=f(e-h,i-l,a-e,o-i))>0)r=!r;else if(0==c)return 1}else if(a<=e)if((c=f(e-h,i-l,a-e,o-i))>0)r=!r;else if(0==c)return 1}else if(o==i)if(l==i){if(a<e&&e<h||h<e&&e<a)return 1;if(a==e||h==e)return 2}else{if(a==e)return 2;a<e&&(r=!r)}return[r]},m=function(t,e){var i,n=t.x,s=t.y,r=e.length,a=r-1,o=0;for(i=0;i<r;a=i++){var h=d(e,n,s,i,a,o);if(!(h instanceof Array))return h;o=h[0]}return o?0:-1};o.point_in_polygon=function(t,e){for(var i=[],n=0,s=e.length;n<s;n+=2)i.push({x:e[n],y:e[n+1]});return m({x:t[0],y:t[1]},i)};o.degreeToRad=function(t){return t*s},o.getDistance=function(t,e){return t instanceof p.Point&&e instanceof p.Point?o.dis_points(t,e):0},o.getPolygonArea=function(e){if(!(e instanceof p.Polygon||e instanceof Array))return 0;var i;if((i=e instanceof p.Polygon?e.lonlats:e).length<3)return 0;for(var n=0,r=0,a=0,o=0,h=0,l=0,c=0,u=0,f=0,d=0,m=0,v=0,g=0,y=0,w=0,x=0,_=0,M=0,k=0,b=0,C=0,T=0,P=0,A=0,L=0,S=0,z=0,D=0,I=0,B=0,O=0,E=0,R=i.length,F=0;F<R;F++)0==F?(n=i[R-1].lon*s,r=i[R-1].lat*s,a=i[0].lon*s,o=i[0].lat*s,h=i[1].lon*s,l=i[1].lat*s):F==R-1?(n=i[R-2].lon*s,r=i[R-2].lat*s,a=i[R-1].lon*s,o=i[R-1].lat*s,h=i[0].lon*s,l=i[0].lat*s):(n=i[F-1].lon*s,r=i[F-1].lat*s,a=i[F].lon*s,o=i[F].lat*s,h=i[F+1].lon*s,l=i[F+1].lat*s),c=Math.cos(o)*Math.cos(a),u=Math.cos(o)*Math.sin(a),f=Math.sin(o),d=Math.cos(r)*Math.cos(n),m=Math.cos(r)*Math.sin(n),v=Math.sin(r),z=((C=(_=(c*c+u*u+f*f)/(c*(g=Math.cos(l)*Math.cos(h))+u*(y=Math.cos(l)*Math.sin(h))+f*(w=Math.sin(l))))*g-c)*(M=(x=(c*c+u*u+f*f)/(c*d+u*m+f*v))*d-c)+(T=_*y-u)*(k=x*m-u)+(P=_*w-f)*(b=x*v-f))/(Math.sqrt(C*C+T*T+P*P)*Math.sqrt(M*M+k*k+b*b)),z=Math.acos(z),A=T*b-P*k,L=0-(C*b-P*M),S=C*k-T*M,(0!=c?A/c:0!=u?L/u:S/f)>0?(D+=z,O++):(I+=z,B++);var V,N;return V=D+(2*t*B-I),N=2*t*O-D+I,E=D>I?V-(R-2)*t<1?V:N:N-(R-2)*t<1?N:V,6378137*(E-(R-2)*t)*6378137}}(),function(){function e(t){this._owner=t,this._visible=!0;var e=$("<canvas>").addClass("tkm-map-canvas").css({"z-index":t.canvases.length})[0];this._zMarker=$("<div>"),t.mapsv.append(e,this._zMarker),this._zMarker=this._zMarker[0],this.canvas=e}function n(){t(this,e,arguments),this.context=this.canvas.getContext("2d")}function s(){t(this,e,arguments);var i=this.canvas.getContext("webgl");i?(this.gl=this.context=i,$(this.canvas).addClass("test-GL"),this.glInit()):alert("Unable to initialize WebGL. Your browser or machine may not support it.")}function r(){t(this,e,arguments),this.context=this.canvas.getContext("2d")}function a(){t(this,e,arguments),this.context=this.canvas.getContext("2d"),u(this,this._owner.mapMode,l)}function o(){t(this,e,arguments),this.context=this.canvas.getContext("2d")}var h=p.Canvas={},l=8;e.prototype={_drawNew:function(){delete this.oldCanvas},_snapView:function(){},_drawSnap:function(){var t=this._owner,e=t.mapMode,i=23-e.z,n=1<<i;if(null==this.oldCanvas){var s=this.canvas;s&&(s.parentNode&&s.parentNode.removeChild(s),this.canvas=null),this.canvas=s.cloneNode(!0),t.mapsv[0].insertBefore(this.canvas,this._zMarker),this.context=this.canvas.getContext("2d"),this.oldCanvas=s}var r={x:e.mctX*n,y:e.mctY*n,z:e.z,s:(1<<e.z)*e.scale/e.ratio,scale:e.scale,rotate:e.rotate},a=t.originState,o=a.x-r.x,h=a.y-r.y;if(this.context.clearRect(0,0,e.width,e.height),a.z===r.z&&r.s==a.s)this.context.drawImage(this.oldCanvas,o>>i,h>>i);else{var l=r.s/a.s,c=(a.x-a.w/2/a.scale*e.ratio*(1<<23-a.z)-(r.x-e.width/2/r.scale*e.ratio*(1<<23-e.z)))/(1<<23-e.z),u=(a.y-a.h/2/a.scale*e.ratio*(1<<23-a.z)-(r.y-e.height/2/r.scale*e.ratio*(1<<23-e.z)))/(1<<23-e.z);this.context.drawImage(this.oldCanvas,c,u,e.width*l,e.height*l)}},___snapView:function(){var t=this.context,e=this._owner.mapMode,i=1<<23-e.z;this.originImage=t.getImageData(0,0,e.width,e.height),this.originState={x:e.mctX*i,y:e.mctY*i,z:e.z,s:(1<<e.z)*e.scale/e.ratio,scale:e.scale,rotate:e.rotate}},___drawSnap:function(){return},_stretch:function(t){for(var e,i=this._owner.mapMode,n=i.width,s=i.height,r=Math.ceil(t*n),a=Math.ceil(t*s),o=this.originImage.data,h=this.context.createImageData(r,a),l=4*n,c=4*r,u=1/t,f=0,d=0,m=0;f<a&&(e=0|m)<s;++f,d+=c,m+=u)for(var p,v=l*e,g=0,y=0;g<r&&(p=0|y)<n;++g,y+=u){var w=d+(g<<2),x=v+(p<<2);h.data[w]=o[x],h.data[w+1]=o[x+1],h.data[w+2]=o[x+2],h.data[w+3]=o[x+3]}return h},_stretchEx:function(t,e,i){var n=this._owner.mapMode,s=n.width,r=n.height,a=(Math.ceil(t*s),Math.ceil(t*r),this.originImage.data),o=this.context.createImageData(s,r),h=4*s,l=h,c=1/t;e*=-c;for(var u,f=0,d=0,m=i*=-c;f<r&&(u=0|m)<r;++f,d+=l,m+=c)if(!(u<0))for(var p,v=h*u,g=0,y=e;g<s&&(p=0|y)<s;++g,y+=c)if(!(p<0)){var w=d+(g<<2),x=v+(p<<2);o.data[w]=a[x],o.data[w+1]=a[x+1],o.data[w+2]=a[x+2],o.data[w+3]=a[x+3]}return o},clear:function(){var t=this.context,e=this.canvas;t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,e.width,e.height)},owner:function(){return this._owner},visible:function(){return this._visible},setVisible:function(t){t=!!t,this._visible!=t&&(this._visible=t,this.canvas.style.display=this._visible?"block":"none")},hide:function(){this.canvas.style.display="none",this._visible=!1},show:function(){this.canvas.style.display="block",this._visible=!0},toggle:function(){this._visible=!this._visible,this.canvas.style.display=this._visible?"block":"none"}},i(n,e,{_drawNew:function(){e.prototype._drawNew.apply(this),this.drawLayers()},drawLayers:function(){var t=this._owner,e=this.context,i=t.mapMode;e.clearRect(0,0,i.width,i.height),e.save();for(var n,s=0,r=t.layers.length;s<r;++s)(n=t.layers[s]).visible&&n._draw(i,e);e.restore()}}),h.MapCanvasBasic=n,i(s,e,{startDraw:function(){function t(){var i=e._owner.mapMode;e.glClear(i);for(var n=e._owner.layers,s=0,r=n.length;s<r;++s)n[s].visible&&n[s].drawTiles&&e.glDraw(n[s].drawTiles,i);for(var s=0,r=(n=e._owner.layers).length;s<r;++s)n[s].visible&&n[s].drawTiles&&e.glDrawLabel(n[s].drawTiles,i);e._owner.animation?e.renderTimer=requestAnimationFrame(t):(e.started=!1,cancelAnimationFrame(e.renderTimer))}if(!this.started){var e=this;e.started=!0,t()}},_drawNew:function(){this.startDraw()},_drawSnap:function(){this.startDraw()},_snapView:function(){}}),h.MapCanvasGL=s,i(r,e,{_drawNew:function(){e.prototype._drawNew.apply(this);var t=this._owner;t.overlays&&t.overlays.length?this.drawOverlay():this.needClear&&(this.needClear=!1,this.clearOverlay())},drawOverlay:function(){var t=this._owner,e=this.context,i=t.mapMode;e.clearRect(0,0,i.width,i.height),e.save(),i.initTransform(e,{z:i.z,tx:0,ty:0});for(var n,s=0,r=t.overlays.length;s<r;++s)null!=(n=t.overlays[s]).draw&&(e.save(),n.draw(e,i.z),e.restore()),this.needClear=!0;e.restore()},clearOverlay:function(){var t=this.context,e=this._owner.mapMode;t.clearRect(0,0,e.width,e.height)}}),h.MapCanvasOverlay=r,i(a,e,{_drawNew:function(){e.prototype._drawNew.apply(this),this.labels=this.shiori(this.context)},highlightPOILabel:function(t){if(this.labels){var e=this._owner.mapMode,i=this.labels.grid.pointed(t),n=this.poiLabel,s=this.context;s.save(),s.lineCap=s.lineJoin="round",s.miterLimit=2,s.textBaseline="middle",s.setTransform(e.ratio,0,0,e.ratio,0,0),i?i.label&&i.label!=n&&(this.poiLabel=i.label,this.poiLabel.draw(),n&&n.draw()):(this.poiLabel=null,n&&n.draw()),s.restore()}}}),h.MapCanvasLabel=a,i(o,e,{_drawNew:function(){e.prototype._drawNew.apply(this)},_snapView:function(){this.stutter&&this.stutter(),e.prototype._snapView.apply(this)},clear:function(){var t=this._owner.mapMode;this.context.setTransform(1,0,0,1,0,0),this.context.clearRect(0,0,t.width,t.height)},setAnimation:function(t,e,i){this.clearAnimation(),e._owner=this._owner._map,v.private.kanimate(this,t,e,i)},clearAnimation:function(t){this.stop&&this.stop(t),this.uninstall&&this.uninstall()},addFrameCallback:function(t){if(t){if(null==this._animeCursorCB)this._animeCursorCB=[],this._animeCursorCB.top=0;else for(var e=0,i=this._animeCursorCB.length;e<i;++e)if(this._animeCursorCB[e].f==t)return this._animeCursorCB[e].id;return this._animeCursorCB.push({id:++this._animeCursorCB.top,f:t}),this._animeCursorCB.top}return null},removeFrameCallback:function(t){if(t&&this._animeCursorCB)for(var e=0,i=this._animeCursorCB.length;e<i;++e)if(this._animeCursorCB[e].id==t){this._animeCursorCB.splice(e,1);break}},_notifyFrameCallback:function(t){if(this._animeCursorCB)for(var e=0,i=this._animeCursorCB.length;e<i;++e)this._animeCursorCB[e].f(t)}}),h.MapCanvasDynamic=o,i(function(){t(this,e,arguments)},e,{_drawNew:function(){},_snapView:function(){},_drawSnap:function(){}})}(),function(){function e(){this.name=arguments[0]||"unknown",this.model=null,this.dataComplete=!0,this.shouldDraw=new Set,this.lonlatBox=[71,128,3,54],this.bboxDict={},this.visible=!0,this.minZ=4,this.maxZ=19,this.transparent=!1}function n(){t(this,e,arguments),this.filters=new Set,this.bolds={},v.private.egaki(this,l),this.hasLabel=!0,this.showLabel=!0,this.drawTiles=[],this.mapPackage="horae",this.styleViewName="",this.viewId=0}function s(){t(this,e,arguments)}function r(){t(this,s,arguments),this.urlPattern=null}function a(){t(this,s,arguments),this.urlPattern=null}var o=v,h=p.Layer={},l=256,c=p.GeoUtils,u=c.ll2mct,f=(c.mct2ll,c.t2ll),d=c.wmt2mct,m=c.mct2wmt,f=(c.morton,c.t2ll),g=c.clamp,y=c.cloop,w=c.makekey;c.rect_intersect;e.prototype={_draw:function(t){},_seek:function(t,e,i,n){},_transrange:function(t,e){var i=1<<e;return[t[0]>>8,t[1]+256>>8,g(t[2]>>8,0,i),g(t[3]+256>>8,0,i)]},_request:function(){},_send:function(){},_bbox:function(t){var e=this.bboxDict[t];if(e)return e;var i,n;return t>7?(i=u(this.lonlatBox[0],this.lonlatBox[2],t),n=u(this.lonlatBox[1],this.lonlatBox[3],t)):(i=u(71,3,t),n=u(128,54,t)),e=[i[0],n[0],n[1],i[1]],e=this._transrange(e,t),this.bboxDict[t]=e,e},_tilegen:function(t,e,i){},keygen:w,setVisible:function(t){this.visible=t},glMatrix:function(t,e){if(t.z==e.z)return[[256*(e.tx-t.tileX)-t.deltaX,256*(t.tileY-e.ty-1)+t.deltaY,0]];var i=t.z-e.z,n=(e.tx<<i)-t.tileX,s=t.tileY-(e.ty+1<<i);return[[256*n-t.deltaX,256*s+t.deltaY,0],[Math.pow(2,i),Math.pow(2,i),1]]}},h.LayerVector=n,i(n,e,{_draw:function(t,e){null!=this.boldGeo?this.boldGeos=o.styler.filtBoldFeature(this,this.drawTiles):this.boldGeos=null,this.vectorDraw(e,t,this.drawTiles)},_request:function(t){o.dataPool.setRequestTiles(t)},_seekOtherLevel:function(t,e,i,n,s,r){for(var a,h,l=t>>1,c=e>>1,u=i-1;u>=this.minZ;l>>=1,c>>=1,--u){if(!n.has(h=this.keygen(l,c,u))&&null!=(a=o.dataPool.get(h,r)))return s.push(a),void n.add(h);if(this.transparent)return}},_seek:function(t,e,i,n){var s,r,a,h,l,c=[],u=new Set,f=1<<e,d=t[0],m=t[1],p=t[2],v=t[3],g=new Set;for(s=d;s<=m;++s)for(l=y(s,f),r=p;r<=v;++r)h=this._tilegen(l,r,e),g.add(h.key),(a=o.dataPool.get(h.key,n))?(c.push(a),u.add(a.key)):(i.push(h),this._seekOtherLevel(l,r,e,u,c,n));if(i.length>0){var w=d+m>>1,x=p+v>>1;i=i.sort(function(t,e){return Math.abs(e.tx-w)+Math.abs(e.ty-x)-Math.abs(t.tx-w)-Math.abs(t.ty-x)}),this.dataComplete=!1}else this.dataComplete=!0;n||(this.drawTiles=c.sort(function(t,e){return t.z-e.z}),this.shouldDraw=g)},_tilegen:function(t,e,i){var n={tx:t,ty:e,z:i,okey:w(t,e,i),layer:this};return n.key=n.okey+"z"+this.viewId,n},keygen:function(t,e,i){return w(t,e,i)+"z"+this.viewId},_updateStyleTiles:function(){var t="z"+this.viewId,e=this;o.dataPool.updateTiles(function(i){if(i.key&&i.key.endsWith(t)){var n=o.dataPool.scache.get(i.okey);if(null!=n)return o.styler._styling(n,e,i.z)}return null})},toggleFilter:function(t){var e=this,i=function(t){e.filters.has(t)?e.filters.delete(t):e.filters.add(t)};if(t instanceof Array)for(var n in t)i(t[n]);else i(t);this._updateStyleTiles()},checkFilter:function(t){return this.filters.has(t)},boldFeature:function(t){var e=this,i=function(t){e.bolds[t]?delete e.bolds[t]:e.bolds[t]={f:"red"}};if(t instanceof Array)for(var n in t)i(t[n]);else i(t);this._updateStyleTiles()},checkBoldFeature:function(t){return this.bolds[t]},customStyle:function(t,e){var i=o.styler.getRenderConfig(this.mapPackage);i.duplicateView(this.styleViewName,this.styleViewName+"-origin"),i.setStyle({view:this.styleViewName,offset:e.offset||"fillColor",value:e.value,typeCode:t}),this._updateStyleTiles()},clearCustomStyle:function(){var t=o.styler.getRenderConfig(this.mapPackage);null!=t.views[this.styleViewName+"-origin"]&&(t.deleteView(this.styleViewName),t.duplicateView(this.styleViewName+"-origin",this.styleViewName),this._updateStyleTiles())},styleViewNames:function(){var t=[];for(var e in o.styler.mapRenderConfig[this.mapPackage].views)t.push(e);return e},setStyleView:function(t){var e=o.styler.mapRenderConfig[this.mapPackage].views[t];null!=e&&(this.styleViewName=t,this.viewId=e.index)}}),i(s,e,{_request:function(t){o.dataPool.setRequestTiles(t)},_send:function(t){t.img.crossOrigin="anonymous",t.img.src=this.getTileURL(t)},getTileURL:function(t){return""},_tilegen:function(t,e,i){return{tx:t,ty:e,z:i,key:w(t,e,i)+"z"+this.name,img:!1,layer:this}},keygen:function(t,e,i){return w(t,e,i)+"z"+this.name}}),h.LayerRaster=s,h.LayerWMTS=r,i(r,s,{_draw:function(t,e){for(var i=0,n=this.drawTiles.length;i<n;++i)this._rasterDraw(e,t,this.drawTiles[i])},getTileURL:function(t){return this.urlPattern.replace("%{svr}",t.svr).replace("%{z}",t.z).replace("%{x}",t.tx).replace("%{y}",t.ty)},_transrange:function(t,e){var i=1<<e,n=m(t[0],t[2],e),s=m(t[1],t[3],e);return[Math.floor(n[0]),Math.ceil(s[0]),g(Math.floor(n[1]),0,i),g(Math.ceil(s[1]),0,i)]},_seekOtherLevel:n.prototype._seekOtherLevel,_seek:function(t,e,i,n){var s,r,a,h,l,c=new Set,u=[],f=1<<e,d=t[0],m=t[1],p=t[2],v=t[3],g=new Set;for(s=d;s<=m;++s)for(l=y(s,f),r=p;r<=v;++r)h=this._tilegen(l,r,e),a=o.dataPool.get(h.key),g.add(h.key),a?(u.push(a),c.add(a.key)):(i.push(h),this._seekOtherLevel(l,r,e,c,u));if(i.length>0){var w=d+m>>1,x=p+v>>1;i=i.sort(function(t,e){return Math.abs(e.tx-w)+Math.abs(e.ty-x)-Math.abs(t.tx-w)-Math.abs(t.ty-x)})}n||(this.drawTiles=u.sort(function(t,e){return t.z-e.z}),this.shouldDraw=g)},_rasterDraw:function(t,e,i){if(i.img){t.save();var n=e.initTransformR(t,i);i.img.crossOrigin="anonymous",t.drawImage(i.img,e.deltaX,e.deltaY,l,n),t.restore()}},glMatrix:function(t,e){var i=t.z-e.z,n=d(e.tx,e.ty,e.z),s=d(e.tx+1,e.ty+1,e.z);n[0]<<=i,n[1]<<=i,s[0]<<=i,s[1]<<=i;var r=n[0]-t.mctX,a=t.mctY-s[1],o=s[1]-n[1],h=t.mctUpper/2;if(r>h)for(;r>h;)r-=t.mctUpper;else if(r<-h)for(;r<-h;)r+=t.mctUpper;return[[r,a,0],[Math.pow(2,i),o/256,1]]}}),i(a,s,{_getTileURL:function(t){var e=f(t.tx,t.ty,t.z),i=f(t.tx+1,t.ty+1,t.z);return this.urlPattern.replace("%{svr}",t.svr).replace("%{lon}",e[0]).replace("%{LON}",i[0]).replace("%{lat}",i[1]).replace("%{LAT}",e[1])},_draw:function(t,e){for(var i=0,n=this.drawTiles.length;i<n;++i)this._rasterDraw(e,t,this.drawTiles[i])},_seekOtherLevel:n.prototype._seekOtherLevel,_seek:n.prototype._seek,_rasterDraw:function(t,e,i){i.img&&(t.save(),e.initTransform(t,i),i.img.crossOrigin="Anonymous",t.drawImage(i.img,0,0,l,l),t.restore())}}),h.LayerWMS=a}(),o.prototype.owner=null,o.prototype.task=null,o.prototype.rate=100,o.prototype.length=1/0,o.prototype.SESSION=-1,o.prototype.INDEX=0,o.prototype.PAUSED=!0,o.prototype.BACKW=!0,o.forceCall=function(t){return t.INDEX+=t.BACKW?-1:1,!1!==t.task.call(t.owner,t.INDEX,t.length,t.BACKW)&&!t.isAtEnd()||(t.pause(),!1)},o.prototype.isAtEnd=function(){return this.BACKW?isFinite(this.length)&&this.INDEX<1:this.INDEX+1>this.length},o.prototype.synchronize=function(){this.PAUSED||(clearInterval(this.SESSION),this.SESSION=setInterval(o.forceCall,this.rate,this))},o.prototype.pause=function(){clearInterval(this.SESSION),this.PAUSED=!0},o.prototype.start=function(t){var e=Boolean(t);(this.BACKW!==e||!this.isAtEnd()&&this.PAUSED)&&(this.BACKW=e,this.PAUSED=!1,this.synchronize())},function(){function t(t,e,i){var n=t.createShader(e);return t.shaderSource(n,i),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)?n:(alert("An error occurred compiling the shaders: "+t.getShaderInfoLog(n)),t.deleteShader(n),null)}function e(e,i,n){var s=t(e,e.VERTEX_SHADER,i),r=t(e,e.FRAGMENT_SHADER,n),a=e.createProgram();return e.attachShader(a,s),e.attachShader(a,r),e.linkProgram(a),e.getProgramParameter(a,e.LINK_STATUS)?a:(alert("Unable to initialize the shader program: "+e.getProgramInfoLog(a)),null)}function i(t){var e=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,e);t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,256,0,256,256,0,256]),t.STATIC_DRAW);var i=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,s,t.STATIC_DRAW),{position:e,textureCoord:i}}function n(t,e,i){var n=t.x/e,s=1-t.y/i,r=(t.x+t.w)/e,a=1-(t.y+t.h)/i;return new Float32Array([n,a,r,a,r,s,n,s])}var s=new Float32Array([0,0,1,0,1,1,0,1]);p.Canvas.MapCanvasGL.prototype.glInit=function(){var t=this.gl;if(null==t||null!=this.glShaderInfo)return null;var n=e(t,"\nattribute vec4 aVertexPosition;\nattribute vec2 aTextureCoord;\n\nuniform mat4 uComponentOffsetMatrix;\nuniform mat4 uTileOffsetMatrix;\nuniform mat4 uModelViewMatrix;\nuniform mat4 uProjectionMatrix;\n\nvarying highp vec2 vTextureCoord;\n\nvoid main(void) {\n\tgl_Position = uProjectionMatrix * uModelViewMatrix * uTileOffsetMatrix * uComponentOffsetMatrix * aVertexPosition;//\n\tvTextureCoord = aTextureCoord;\n}\n","\nvarying highp vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\n\nvoid main(void) {\n\tgl_FragColor = texture2D(uSampler, vTextureCoord);\n}\n");if(null==n)return null;var s=i(t);this.glShaderInfo={program:n,attribLocations:{vertexPosition:t.getAttribLocation(n,"aVertexPosition"),textureCoord:t.getAttribLocation(n,"aTextureCoord")},uniformLocations:{projectionMatrix:t.getUniformLocation(n,"uProjectionMatrix"),modelViewMatrix:t.getUniformLocation(n,"uModelViewMatrix"),tileMatrix:t.getUniformLocation(n,"uTileOffsetMatrix"),componentMatrix:t.getUniformLocation(n,"uComponentOffsetMatrix"),uSampler:t.getUniformLocation(n,"uSampler")},buffers:s},this._cur=0},p.Canvas.MapCanvasGL.prototype.glGenTextureCoord=function(t,e,i){var n=this.gl,s=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,s);var r=t.x/e,a=t.y/i,o=(t.x+t.w)/e,h=(t.y+t.h)/i,l=[r,a,o,a,o,h,r,h];return n.bufferData(n.ARRAY_BUFFER,new Float32Array(l),n.STATIC_DRAW),s},p.Canvas.MapCanvasGL.prototype.glGenTexture=function(t,e){var i=this.gl;return e=i.createTexture(),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),i.bindTexture(i.TEXTURE_2D,e),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),e.gl=i,e},p.Canvas.MapCanvasGL.prototype.glClear=function(t){var e=this.gl,i=this.glShaderInfo;e.clearColor(0,0,0,0),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.viewport(0,0,e.canvas.width,e.canvas.height),e.useProgram(i.program),e.bindBuffer(e.ARRAY_BUFFER,i.buffers.position),e.vertexAttribPointer(i.attribLocations.vertexPosition,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(i.attribLocations.vertexPosition),e.bindBuffer(e.ARRAY_BUFFER,i.buffers.textureCoord),e.bufferData(e.ARRAY_BUFFER,s,e.STATIC_DRAW),e.vertexAttribPointer(i.attribLocations.textureCoord,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(i.attribLocations.textureCoord),e.uniform1i(i.uniformLocations.uSampler,0);var n=60*Math.PI/180,r=e.canvas.clientWidth/e.canvas.clientHeight,a=t.halfWidth/t.ratio,o=t.halfHeight/t.ratio,h=mat4.create(),l=mat4.create();e.uniformMatrix4fv(i.uniformLocations.componentMatrix,!1,l),mat4.perspective(h,n,r,1024,2048),h[0]=1500/a,h[5]=1500/o,e.uniformMatrix4fv(i.uniformLocations.projectionMatrix,!1,h),mat4.scale(l,l,[t.scale/t.ratio,t.scale/t.ratio,1]),mat4.translate(l,l,[0,0,-1500]),0!=t.tilt&&mat4.rotate(l,l,t.tilt,[1,0,0]),0!=t.rotate&&mat4.rotate(l,l,-t.rotate,[0,0,1]),e.uniformMatrix4fv(i.uniformLocations.modelViewMatrix,!1,l),e.activeTexture(e.TEXTURE0)},p.Canvas.MapCanvasGL.prototype.glDraw=function(t,e){for(var i,n=this.gl,s=this.glShaderInfo,r=0,a=t.length;r<a;++r)if(null!=(i=t[r]).tex){n.bindTexture(n.TEXTURE_2D,i.tex);var o=mat4.create(),h=i.layer.glMatrix(e,i);mat4.translate(o,o,h[0]),h[1]&&mat4.scale(o,o,h[1]),n.uniformMatrix4fv(s.uniformLocations.tileMatrix,!1,o),n.drawArrays(n.TRIANGLE_FAN,0,4)}},p.Canvas.MapCanvasGL.prototype.glDrawLabel=function(t,e){for(var i,s=this.gl,r=this.glShaderInfo,a=e.ratio/e.scale,o=0,h=t.length;o<h;++o)if((i=t[o]).l&&i.z==e.z){var l=mat4.create(),c=i.layer.glMatrix(e,i)[0];mat4.translate(l,l,c),s.uniformMatrix4fv(r.uniformLocations.tileMatrix,!1,l);for(var u,f=[0,0,0],d=0,m=i.l.length;d<m;++d){if(null!=(u=i.l[d]).imgInfo&&null!=u.img){s.bufferData(s.ARRAY_BUFFER,n(u.imgInfo,u.img.width,u.img.height),s.STATIC_DRAW),s.bindTexture(s.TEXTURE_2D,u.tex);var p=mat4.create();f[0]=u.a[0]-u.imgInfo.w/4,f[1]=256-u.a[1]-u.imgInfo.h/4,mat4.translate(p,p,f),0!=e.tilt&&mat4.rotate(p,p,-e.tilt,[1,0,0]),0!=e.rotate&&mat4.rotate(p,p,e.rotate,[0,0,1]),mat4.scale(p,p,[u.imgInfo.w*a/512,u.imgInfo.h*a/512,1]),s.uniformMatrix4fv(r.uniformLocations.componentMatrix,!1,p),s.drawArrays(s.TRIANGLE_FAN,0,4)}if(u.rect){s.bufferData(s.ARRAY_BUFFER,n(u.rect,512,512),s.STATIC_DRAW),s.bindTexture(s.TEXTURE_2D,i.ltex);var v=mat4.create();f[0]=u.a[0]+26,f[1]=256-u.a[1],mat4.translate(v,v,f),0!=e.tilt&&mat4.rotate(v,v,-e.tilt,[1,0,0]),0!=e.rotate&&mat4.rotate(v,v,e.rotate,[0,0,1]),mat4.scale(v,v,[u.rect.w*a/512,u.rect.h*a/512,1]),s.uniformMatrix4fv(r.uniformLocations.componentMatrix,!1,v),s.drawArrays(s.TRIANGLE_FAN,0,4)}}}}}(),function(){function t(t){this.mapRenderConfig={},this.maplist=["horae"],this.engine=t;var e=document.createElement("canvas");document.body.appendChild(e),e.className="tkm-map-mem-canvas",e.width=512,e.height=512,this.memcanvas=e,this.memcontext=e.getContext("2d"),this.memcontext.textBaseline="top",this.needMakeTexture="webgl"===v.displayTechVersion,this.needMakeTexture&&v.private.egaki(this);for(var i in this.maplist)this.fillConfig(this.maplist[i])}function e(t,e){var i=t.boldGeo;return i==e?1:i[o]==e[o]&&i.k==e.k&&(e[s]&&i[s]==e[s]||!e[s]&&i[a]==e[a])?1:0}function i(t,e,i,n,a,o,h){var l=n.v[e];if(null!=l){var c=o.renders[l.r];if(null!=c&&i==c.t&&(this.subtype=h,this.lv=a.z,this.cid=a.c,this.name=t[s],this.extend(c.style),this.override(c.overrides),this.extend(n.d),this.override(n.o),this.extend(l.defaults),this.override(l.overrides),this.m<=this.lv&&this.lv<=this.M)){if(delete this.m,delete this.M,"0"==i){if(this.t=0,this.r=this.name,this.i>=0)this.imgInfo=o.iconConfig[this.i],this.img=o.iconConfig.img,this.tex=o.iconConfig.tex;else if(!this.r)return}else if("2"==i)this.t=2;else if("1"==i)this.t=1;else{if("3"!=i)return;this.t=3}delete this.name,this.a=t[r],this.a.geo=t}}}function n(t,e){this.mapPack=e,this.views=t.vs,this.renders=t.rs,this.outlineConfig=t.oc,this.regionConfig=t.rc,this.iconConfig=t.ic,this._viewsPrepare(),this._rendersPrepare(),this._regionConfigPrepare(),this._outlineConfigPrepare(),this._iconConfigPrepare()}var s=3,r=2,a=1,o=0,h={Points:"a",Type:"t",Text:"r",fillColor:"f",strokeColor:"s",lineDash:"d",lineWidth:"l",strokeWidth:"w",iconId:"i",iconStyle:"j",fontSize:"n",font:"o",pattern:"p",zIndex:"z"},l=p.Styler={};t.prototype={_styling:function(t,e,n){if(null!=t&&null!=t.d){var s,r,a,h=t.d,l=e.styleViewName,c=e.mapPackage,u=this.mapRenderConfig[c],f=n>=8?u.regionConfig:u.outlineConfig,d=[],m=[],p=u.views[l],v={key:e.keygen(t.tx,t.ty,n),okey:t.key,c:t.c,m:t.m,v:l,z:t.z,tx:t.tx,ty:t.ty,g:d,l:m};if(p.f&&(v.f=p.f),p.s&&(v.s=p.s),!h._prestyle){for(r in h)for(var g=0,y=(b=h[r]).length;g<y;++g)b[g].k=r;h._prestyle=1}for(var w in h){var x,_,M=w.split("x");if(x=M[1],_=M[2],""==x&&(x="0"),""==_?_=0:(_=parseInt(_,32))>127&&(_-=256),!e.checkFilter(x)){s=e.bolds[x];var k,b=h[w],C=f[x];if(null!=C)for(var T,g=0,y=b.length;g<y;++g)if(T=b[g],null!=(k=C[T[o]]))for(var P in k){var A=new i(T,l,P,a=k[P],t,u,_);null!=A.a&&(s&&$.extend(A,s),A.t?d.push(A):m.push(A))}}}if(m.length&&(v.l=m.sort(function(t,e){return t.z-e.z})),d.length){d=d.sort(i.comparator);for(var L,S,z={},D=new Set,I=d[0],B=1,O=d.length;B<=O;++B)S=d[B],I.absorb(S)||(null==(L=z[I.z])&&(z[I.z]=L=[],D.add(I.z)),L.push(I),delete I._absorbed,I=S);v.g=z,v.zIndexKeys=D}return v.layer=e,this.needMakeTexture&&this._texturize(v,e),v}},_texturize:function(t,e){var i=this.memcontext;i.clearRect(0,0,256,256),this.vectorDraw(i,{ratio:2,scale:2,width:512,height:512,z:t.z},t),t.tex=this.glCanvas.glGenTexture(this.memcanvas),i.clearRect(0,0,256,256),this._makeLabelImage(t,e),t.ltex=this.glCanvas.glGenTexture(this.memcanvas)},_makeLabelImage:function(t,e){var i,n,s,r,a,o,h=this.memcontext,l=0,c=0,u=0;h.textBaseline="top",h.lineCap=h.lineJoin="round",h.miterLimit=4;for(var f,d=0,m=t.l,p=m.length;d<p;++d)if((f=m[d]).r){if(h.font=(f.n||"10")+"px",h.lineWidth=i=2*(0|(f.w||1)),h.strokeStyle=f.s||"#fff",h.fillStyle=f.f||"#000",1==f.j&&f.imgInfo){if(n=2*(h.measureText(f.r).width+8),s=2*(f.n+8),u<s&&(u=s),r=l+n,c+s,r>512){if(c+=u,c+s>512)return;u=s,l=0,r=n}a=l/2,o=c/2;var v=f.imgInfo;h.drawImage(f.img,v.x,v.y,v.w,v.h,a,o,n/2,s/2),a+=4,o+=4,i>0&&h.strokeText(f.r,a,o),h.fillText(f.r,a,o),f.glElems=[]}else{if(n=2*h.measureText(f.r).width+2*i,s=2*f.n+4*i,u<s&&(u=s),r=l+n,c+s,r>512){if(c+=u,c+s>512)return;u=s,l=0,r=n}a=(l+i)/2,o=(c+i)/2,i>0&&h.strokeText(f.r,a,o),h.fillText(f.r,a,o),f.img?f.glElems=[{rect:f.imgInfo,tex:f.tex,iw:f.img.width,ih:f.img.height,pos:[f.a[0]-f.imgInfo.w/4,256-f.a[1]-f.imgInfo.h/4,0]}]:f.glElems=[]}f.rect={x:l,y:c,w:n,h:s},f.glElems.push({rect:f.rect,iw:512,ih:512,pos:[f.a[0],256-f.a[1],0]}),l=r}},getRenderConfig:function(t){return this.mapRenderConfig[t]},filtBoldFeature:function(t,i){for(var n=null,s=0,r=i.length;s<r;++s){var a,o,h=i[s];if(null!=h.g)for(var l in h.g)for(var c=0,u=(a=h.g[l]).length;c<u;++c)for(var f,d=0,m=(o=a[c]).a.length;d<m;++d)e(t,(f=o.a[d]).geo)&&(null==n&&(n=[],$.extend(n,o),delete n.a,delete n.z,n.f="red"),n.push([h,f]))}return n},fillConfig:function(t){var e=this.mapRenderConfig,i=this.engine,s=this;$.ajax({type:"POST",url:p.domain+"/perseus/webmap",timeout:p.timeout,data:"at=es&key="+t,dataType:"json",success:function(r,a,o){for(var h,l,c=e[t]=new n(r,t),u=0,f=i.mapViews.length;u<f;++u)(h=(l=i.mapViews[u]).basicLayer).mapPackage==t&&h.setStyleView(c.defaultView),s.glCanvas=i.getGLCanvas(),l.mapMode.listenerNotify("ready")},complete:function(t,e){"success"!=e&&console.log("render_config failed")}})}},l.tkStyler=t,i.comparator=function(t,e){return t.z-e.z},i.prototype={hash:function(){return null==this.hashValue&&(this.hashValue=this.f+","+this.s+","+this.l+","+this.w+","+this.d+","+this.p),this.hashValue},extend:function(t){if(null!=t)for(var e,i="Mmfslwijnozdrp",n=0,s=i.length;n<s;++n)null!=t[e=i.substr(n,1)]&&(this[e]=t[e])},override:function(t){if(null!=t)for(var e,i,n=0,s=t.length;n<s;++n){e=t[n],i=!0;for(var r in e.cond)if(e.cond[r]!=this[r]){i=!1;break}if(i){for(var a in e.value)this[a]=e.value[a];break}}},absorb:function(t){if(null==this._absorbed){if(3==this.t){e=this.a.geo;this.a.forEach(function(t){t.geo=e}),delete this.a.geo}else this.a=[this.a];this._absorbed=!0}if(t&&this.equal(t)){if(3==this.t){var e=t.a.geo;this.a=t.a.reduce(function(t,i){return t.push(i),i.geo=e,t},this.a)}else this.a.push(t.a);return!0}return!1},equal:function(t){return this.t==t.t&&this.f==t.f&&this.s==t.s&&this.l==t.l&&this.w==t.w&&this.i==t.i&&this.j==t.j&&this.n==t.n&&this.o==t.o&&this.d==t.d&&this.p==t.p},depoly:function(){}},n._duplicateView=function(t,e,i){n._foreachView(t,e,function(t){t[i]={},$.extend(t[i],t[e]);for(var n in t[i])if(t[i][n]instanceof Object){var s={};$.extend(s,t[i][n]),t[i][n]=s}return!1})},n._deleteView=function(t,e){n._foreachView(t,e,function(t){return delete t[e],!1})},n._foreachView=function(t,e,i){var n,s,r,a,o,h;for(n in t){a=t[n];for(s in a){o=a[s];for(r in o)if((h=o[r])&&h.v&&null!=h.v[e]&&i(h.v))return}}},n._setStyle=function(t,e,i){if(null!=(t=t[e]))for(var n in t){var s=t[n];for(var r in s){var a=s[r].v[i.view];a&&(null==a.defaults&&(a.defaults={}),a.defaults[h[i.offset]]=i.value)}}},n.prototype={setStyle:function(t){if(null!=t)if(t instanceof Array)for(var e in t)this.setStyle(t[e]);else{var i;if(null==(i=t.outline?this.outlineConfig:this.regionConfig))return;var s=t.typeCode;if(s instanceof Array)for(var r in s)n._setStyle(i,s[r],t);else n._setStyle(i,s,t)}},duplicateView:function(t,e){var i=this.views[t],s=this.views[e];null!=i&&null==s&&(this.views[e]=s={},$.extend(s,i),n._duplicateView(this.regionConfig,t,e),n._duplicateView(this.outlineConfig,t,e))},deleteView:function(t){null!=this.views[t]&&(delete this.views[t],n._deleteView(this.regionConfig,t),n._deleteView(this.outlineConfig,t))},_viewsPrepare:function(){var t,e,i,n=0;for(t in this.views)null==i&&(i=t),(e=this.views[t]).data&&delete e.data,e.index=n++;this.defaultView=i},_rendersPrepare:function(){var t,e;for(var i in this.renders)t=this.renders[i],e=this._overrideMake(t[2]),this.renders[i]={t:t[0],style:t[1]},e&&(this.renders[i].overrides=e)},_overrideMake:function(t){if(t instanceof Array)for(var e,i=0,n=t.length;i<n;++i)e=t[i],t[i]={cond:e[0],value:e[1]};return t},_regionConfigPrepare:function(){this._datasetConfigPrepare(this.regionConfig)},_outlineConfigPrepare:function(){this._datasetConfigPrepare(this.outlineConfig)},_iconConfigPrepare:function(){var t,e,i,n,s,r={};t=this.iconConfig[3],s=r;for(e in t)6==(i=t[e]).length?s[e]={x:i[0],y:i[1],w:i[2],h:i[3],iw:i[4],ih:i[5],t:0}:s[e]={x:i[0],y:i[1],w:i[2],h:i[3],t:9};var a=v.getGLCanvas();s.img=n=new Image,n.father=s,n.crossOrigin="anonymous",n.onload=function(){var t=this.father;for(var e in t)t[e].img=this;delete this.father,null!=a&&(t.tex=a.glGenTexture(n))},n.src=p.domain+"/perseus/webres?rs=icon&key="+this.mapPack+"@3",this.iconConfig=r},_datasetConfigPrepare:function(t){var e,i,n,s,r,a,o,h,l,c;for(e in t){i=t[e],r={};for(n in i){for(a={},h=0,l=(s=i[n]).length;h<l;++h){o={},(c=s[h])[1]&&(o.d=c[1]),c[2]&&(o.o=c[2]),c[3]&&(o.v=c[3]);for(var u in o.v)o.v[u].override&&(o.v[u].overrides=this._overrideMake(o.v[u].override),delete o.v[u].override);a[c[0]]=o}r[n]=a}$.extend(i,r)}}}}(),function(){function t(e){if(!v._initialized){v._initialized=!0,$.extend(v,t.prototype),e=e||{},v.bbox=e.bbox,v.pullEngineConfig(),v.mapViews=[],v.ratio=2,v.dataPool=new u,v.styler=new p.Styler.tkStyler(v),v.displayTechVersion="canvas";var i=v.bbox;v.layerMgr={horae:n(p.Layer.LayerVector,function(t){t.name="horae",t.lonlatBox=i}),satellite:n(p.Layer.LayerWMTS,function(t){t.name="satellite",t.lonlatBox=i,t.urlPattern=p.domain+"/perseus/cors?url=http://t%{svr}.tianditu.cn/img_c/wmts?service=wmts&style=default&format=tiles&request=GetTile&version=1.0.0&LAYER=img&tileMatrixSet=c&TileMatrix=%{z}&TileRow=%{y}&TileCol=%{x}",t.visible=!1})},e.layerFactories&&$.extend(v.layerMgr,e.layerFactories);var s=document.createElement("pre");s.id="tkm-text-ruler",document.body.appendChild(s)}}function i(t){if($.extend(this,t),this.mode=0,this.container==document.body&&(this.fullScreen=!0),this.fullScreen)this.width=window.innerWidth,this.height=window.innerHeight;else{var e=$(this.container);this.width=$(e).width(),this.height=$(e).height()}if(d(this),this.mapMode=new h(this.width,this.height,v.ratio),this.mapMode.view=this,this.mapMode._listenerTargetGetter=function(t){return t.view._map},t.center)this.mapMode.lon=t.center.lon,this.mapMode.lat=t.center.lat;else if(v.cityConfig){var i=v.cityConfig.city[1];i&&(this.mapMode.lon=i.lon,this.mapMode.lat=i.lat,this.mapMode.z=i.zoom)}var n,r=this;this.layers=(this.layers||["satellite","horae"]).map(function(t){var e=v.layerMgr[t]();return e._owner=r,e});var a=this.basicLayer=this.getLayer("horae");this.imageLayer=this.getLayer("satellite");var l=v.styler.mapRenderConfig[a.mapPackage];l&&a.setStyleView(t.defaultView||l.defaultView),this.overlays=[],this.markers=[];var c="<div>",u=$(c).addClass("tkm-map-mainview");this.mapsv=u,this.container.appendChild(u[0]);var f=$(c).addClass("tkm-map-domtag-container");if(this.domsv=f,this.mapsv.append(f),this.canvases=[],"canvas"===v.displayTechVersion?this.canvases.push(new p.Canvas.MapCanvasBasic(this)):this.canvases.push(new p.Canvas.MapCanvasGL(this)),this.noDynamicShow||(this.dynamicCanvas=new p.Canvas.MapCanvasDynamic(this),this.canvases.push(this.dynamicCanvas),this.dynamicCanvas.hide(),this.mapMode.addListener(function(t){r.dynamicCanvas.stutter&&r.dynamicCanvas.stutter()},["move","zoom","rotate"]),this.mapMode.addListener(function(t){r.dynamicCanvas.checkStutter&&r.dynamicCanvas.checkStutter()},["moveend","zoomend","rotateend"])),this.labelCanvas=new p.Canvas.MapCanvasLabel(this),this.canvases.push(this.labelCanvas),this.overlayCanvas=new p.Canvas.MapCanvasOverlay(this),this.canvases.push(this.overlayCanvas),this.annotationCanvas=new p.Canvas.MapCanvasOverlay(this),this.canvases.push(this.annotationCanvas),this.annotationCanvas.hide(),this.resizeCanvases(),!this.noZoomButtons){var y=$(c).addClass("tkm-button-zooms");u.append(y),y.append($(c).addClass("tkm-button-zoomin").click(function(){r.zoomIn()}),$(c).addClass("tkm-button-zoomout").click(function(){r.zoomOut()}))}n=$(c).addClass("tkm-locmark"),u.append(n),this.locationMark=n[0],n=$(c).addClass("tkm-button-locate").click(function(t){r.moveToLocation()}),u.append(n),n=$(c).addClass("tkm-button-compass").click(function(){r.rotateNorth()}),u.append(n),this.compassView=n[0],this.mapMode.addListener(function(){var t=r.mapMode;r.compassView.style.visibility=0==t.rotate?"hidden":"visible",r.compassView.style.transform="rotate("+t.rotate*S+"deg)"},"rotate"),this._scrollWheelZooming=!0;this.mapMode;n=$(c).addClass("tkm-logo"),u.append(n),n=$(c).addClass("tkm-scale").append($("<center>").append(this.scaleText=$(c).addClass("tkm-scale-text")),$(c).addClass("tkm-scale-line")),u.append(n),this.scaleView=n[0],this.scaleText=this.scaleText[0],m(u,this),g(u,this),x(this),v.mapViews.push(this),this.mapMode.fixToLonlat(),this.mapMode.listenerNotify("init"),this.queryDatasource(),this.lastDrawTick=0,this.daemon=new o(this,this.dataDaemon,100),this.daemon.start(!0),this.benchmark=new s,this.fitContainerSize(),"webgl"===v.displayTechVersion?this.canvases[0].startDraw():(this.rotateLock=!0,this.tiltLock=!0),this._queryDataIndex=0}function h(t,e,i){this.z=14,this.maxZ=18,this.minZ=4,this.lat=39.904156,this.lon=116.39777,this.locateLon=116.30542,this.locateLat=40.052443,this.scale=i,this.ratio=i,this.x=0,this.y=0,this.mctX=0,this.mctY=0,this.tileX=0,this.tileY=0,this.deltaX=0,this.deltaY=0,this.rotate=0,this.tilt=0,this.cos0=1,this.sin0=0,this.bbox=null,this.projection="Mercator",this.mctUpper=1<<this.z+8,this.width=t*i,this.height=e*i,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.radius=Math.sqrt(this.width*this.width+this.height*this.height)/2;var n=this;this.addListener(function(){n._moving=!1},"moveend"),this.addListener(function(){n._zooming=!1},"zoomend"),this.addListener(function(){n._rotating=!1},"rotateend")}function l(){for(var t=v.mapViews,e=t.length-1;e>=0;--e)t[e].refreshMap()}function u(){this.cache=new c(900),this.scache=new c(900),this.cache.delFunc=function(t){t&&t.tex&&t.tex.gl&&(t.tex.gl.deleteTexture(t.tex),delete t.tex)},f(this,l)}function d(t){var e=function(){t.fitContainerSize()};window.addEventListener("resize",function(){t.resizeTimeout||(t.resizeTimeout=setTimeout(function(){t.resizeTimeout=null,e()},66))})}function m(t,e){var i={touching:!1,ox:0,oy:0,nx:0,ny:0,lx:0,ly:0},n=null;t.on("touchstart",function(){i.lx=event.targetTouches[0].pageX,i.ly=event.targetTouches[0].pageY,i.nx=i.lx,i.ny=i.ly,event.targetTouches>1&&(i.num=2),e.onDrawFrame(0),n=setInterval(function(){i.button&&(e.onDrawFrame(),e.onDrawFrame(0))},250)}),t.on("touchmove",function(){event.preventDefault(),i.nx=event.targetTouches[0].pageX,i.ny=event.targetTouches[0].pageY,e.mapMode.moveDelta(i.nx-i.lx,i.ny-i.ly),e.onDrawFrame(1),i.lx=i.nx,i.ly=i.ny}),t.on("touchend",function(){clearInterval(n)})}function g(t,e){var i={x:0,y:0,lx:0,ly:0,tick:0,button:0,dragMove:!1},n=null;t.mousedown(function(t){"canvas"==t.target.tagName.toLowerCase()&&(i.x=i.lx=t.offsetX,i.y=i.ly=t.offsetY,i.button=1,i.tick=Date.now(),e.onDrawFrame(0),e.daemon.pause(),e.geoPicker?e.geoPicker.mousedown_proc&&e.geoPicker.mousedown_proc(i):n=setInterval(function(){i.button&&(e.onDrawFrame(),e.onDrawFrame(0))},250))});var s;t.mouseup(s=function(t){var s=Date.now()-i.tick;if(i.button=0,i.tick=0,e.dragging=!1,e.daemon.start(!0),clearInterval(n),n=null,e.geoPicker){if(e.geoPicker.mouseup_proc&&e.geoPicker.mouseup_proc(i),e.geoPicker&&e.geoPicker.click_proc&&s<=400&&"canvas"==t.target.tagName.toLowerCase()){r=e.mapMode.lonlatAtPoint(i.x,i.y);e.geoPicker.click_proc(r)}}else{if(s<=400&&"canvas"==t.target.tagName.toLowerCase()){var r=e.mapMode.lonlatAtPoint(i.x,i.y);e.onClick(r)}i.dragMove&&(i.dragMove=!1,e.mapMode.listenerNotify("moveend")),e.onDrawFrame()}}),t.mouseout(function(t){"tkm-map-"!=!t.target.class&&null==e.geoPicker&&(i.button=0,e.dragging=!1,e.onDrawFrame())}),t.mousemove(function(t){i.lx=i.x,i.ly=i.y,i.x=t.offsetX,i.y=t.offsetY,e.geoPicker?e.geoPicker.mousemove_proc&&e.geoPicker.mousemove_proc(i):t.buttons?i.button&&(e.mapMode.moveDelta(i.x-i.lx,i.y-i.ly),e.dragging=!0,e.onDrawFrame(1),i.dragMove=!0):(i.button&&s(t),e.labelCanvas.highlightPOILabel(i))});var r={delay:0,handle:null,delta:0,type:null},a=function(t){if("tkm-map-"==t.target.className.substr(0,8)){var i=Date.now(),n=t||window.event,s=n.wheelDelta||-150*n.detail;r.delta+=s,n.ctrlKey&&(n.returnValue=!1),null==r.handle?(n.altKey&&e._scrollWheelZooming?r.type="rotate":n.shiftKey&&!n.altKey&&e._scrollWheelZooming?r.type="tilt":n.altKey||n.shiftKey||!e._scrollWheelZooming||(r.type="zoom"),r.type&&(e.daemon.pause(),e.lastDrawTick=0,e.onDrawFrame(),e.onDrawFrame(0))):clearTimeout(r.handle),r.handle=setTimeout(o,200);var a=F.edge?8:1;if(i-r.delay>e.benchmark.average*a&&(r.delay=i,r.delta)){var h=r.delta>0?1:-1;r.delta=h*Math.log(h*r.delta)/10,"rotate"==r.type?e.mapMode.rotateDelta(r.delta):"zoom"==r.type?e.mapMode.zoomDelta(r.delta/2,w(n,e.mapsv[0])):"tilt"==r.type&&e.mapMode.tiltDelta(r.delta/2),r.type&&(e.onDrawFrame(1),e.queryDatasource()),r.delta=0}}},o=function(){r.handle=null,e.daemon.start(!0),r.delta=0,e.onDrawFrame(),e.onDrawFrame(0),r.type&&(e.mapMode.listenerNotify(r.type+"end"),r.type=null)};document.addEventListener&&document.addEventListener("DOMMouseScroll",a,!1),window.onmousewheel=document.onmousewheel=a}function y(t){for(var e={x:t.offsetLeft,y:t.offsetTop},i=t.offsetParent;i!=document.body&&i;)e.x+=i.offsetLeft,e.y+=i.offsetTop,i=i.offsetParent;return e}function w(t,e){for(var i={x:t.pageX,y:t.pageY},n=e.offsetLeft,s=e.offsetTop,r=e.offsetParent;r!=document.body&&r;)n+=r.offsetLeft,s+=r.offsetTop,r=r.offsetParent;return i.x-=n,i.y-=s,i}function x(t){if(navigator.geolocation){navigator.geolocation.watchPosition(function(e){t.locationMark.style.display="block",t.mapMode.locateLat=e.coords.latitude,t.mapMode.locateLon=e.coords.longitude},function(e){t.locationMark.style.display="none"})}}function _(t){var e=Math.floor(t),i=e+"°",n=60*(t-e);return e=Math.floor(n),n-=e,i+=e+"'",i+=Math.floor(600*n)/10+'"'}function M(t){return t>=1e6?(t/1e6).toFixed(2)+"平方千米":t.toFixed(2)+"平方米"}function k(t){return t>=1e3?(t/1e3).toFixed(2)+"千米":t.toFixed(2)+"米"}function b(t,e,i){this.points=[],this.Map=t,this.type=i,this.view=e,null==i&&(i="free"),this.mousedown_proc=b["mdp_"+i],this.mousemove_proc=b["mmp_"+i],this.mouseup_proc=b["mup_"+i],this.exit_proc=b["ep_"+i],this.rate=this.view.mapMode.ratio,this.view.annotationCanvas.context.setTransform(this.rate,0,0,this.rate,0,0),this.view.annotationCanvas.show()}var C=[2e7,1e7,5e6,2e6,1e6,5e5,2e5,1e5,5e4,25e3,1e4,5e3,2e3,1e3,500,200,100,50,25,10,5,2.5],T=C.map(function(t){return t>=1e3?t/1e3+"千米":t+"米"}),P=Math.PI,A=(Math.PI,2*Math.PI),L=(Math.PI,P/180),S=180/P,z=Math.log(2),D=6378137*A,I=p.GeoUtils,B=I.ll2mct,O=I.mct2ll,E=I.wmt2mct,R=I.rect_intersect,F=new a,V=F.microsoft?2:5;t.prototype={pullEngineConfig:function(){var t=$.ajax({type:"POST",url:p.domain+"/perseus/webmap",timeout:p.timeout,data:"at=cz",async:!1,dataType:"json"}).responseJSON;if(t&&(null==this.bbox&&(this.bbox=t.bbox),t.city)){var e=t.city,i={},n={count:0};for(var s in e)e[s].length>2&&(i[s]={name:e[s][0],parent:e[s][1],lon:e[s][2],lat:e[s][3],zoom:e[s][4]},null==n[i[s].parent]&&(n.count++,n[i[s].parent]=s));this.cityConfig={city:i,province:n}}},getGLContext:function(){return this.mapViews&&this.mapViews[0]&&this.mapViews[0].canvases&&this.mapViews[0].canvases[0]?this.mapViews[0].canvases[0].gl:null},getGLCanvas:function(){return"webgl"===this.displayTechVersion&&this.mapViews&&this.mapViews[0]&&this.mapViews[0].canvases?this.mapViews[0].canvases[0]:null}},i.prototype={dataDaemon:function(){this.queryDatasource()},onDrawFrame:function(t){this.benchmark.begin();var e=Date.now();if(void 0===t){if(e-this.lastDrawTick>2*this.benchmark.average){var i=1<<23-(n=this.mapMode).z;this.originState={x:n.mctX*i,y:n.mctY*i,z:n.z,s:(1<<n.z)*n.scale/n.ratio,w:n.width,h:n.height,scale:n.scale,rotate:n.rotate},this.canvasesForEach("_drawNew"),this.lastDrawTick=e}}else{if(0==t)return void this.canvasesForEach("_snapView");1==t&&this.canvasesForEach("_drawSnap")}var n=this.mapMode,s=n.pointAtLonlat(n.locateLon,n.locateLat);this.locationMark.style.left=s[0]-8+"px",this.locationMark.style.top=s[1]-8+"px",this.scaleView.style.width=n.lengthInScreen(C[n.z])+"px",this.scaleText.innerHTML=T[n.z],this.debugInfo&&(this.debugInfo.innerHTML=n.lon+","+n.lat+"<br>"+_(n.lon)+","+_(n.lat)+"@ "+n.z+"<br>"+n.mctX+","+n.mctY+"<br>"+s[0]+","+s[1]),this.benchmark.end()},onClick:function(t){if(this.funcClickPoint&&this.funcClickPoint(t),this.clickProcs&&this.clickProcs.length)for(var e=new p.Point(t),i=0,n=this.clickProcs.length;i<n;++i)this.clickProcs[i](e)},toggleMeasureMode:function(t){var e=1==t?p.Map.func_press_for_measure:p.Map.func_press_for_measure_area;this.funcClickPoint&&this.funcClickPoint(null),this.mode==t?(this.mode=0,this.funcClickPoint=null):(this.mode=t,this.funcClickPoint=e)},togglePickPin:function(){this.funcClickPoint&&this.funcClickPoint(null),3==this.mode?(this.mode=0,this.funcClickPoint=null):(this.mode=3,this.funcClickPoint=p.Map.func_press_for_pin_mark)},toggleQueryMode:function(){this.funcClickPoint&&this.funcClickPoint(null),4==this.mode?(this.mode=0,this.mapsv.css({cursor:"-webkit-grab"}),this.funcClickPoint=null):(this.mode=4,this.mapsv.css({cursor:"help"}),this.funcClickPoint=p.Map.func_press_for_query)},canvasesForEach:function(t){for(var e=0,i=this.canvases.length;e<i;++e){var n=this.canvases[e];n.visible()&&n[t]()}},refreshMap:function(){this.animation||(this.queryDatasource(),this.lastDrawTick=0,this.onDrawFrame())},refreshMapForTiles:function(t){if(!this.animation){this.queryDatasource();for(var e=0,i=t.length;e<i;++e);}},queryDatasource:function(){var t=this.mapMode.bboxRange(),e=this.mapMode.z,i=!0;++this._queryDataIndex;for(var n=0,s=this.layers.length;n<s;++n){o=[];if(((h=this.layers[n]).visible||h==this.basicLayer)&&h.minZ<=e&&e<=h.maxZ){var r=h._transrange(t,e),a=h._bbox(e);r=R(r,a);h._seek(r,e,o,!1);o.length>0&&(o.needDraw=!0,i=!1,o.queryIndex=this._queryDataIndex,h._request(o))}}if(i){this.mapMode.listenerNotify("tileready");var o=[],h=this.basicLayer,l=t[1]-t[0],c=t[3]-t[2];t[0]-=l,t[1]+=l,t[2]-=c,t[3]+=c;var r=h._transrange(t,e),a=h._bbox(e);r=R(r,a),h._seek(r,e,o,!0),e>this.mapMode.minZ&&(--e,l/=2,c/=2,t[0]-=l,t[1]+=l,t[2]-=c,t[3]+=c,t[0]>>=1,t[1]>>=1,t[2]>>=1,t[3]>>=1,r=h._transrange(t,e),a=h._bbox(e),r=R(r,a),h._seek(r,e,o,!0)),o.length>0&&h._request(o)}},zoomIn:function(){var t=this;this.startAnimation(function(){t.mapMode.zoomDelta(.2)},function(){t.mapMode.listenerNotify("zoomend")})},zoomOut:function(){var t=this;this.startAnimation(function(){t.mapMode.zoomDelta(-.2)},function(){t.mapMode.listenerNotify("zoomend")})},moveToLocation:function(){if(void 0==this.mapMode.locateLon)alert("暂未获得定位信息");else{var t=this;this.startAnimation(function(){var e=t.mapMode,i=e.pointAtLonlat(e.locateLon,e.locateLat),n=t.width/2-i[0],s=t.height/2-i[1];e.moveDelta(n/2,s/2)},function(){var e=t.mapMode,i=e.pointAtLonlat(e.locateLon,e.locateLat),n=t.width/2-i[0],s=t.height/2-i[1];e.moveDelta(n,s),t.mapMode.listenerNotify("moveend")})}},rotateNorth:function(){var t=this;this.startAnimation(function(){var e=P>t.mapMode.rotate?0:P;t.mapMode.rotateDelta(e-t.mapMode.rotate/2),t.mapMode.tilt&&t.mapMode.tiltDelta(-t.mapMode.tilt/2)},function(){t.mapMode.rotateDelta(-t.mapMode.rotate),t.mapMode.tilt&&t.mapMode.tiltDelta(-t.mapMode.tilt)})},startAnimation:function(t,e){if(!this.animation){var i=this;this.onDrawFrame(0),this.animationCnt=V,this.animation=setInterval(function(){var n=i;--n.animationCnt?(t(),n.onDrawFrame(1)):(t(),e&&e(),clearInterval(n.animation),n.animation=null,n.onDrawFrame())},66)}},featureAtPoint:function(t){var e,i,n,s,r=t.x,a=t.y,o=this.mapMode.z;r=(t=this.mapMode.mercatorAtPoint(r,a))[0]>>8,a=t[1]>>8,n=t[0]%256,s=t[1]%256;for(var h,l=this.layers.length-1;l>=0;--l)if((h=this.layers[l])instanceof p.Layer.LayerVector){if(h.boldGeo=null,e=h.keygen(r,a,o),null==(i=v.dataPool.get(e))||null==i.zIndexKeys)continue;for(var c=Array.from(i.zIndexKeys).sort(function(t,e){return e-t}),u=0,f=c.length;u<f;++u)for(var d,m=i.g[c[u]],g=0,y=m.length;g<y;++g){var w,x=(d=m[g]).l+2*d.w;if(1==d.t)w=I.point_in_line;else{if(2!=d.t)continue;w=I.point_in_polygon}for(var _=0,M=d.a.length;_<M;++_)if(w([n,s],d.a[_],x)>=0)return h.boldGeo=d.a[_].geo,d.a[_].geo}}},clearBoldFeature:function(){for(var t,e=this.layers.length-1;e>=0;--e)(t=this.layers[e])instanceof p.Layer.LayerVector&&(t.boldGeo=null)},resizeCanvases:function(){for(var t=0,e=this.canvases.length;t<e;++t)!function(t,e){e.width=t.width,e.height=t.height,e.style.width=t.width/t.ratio+"px",e.style.height=t.height/t.ratio+"px"}(this.mapMode,this.canvases[t].canvas)},getBounds:function(){var t=this.mapMode.bboxRange();return[O(t[0],t[3],this.mapMode.z),O(t[1],t[2],this.mapMode.z)]},pointAtLonlat:function(t,e){return this.mapMode.pointAtLonlat(t,e)},resize:function(t,e){var i=this.mapMode;this.width=t,this.height=e;var n=i.mercatorAtPoint(t/2,e/2);i.mctX=n[0],i.mctY=n[1],i.width=t*i.ratio,i.height=e*i.ratio,i.halfWidth=i.width/2,i.halfHeight=i.height/2,i.radius=Math.sqrt(i.width*i.width+i.height*i.height)/2,i.fixToMercator(),i.listenerNotify("resize"),this.mapsv.css({width:t+"px",height:e+"px"}),this.resizeCanvases(),this.queryDatasource(),this.refreshMap();var s=this.getBodyOffset();this.windowBounds=[s.x,s.x+t,s.y,s.y+e]},fitContainerSize:function(){if(this.fullScreen)this.resize(window.innerWidth,window.innerHeight);else{var t=$(this.container);this.resize(t.width(),t.height())}},viewStyleChange:function(t){this.basicLayer.styleViewName!=t&&(this.imageLayer.setVisible("satellite"==t),this.basicLayer.setVisible(!0),this.basicLayer.setStyleView(t),this.queryDatasource(),this.onDrawFrame())},getLayer:function(t){for(var e=null,i=0,n=this.layers.length;i<n&&(e=this.layers[i]).name!=t;++i);return e},getBodyOffset:function(){return y(this.mapsv[0])}},h.prototype={initTransform:function(t,e){var i,n,s,r=this.x,a=this.y,o=e.z-this.z;0==o?(n=e.tx-this.tileX,s=e.ty-this.tileY,i=this.scale):o<0?(n=(e.tx<<1)-this.tileX,s=(e.ty<<1)-this.tileY,i=2*this.scale):o>0&&(n=(e.tx>>1)-this.tileX,s=(e.ty>>1)-this.tileY,i=this.scale),(n||s)&&(n=(n<<8)*this.scale,s=(s<<8)*this.scale,r+=n*this.cos0-s*this.sin0,a+=n*this.sin0+s*this.cos0),t.setTransform(1,0,0,1,0,0),t.translate(r,a),t.scale(i,i),t.rotate(this.rotate),t.lineCap=t.lineJoin="round",t.miterLimit=2},initTransformR:function(t,e){var i=this.x,n=this.y,s=(e.z,this.z,E(e.tx,e.ty,e.z)),r=E(e.tx+1,e.ty+1,e.z),a=s[0]-this.mctX,o=s[1]-this.mctY,h=r[1]-s[1],l=this.mctUpper/2;a>l?a-=this.mctUpper:a<-l&&(a+=this.mctUpper);var c=this.scale;return a*=this.scale,o*=this.scale,i+=a*this.cos0-o*this.sin0,n+=a*this.sin0+o*this.cos0,t.setTransform(1,0,0,1,0,0),t.translate(i,n),t.rotate(this.rotate),t.scale(c,c),h},setPoint:function(t,e,i){this.lon=t,this.lat=e,this.z=null!=i?i:this.z,this.fixToLonlat(),this.listenerNotify("move"),this.listenerNotify("moveend")},identiteContext:function(t){t.setTransform(this.ratio,0,0,this.ratio,0,0)},fixToMercator:function(t){var e=O(this.mctX,this.mctY,this.z);this.lon=e[0],this.lat=e[1],this.deltaX=this.mctX%256,this.deltaY=this.mctY%256;var i=this.mctX>>8,n=this.mctY>>8;(i!=this.tileX||n!=this.tileY||t)&&(this.tileX=i,this.tileY=n,this.fixXY())},fixToLonlat:function(){var t=B(this.lon,this.lat,this.z);this.mctX=t[0],this.mctY=t[1],this.tileX=this.mctX>>8,this.tileY=this.mctY>>8,this.deltaX=this.mctX%256,this.deltaY=this.mctY%256,this.mctUpper=1<<this.z+8,this.fixXY()},fixXY:function(){0==this.rotate?(this.x=this.halfWidth-this.deltaX*this.scale,this.y=this.halfHeight-this.deltaY*this.scale):(this.x=this.halfWidth-this.deltaX*this.scale*this.cos0+this.deltaY*this.scale*this.sin0,this.y=this.halfHeight-this.deltaX*this.scale*this.sin0-this.deltaY*this.scale*this.cos0)},calcRange:function(){var t=this.width/this.ratio,e=this.height/this.ratio,i=t/e,n=1/this.scale;if(i>2||i<.5)if(0==this.rotate)t=this.halfWidth*n,e=this.halfHeight*n;else{var s=Math.abs((this.sin0/this.cos0*t+e)*this.cos0)/2,r=Math.abs((this.cos0/this.sin0*t-e)*this.sin0)/2,a=Math.abs((this.sin0/this.cos0*t-e)*this.cos0)/2,o=Math.abs((this.cos0/this.sin0*t+e)*this.sin0)/2;t=r>o?r:o,e=s>a?s:a}else t=e=this.radius*n;return[this.mctX-t,this.mctX+t,this.mctY-e,this.mctY+e]},calcSize:function(){var t=this.width/this.ratio,e=this.height/this.ratio,i=t/e,n=1/this.scale;if(0==this.rotate)t=this.halfWidth*n,e=this.halfHeight*n;else if(i>2||i<.5){var s=Math.abs((this.sin0/this.cos0*t+e)*this.cos0)/2,r=Math.abs((this.cos0/this.sin0*t-e)*this.sin0)/2,a=Math.abs((this.sin0/this.cos0*t-e)*this.cos0)/2,o=Math.abs((this.cos0/this.sin0*t+e)*this.sin0)/2;t=r>o?r:o,e=s>a?s:a}else t=e=this.radius*n;return[t,e]},bboxRange:function(){var t,e,i=1/this.scale;if(0==this.rotate)t=this.halfWidth*i,e=this.halfHeight*i;else{t=this.width*i,e=this.height*i;var n=Math.abs((this.sin0/this.cos0*t+e)*this.cos0)/2,s=Math.abs((this.cos0/this.sin0*t-e)*this.sin0)/2,r=Math.abs((this.sin0/this.cos0*t-e)*this.cos0)/2,a=Math.abs((this.cos0/this.sin0*t+e)*this.sin0)/2;t=s>a?s:a,e=n>r?n:r}return[this.mctX-t,this.mctX+t,this.mctY-e,this.mctY+e]},pointAtLonlat:function(t,e){var i=B(t,e,this.z),n=this.mctUpper>>1,s=i[0]-this.mctX,r=i[1]-this.mctY;return s>n?s-=this.mctUpper:s<-n&&(s+=this.mctUpper),0==this.rotate?[(this.halfWidth+this.scale*s)/this.ratio,(this.halfHeight+this.scale*r)/this.ratio]:[(this.halfWidth+this.scale*s*this.cos0-this.scale*r*this.sin0)/this.ratio,(this.halfHeight+this.scale*s*this.sin0+this.scale*r*this.cos0)/this.ratio]},pixelAtLonlat:function(t,e){var i=B(t,e,this.z),n=this.mctUpper>>1,s=i[0]-this.mctX,r=i[1]-this.mctY;return s>n?s-=this.mctUpper:s<-n&&(s+=this.mctUpper),0==this.rotate?{x:this.halfWidth+this.scale*s,y:this.halfHeight+this.scale*r}:{x:this.halfWidth+this.scale*s*this.cos0-this.scale*r*this.sin0,y:this.halfHeight+this.scale*s*this.sin0+this.scale*r*this.cos0}},lonlatAtPoint:function(t,e){var i=this.mercatorAtPoint(t,e);return O(i[0],i[1],this.z)},mercatorAtPoint:function(t,e){var i=(t*this.ratio-this.halfWidth)/this.scale,n=(e*this.ratio-this.halfHeight)/this.scale;if(0!=this.rotate){var s=Math.sqrt(i*i+n*n),r=Math.atan2(n,i);i=Math.sin(this.rotate-r)*s,n=Math.cos(this.rotate-r)*s}return[i+this.mctX,n+this.mctY]},moveDelta:function(t,e){if(!this.view.moveLock){t*=this.ratio,e*=this.ratio;var i=this.mctUpper,n=1/this.scale;if(this.bbox&&this.bbox[this.z]){var s=this.bbox[this.z],r=this.calcSize();r[0]/=2,r[1]/=2;var a=t*n,o=e*n,h=[this.mctX-r[0],this.mctX+r[0],this.mctY-r[1],this.mctY+r[1]],l=[h[0]-a,h[1]-a,h[2]-o,h[3]-o];if(l=I.rect_intersect(l,s),h=I.rect_intersect(h,s),I.rect_get_area(h)>I.rect_get_area(l))return}this.x+=t,this.y+=e,t*=n,e*=n,this.rotate?(this.mctX-=t*this.cos0+e*this.sin0,this.mctY+=t*this.sin0-e*this.cos0):(this.mctX-=t,this.mctY-=e),this.mctX>i?this.mctX-=i:this.mctX<0&&(this.mctX+=i),this.fixToMercator(),this.view.queryDatasource(),this._moving||(this.listenerNotify("movebegin"),this._moving=!0),this.listenerNotify("move")}},zoomDelta:function(t,e){if(!this.view.zoomLock&&0!=t){var i=this.scale*Math.pow(2,t),n=this.z+t;if(n>=this.maxZ&&(i=Math.pow(2,this.maxZ-this.z)*this.ratio),n<=this.minZ&&(i=Math.pow(2,this.minZ-this.z)*this.ratio),i!=this.scale){var s=this.scale,r=i/this.ratio;if(this.scale=i,e){var a,o,h=1/s-1/this.scale,l=e.x*this.ratio-this.halfWidth,c=e.y*this.ratio-this.halfHeight;this.rotate?(a=(l*this.cos0+c*this.sin0)*h,o=(-l*this.sin0+c*this.cos0)*h):(a=l*h,o=c*h),this.mctX+=a,this.mctY+=o}for(;r>=1.5;)this.mctUpper<<=1,this.scale/=2,this.mctX*=2,this.mctY*=2,++this.z,r/=2;for(;r<.75;)this.mctUpper>>=1,this.scale*=2,this.mctX/=2,this.mctY/=2,--this.z,r*=2;this.fixToMercator(!0),this.view.queryDatasource(),this._zooming||(this.listenerNotify("zoombegin"),this._zooming=!0),this.listenerNotify("zoom")}}},rotateDelta:function(t){if(!this.view.rotateLock&&0!=t){var e=this.halfWidth,i=this.halfHeight,n=e-this.x,s=i-this.y,r=Math.cos(t),a=Math.sin(t);this.rotate+=t,this.rotate>A?this.rotate-=A:this.rotate<0&&(this.rotate+=A),-.01<=this.rotate&&this.rotate<=.01?(t-=this.rotate,this.rotate=this.sin0=0,this.cos0=1,r=Math.cos(t),a=Math.sin(t)):(this.cos0=Math.cos(this.rotate),this.sin0=Math.sin(this.rotate)),this.x=e-n*r+s*a,this.y=i-n*a-s*r,this.view.queryDatasource(),this._rotating||(this.listenerNotify("rotatebegin"),this._rotating=!0),this.listenerNotify("rotate")}},tiltDelta:function(t){if(!this.view.tiltLock){var e=this.tilt+t;e>=-.01&&(e=0),e<-P/4&&(e=-P/4),this.tilt=e,this.fixToMercator(),this.view.queryDatasource(),this._tilting||(this.listenerNotify("tiltbegin"),this._tilting=!0),this.listenerNotify("tilt")}},lengthInScreen:function(t){return t/this.ratio*this.scale/(D/(1<<this.z+8)*Math.cos(this.lat*L))},setViewport:function(t,e,i,n){var s=B(t,i,23),r=B(e,n,23),a=Math.log((r[0]-s[0])*this.ratio/(this.width-20))/z,o=Math.log((s[1]-r[1])*this.ratio/(this.height-20))/z,h=23-(a>o?a:o);h<this.minZ?h=this.minZ:h>this.maxZ&&(h=this.maxZ),this.lon=(t+e)/2,this.lat=(i+n)/2,this.z=Math.round(h),this.fixToLonlat(),this.zoomDelta(this.z-h),this.listenerNotify("moveend"),this.listenerNotify("zoomend")},setZoom:function(t){if(t|=0,this.z!=t&&this.minZ<=t&&t<=this.maxZ){var e=O(this.mctX,this.mctY,this.z);this.lon=e[0],this.lat=e[1],this.z=t,this.fixToLonlat(),this.listenerNotify("zoomend")}},setZoomUpper:function(t){t<this.z&&this.setZoom(t),this.maxZ=t},setZoomLower:function(t){t>this.z&&this.setZoom(t),this.minZ=t},setBorderBounds:function(t){this.bounds=t,this.bbox=[];for(var e,i,n=0;n<20;++n)e=B(t.ne.lon,t.ne.lat,n),i=B(t.sw.lon,t.sw.lat,n),this.bbox.push([i[0],e[0],e[1],i[1]])}},e(h,r),u.prototype={get:function(t,e){return this.cache.get(t,e)},setObject:function(t){null!=t.key&&this.scache.setObject(t)},setTile:function(t){null!=t.key&&this.cache.setObject(t)},setRequestTiles:function(t){for(var e=[],i=t[0].layer instanceof p.Layer.LayerVector?this.tssh.gMsg:this.tssh.grMsg,n=0,s=t[0];s;s=t[++n]){if(i.XHR&&s.okey){var r=this.scache.get(s.okey);if(null!=r){r=v.styler._styling(r,s.layer,s.z),this.setTile(r);continue}s.key=s.okey}e.push(s)}e.length>0?(e.needDraw=t.needDraw,e.queryIndex=t.queryIndex,i.setTaskQueue(e)):l()},clearTiles:function(t){t?this.cache.filtObjects(t):this.cache.clear()},updateTiles:function(t){this.cache.replaceObjects(t)}},b.prototype.exit=function(){return this.exit_proc()},b.mdp_free=function(t){this.points.push({x:t.x,y:t.y,headmark:1});var e=this.view.annotationCanvas.context;e.beginPath(),e.strokeStyle="red",e.lineWidth=4,e.moveTo(t.x,t.y)},b.mmp_free=function(t){if(t.button&&this.points.length>0){var e=this.points[this.points.length-1];if(t.x!=e.x||t.y!=e.y){this.points.push({x:t.x,y:t.y});var i=this.view.annotationCanvas.context;i.lineTo(t.x,t.y),i.stroke()}}},b.mup_free=function(t){},b.ep_free=function(){var t=null;if(this.points.length>0){var e=this.Map;t=new p.Polyline(this.points.map(function(t){var i=e.pixelToPoint(t);return $.extend(i,t),i}))}return t},b.mdp_circle=function(t){if(this.points.push({x:t.x,y:t.y,headmark:1}),null==this.result_circle){this.circle_mask=$("<div>").addClass("tkm-map-mask").css({"border-radius":"1px",left:t.x-1+"px",top:t.y-1+"px",width:"2px",height:"2px"}),this.view.mapsv.append(this.circle_mask)}},b.mmp_circle=function(t){if(t.button&&1==this.points.length){var e=this.points[0],i=t.x-e.x,n=t.y-e.y,s=Math.sqrt(i*i+n*n)-4|0;s<=0&&(s=2),this.circle_mask.css({"border-radius":s+"px",left:e.x-s+"px",top:e.y-s+"px",width:2*s+"px",height:2*s+"px"})}},b.mup_circle=function(t){if(1==this.points.length){this.points.push({x:t.x,y:t.y});var e,i,n=this.Map,s=n.pixelToPoint(this.points[0]);e=n.pixelToPoint(this.points[1]),i=s.distance(e),this.result_circle=new p.Circle(n.pixelToPoint(this.points[0]),i),this.autoExit&&this.autoExit(n)}},b.ep_circle=function(){var t=null;if(this.result_circle)t=this.result_circle;else if(this.points.length>0){var e,i,n=this.Map,s=n.pixelToPoint(this.points[0]);if(this.points.length>1)e=n.pixelToPoint(this.points[1]),i=s.distance(e);else{var r=this.points[0];e={x:r.x,y:r.y+5},i=s.distance(n.pixelToPoint(e))}t=new p.Circle(n.pixelToPoint(this.points[0]),i)}return this.circle_mask&&this.circle_mask.detach(),t},b.mdp_rectangle=function(t){this.points.push({x:t.x,y:t.y,headmark:1}),null==this.result_rectangle&&(this.rectangle_mask=$("<div>").addClass("tkm-map-mask").css({left:t.x+"px",top:t.y+"px",width:"2px",height:"2px"}),this.view.mapsv.append(this.rectangle_mask))},b.mmp_rectangle=function(t){if(t.button&&1==this.points.length){var e=this.points[0],i=t.x-e.x,n=t.y-e.y;this.rectangle_mask.css({left:(i>=0?e.x:e.x+i)+"px",top:(n>=0?e.y:e.y+n)+"px",width:Math.abs(i)+"px",height:Math.abs(n)+"px"})}},b.mup_rectangle=function(t){if(1==this.points.length){var e=[],i=this.Map,n={x:t.x,y:t.y};this.points.push(n),e.push(i.pixelToPoint(n)),n.y=this.points[0].y,e.push(i.pixelToPoint(n)),n.x=this.points[0].x,e.push(i.pixelToPoint(n)),n.y=t.y,e.push(i.pixelToPoint(n)),this.result_rectangle=new p.Polygon(e),this.autoExit&&this.autoExit(i)}},b.ep_rectangle=function(){var t=null;return this.result_rectangle?t=this.result_rectangle:this.points.length,this.rectangle_mask&&this.rectangle_mask.detach(),t},p.Map=function(e){v._initialized||t(e?e.engineOption:null),null!=e.container&&("string"==typeof e.container&&(e.container=document.getElementById(e.container)),this.view=new i(e),this.view._map=this)},p.Map.func_press_for_measure=function(t){if(null!=t){var e,i=this;null==this._messureOverlay&&(this._messureOverlay=new p.Polyline([]),this._messureOverlay._addToView(this),this.overlays.push(this._messureOverlay),this.measureTip=new p.InfoWindow,this.measureTip._addToView(this),this.measureTip.hide()),(e=i._messureOverlay).addPoint(t);var n=k(e.getLength());this.measureTip.text(n),null==this.mapPinArray&&(this.mapPinArray=[]);var s=new p.Marker(t);s.setImage("img/node.png"),s._addToView(this),s.click(function(e){i.measureTip.text(n),i.measureTip.setPoint(t),i.measureTip.update()}),this.mapPinArray.push(s),this.measureTip.show(),this.measureTip.setPoint(t),this.measureTip.update(),this.refreshMap()}else{if(this.measureTip&&(this.measureTip._removeFromView(),this.measureTip=null),this._messureOverlay){var r=this.overlays.indexOf(this._messureOverlay);this.overlays.splice(r,1),this._messureOverlay=null,this.refreshMap()}if(this.mapPinArray){for(var a=0,o=this.mapPinArray.length;a<o;++a)this.mapPinArray[a]._removeFromView(this);this.mapPinArray=null}}},p.Map.func_press_for_measure_area=function(t){if(null!=t){var e;null==this._messureOverlay&&(this._messureOverlay=new p.Polygon([]),this._messureOverlay._addToView(this),this.overlays.push(this._messureOverlay),this.measureTip=new p.InfoWindow,this.measureTip._addToView(this),this.measureTip.hide()),(e=this._messureOverlay).addPoint(t);var i=p.GeoUtils.getPolygonArea(e);this.measureTip.text(M(i)),this.measureTip.show(),this.measureTip.setPoint(t),this.measureTip.update(),this.refreshMap()}else{if(this.measureTip&&(this.measureTip._removeFromView(),this.measureTip=null),this._messureOverlay){var n=this.overlays.indexOf(this._messureOverlay);this.overlays.splice(n,1),this._messureOverlay=null,this.refreshMap()}if(this.mapPinArray){for(var s=0,r=this.mapPinArray.length;s<r;++s)this.mapPinArray[s]._removeFromView(this);this.mapPinArray=null}}},p.Map.func_press_for_pin_mark=function(t){if(null!=t){null==this.mapPinArray&&(this.mapPinArray=[]);var e=new p.Bubble(t);e._addToView(this),this.mapPinArray.push(e);var i=this.mapPinArray.length;e.click(function(){alert(i)}),e.setStyle(i%6)}else{if(this.mapPinArray)for(var n=0,s=this.mapPinArray.length;n<s;++n)this.mapPinArray[n]._removeFromView(this);this.mapPinArray=null}},p.Map.func_press_for_query=function(t){if(null==t)return this.clearBoldFeature(),void(this.featureTip&&(this.featureTip._removeFromView(),this.featureTip=null,this.refreshMap()));var e=this.mapMode.pixelAtLonlat(t[0],t[1]);e.x/=this.mapMode.ratio,e.y/=this.mapMode.ratio;var i=this.featureAtPoint(e);if(this.featureTip&&this.featureTip._removeFromView(),i){this.featureTip=new p.InfoWindow,this.featureTip._addToView(this),this.featureTip.text(i[3]||"无名要素"),this.featureTip.setPoint(t),this.featureTip.update();var n=this.featureTip,s=p.domain+"/detail/query?at=dt&v=1&c_x="+t[0]+"&c_y="+t[1]+"&tn=horae&tp="+(1+(i[0]>>1))+"&name="+(i[3]||"");$.ajax({type:"GET",url:s,timeout:1e4,dataType:"json",success:function(t,e,i){var s,r=[];for(var a in t)(s=a.split("_")).length<2||r.push([parseInt(s.pop()),s.join("_"),t[a]]);r.sort(function(t,e){return t[0]-e[0]});var o,h=$("<table>").css({"border-collapse":"collapse","border-spacing":0,"border-left":"1px solid #888","border-top":"1px solid #888"}),l={"border-right":"1px solid #888","border-bottom":"1px solid #888",padding:"2px 2px"};for(o=0;o<r.length;++o)h.append($("<tr>").append($("<td>").css(l).text(r[o][1]),$("<td>"),$("<td>").css(l).text(r[o][2])));var c,u;n.contentBox.append(c=$("<div>").css({width:120,overflow:"scroll"}).append(h)),(u=h.height()+2)>300&&(u=300),c.css({height:u}),n._resize(140,u+40),n.update()}}),this.refreshMap()}else this.featureTip=null,this._featurePicked&&this.refreshMap();this._featurePicked=i},p.Map.prototype={getSize:function(){var t=this.view.mapMode;return new p.Size(t.width,t.height)},getBounds:function(){var t=this.view.getBounds();return new p.Bounds(t[0],t[1])},pointToOverlayPixel:function(t){var e=this.view.pointAtLonlat(t.lon,t.lat);return new p.Pixel(e[0],e[1])},centerAndZoom:function(t,e){var i=this.view,n=i.mapMode;n.lon=t.lon,n.lat=t.lat,n.z=e,n.fixToLonlat(),n.listenerNotify(["move","zoom"]),i.refreshMap()},enableScrollZooming:function(){this.view._scrollWheelZooming=!0},disableScrollZooming:function(){this.view._scrollWheelZooming=!1},panTo:function(t){var e=this.view,i=e.mapMode;i.lon=t.lon,i.lat=t.lat,i.fixToLonlat(),i.listenerNotify("move"),e.refreshMap()},zoom:function(){return this.view.mapMode.z},getZoom:function(){return this.view.mapMode.z},setZoom:function(t){var e=this.view,i=e.mapMode;i.z=t,i.fixToLonlat(),i.listenerNotify("zoom"),e.refreshMap()},setCenter:function(){var t,e=this.view,i=this.view.mapMode,n=null;if(2==arguments.length)n=arguments[0],t=arguments[1];else if(1==arguments.length){var s=arguments[0];null!=s.lon&&null!=s.lat?(n=s.lon,t=s.lat):s instanceof Array&&2==s.length&&(n=s[0],t=s[1])}null!=n&&(i.lon=n,i.lat=t,i.fixToLonlat(),i.listenerNotify("move"),e.refreshMap())},getCenter:function(){var t=this.view.mapMode;return new p.Point(t.lon,t.lat)},maxZoom:function(){return this.view.mapMode.maxZ},setMaxZoom:function(t){t|=0,this.view.mapMode.minZ<=t&&t<=23&&(this.view.mapMode.z>t&&this.setZoom(t),this.view.mapMode.maxZ=t)},minZoom:function(){return this.view.mapMode.minZ},setMinZoom:function(t){0<=(t|=0)<=this.view.mapMode.maxZ&&(this.view.mapMode.z<t&&this.setZoom(t),this.view.mapMode.minZ=t)},getBorderBounds:function(){return this.view.mapMode.bounds},setBorderBounds:function(t){this.view.mapMode.setBorderBounds(t)},enableDragging:function(){},addOverlay:function(t,e){t._map||(t._addToView(this.view),this.view.overlays.push(t),null==t._draw||e||this.view.onDrawFrame())},removeOverlay:function(t,e){if(t._map==this){var i=this.view.overlays.indexOf(t);if(i>=0)this.view.overlays.splice(i,1),t._removeFromView();else for(var n=0,s=this.view.overlays.length;n<s;++n)this.view.overlays[n]._id,t._id;null==t._draw||e||this.view.onDrawFrame()}},clearOverlays:function(){for(var t,e=0,i=this.view.overlays.length;e<i;++e)(t=this.view.overlays[e])&&t._removeFromView&&t._removeFromView();this.view.overlays=[]},addEventListener:function(t,e){return this.view.mapMode.addListener(t,e)},removeEventListener:function(t){return this.view.mapMode.removeListener(t)},pointToPixel:function(t){var e=this.view.mapMode.pointAtLonlat(t.lon,t.lat);return new p.Pixel(0|e[0],0|e[1])},pixelToPoint:function(t){var e=this.view.mapMode.lonlatAtPoint(t.x,t.y);return new p.Point(e[0],e[1])},setViewport:function(t){this.view.mapMode.setViewport(t.sw.lon,t.ne.lon,t.sw.lat,t.ne.lat),this.view.refreshMap()},getViewport:function(){},getLayers:function(){return this.view.layers},getBasicLayer:function(){return this.view.basicLayer},getImageLayer:function(){return this.view.imageLayer},getDynamicCanvas:function(t){for(var e=0,i=this.view.layers.length;e<i;++e)if(this.view.layers[e]instanceof p.Canvas.MapCanvasDynamic&&0==t--)return this.view.layers[e];return null},enterDrawMode:function(t,e){this.lockMap(),null==this.view.geoPicker&&(this.view.geoPicker=new b(this,this.view,t),e&&$.extend(this.view.geoPicker,e))},exitDrawMode:function(){var t=null;return this.view.geoPicker&&(t=this.view.geoPicker.exit(),delete this.view.geoPicker,this.unlockMap()),t},click:function(t){null==this.view.clickProcs&&(this.view.clickProcs=[]),this.view.clickProcs.push(t)},removeClick:function(t){this.view.clickProcs&&("number"==typeof t?t>=0&&t<this.view.clickProcs.length&&this.view.clickProcs.splice(t):(t=this.view.clickProcs.index(t))>=0&&this.view.clickProcs.splice(t),0==this.view.clickProcs.length&&delete this.view.clickProcs)},refresh:function(){this.view.refreshMap()},lockMap:function(){this._oldLockFlag=[this.view.moveLock,this.view.zoomLock,this.view.rotateLock],this.view.moveLock=this.view.zoomLock=this.view.rotateLock=!0},unlockMap:function(){this.view.moveLock=this._oldLockFlag[0],this.view.zoomLock=this._oldLockFlag[1],this.view.rotateLock=this._oldLockFlag[2]}}}(),v.private.egaki=function(t,e){function i(t){return n[t.t]}var n=[function(t,e,i){},function(t,e,i){var n=e.ratio/e.scale;i.w>=0&&(null==i.wlw&&(i.wlw=(i.l||0)+2*(i.w||0),0==i.wlw&&(i.wlw=1)),t.lineWidth=i.wlw*n,t.strokeStyle=i.s,t.setLineDash([]),t.stroke()),i.l>=0&&(t.lineWidth=i.l*n,t.strokeStyle=i.f,t.setLineDash(i.d||[]),t.stroke())},function(t,e,i){t.fillStyle=i.f,t.fill()},function(t,e,i){t.fillStyle=i.f,t.fill()}];(new Image).src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAEL0lEQVR4Xu2dYXKdMAyE/U6W9GQvOVmaXqwZBUjJm8zUSDvIRl9+tgiLZd9qsYW5tdb+Nv7KInBbCfDeWvvtQOGptWbn8MTacMTn4fds+G8EeG2tvTgIcF8J4Im14YhfCJCBn415hwB5NyD7ByAhgEM0CBkEAQgwyI3ISkNCAGr4vCUEAhQ3oRAAAvAUULmESRQgy8AwbhwBCBDHcOozSAhQWUKzJ3Ki40MATCAmsLKCfVMAW83bVvRsYWiTl32R++nfbTXvz7qYYWD+73j7//159quBR8bdzmNj2qrWfjXyyHkq5/9m2P20HLytTD2uUPHvC72vgoP9aMLLwVPb4OLJYwIxgZhATODaEkZHkK8ezEwgSgAlIF4CfL8bokZAQKIAI1wIOfgQkBBg5hoYnUufPR4C4AHiHgAFoCcw7cWG2SU4O39JCfDZD6JGQAACjHAXEnOQEAAPcBEPQD/A8qJqpX4GST+ANVTYq+UmJ57+gX1DiGed3W7ar4eGkCPnqZy/pB+AEnCREuBdDUz0MAwdREBiAoM5EJ6IgIQAlIDiJQACQACmgpP2+IlOJVMCWA2MrwYmehiGDiIgUYBgDoQnIiAhACYQE4gJxATm7HQZdcHV4ykBPAXwFJDowdKHluwPYFdx5H18jv9337Nxox9g3a6+aj8D/QB4gLgHYB6AeQDmASrPA6RbWRJwIyCZB3CPTmA6AhIC4AHwAHiAyh4ABUABUIDKCpDuZEjAjYDEBLpHJzAdAQkB8AB4ADxAZQ+AAlxEAdgfgP0Bvj66cOT9enMyHL/4udlwkPQDpFtZEnAjwFMADSE0hFQ2sSgACoACoADBL4a4HQiB6QhISkD6VZCAGwEJASpL6OzvFkIATCAmsLKCoQAoQFwB3A6EwHQEJAqQfhUk4EZAQoDKNfRSTwH0A9AP4OoHqLzfvknozN87kPQDUAIu0hLG9wLcXmraQIkJnPbqSfyzhe1+C64GUgKKlwAIAAF4MYQXQ9gq9vGTeb0WI1NBJR6g90I5bjwEIMB49+TUjCQEyJSw2efis/OHAPQDMA9QWcFQABQgrgCnuhYGkyLA9wJWOLP37bcytP87Kx++F8D3AtoTi0HzzuVHHyMxgZjAuAms/BgV/QVmx0sUQGpLOdmpCECAU+EebzAJASgB85pICIAJxARWVjAUAAWIK8B41oaMehGQKEDvYBw3HgISAlSuodkTOdHxIQAeIO4BUICLzAOwPwD7A7j2B7A6NNs++Y8vcVTNX7I/wHjelox6EcAEYgIxgZVNLAqAAqAAKEBwh5Bew8Fx4yEgKQHjXRYZ9SIgIUBlCY3OxWfHQwBMICawsoKhAChAXAF6DQfHjYeARAHGuywy6kXgGwHeW/taDew9gR233y37SNx2LPFLP4GtzHn+Ivg92/3b3g72DE7MBRD4AB+X7j1A9PfvAAAAAElFTkSuQmCC",t.vectorDraw=e?function(t,e,n){var s=n[0];if(null!=s){var r=e.ratio,a=s[e.z>7?"f":"s"];a&&(t.fillStyle=a,t.beginPath(),t.rect(0,0,e.width,e.height),t.fill()),t.lineCap="butt",t.lineJoin="round",t.miterLimit=2;for(var o=new Set,h=0,l=n.length;h<l;++h)o.merge(n[h].zIndexKeys);for(var c,u=0,f=(o=Array.from(o).sort()).length;u<f;++u){c=o[u];for(var d,m=!0,p=new Set;m;){d=null,m=!1,t.beginPath();for(var h=0,l=n.length;h<l;++h){if(null!=(s=n[h]).g&&!(null==(z=s.g[c])||z.length<=0)){t.save(),e.initTransform(t,s);for(var v,g=0,y=z.length;g<y;++g){var w=z[g],x=w.hash();if(null==d){if(p.has(x))continue;d=w,p.add(x)}else if(d.hash()!=x){p.has(x)||(m=!0);continue}for(var _=0,M=(v=w.a).length;_<M;++_)for(var k=v[_],b=0,C=k.length;b<C;b+=2)0==b?t.moveTo(k[b],k[b+1]):t.lineTo(k[b],k[b+1])}t.restore()}}t.setTransform(r,0,0,r,0,0),i(d)(t,e,d)}}var T=this.boldGeos;if(null!=T){var P=null;t.beginPath();for(var A=0,L=T.length;A<L;++A){var S=T[A],z=S[1];P!=S[0]&&(P&&t.restore(),t.save(),e.initTransform(t,S[0]),P=S[0]);for(var D=0,I=z.length;D<I;D+=2)0==D?t.moveTo(z[D],z[D+1]):t.lineTo(z[D],z[D+1])}P&&t.restore(),t.setTransform(r,0,0,r,0,0),i(T)(t,e,T)}}}:function(t,e,n){if(null!=n&&null!=n.zIndexKeys){var s=n[e.z>7?"f":"s"];s&&(t.fillStyle=s,t.beginPath(),t.rect(0,0,e.width,e.height),t.fill()),t.lineCap="butt",t.lineJoin="round",t.miterLimit=2;for(var r,a=Array.from(n.zIndexKeys).sort(),o=0,h=a.length;o<h;++o){r=a[o];for(var l,c=!0,u=new Set;c;)if(l=null,c=!1,t.beginPath(),null!=n.g&&!(null==(P=n.g[r])||P.length<=0)){t.save();for(var f,d=0,m=P.length;d<m;++d){var p=P[d],v=p.hash();if(null==l){if(u.has(v))continue;l=p,u.add(v)}else if(l.hash()!=v){u.has(v)||(c=!0);continue}for(var g=0,y=(f=p.a).length;g<y;++g)for(var w=f[g],x=0,_=w.length;x<_;x+=2)0==x?t.moveTo(w[x],w[x+1]):t.lineTo(w[x],w[x+1])}t.restore(),t.setTransform(2,0,0,2,0,0),i(l)(t,e,l)}}var M=this.boldGeos;if(null!=M){var k=null;t.beginPath();for(var b=0,C=M.length;b<C;++b){var T=M[b],P=T[1];k!=T[0]&&(k&&t.restore(),t.save(),e.initTransform(t,T[0]),k=T[0]);for(var A=0,L=P.length;A<L;A+=2)0==A?t.moveTo(P[A],P[A+1]):t.lineTo(P[A],P[A+1])}k&&t.restore(),t.setTransform(2,0,0,2,0,0),i(M)(t,e,M)}}}},function(){function t(t){return null==t.mapMode&&t._owner?{context:t.context,mapMode:t._owner.mapMode,width:t._owner.mapMode.width,height:t._owner.mapMode.height}:t}var e=p.Drawer||(p.Drawer={}),i=2*Math.PI;e.scattermap=function(e,n,s){var r=(e=t(e)).context,a=e.mapMode.ratio;s=s||{};this.adjustSize=function(){},this.render=function(){var t,e=n.get(),o=(s.size||.7)*a;for(r.setTransform(a,0,0,a,0,0),r.beginPath();null!=(t=e.next());){var h=t.x,l=t.y;r.moveTo(h,l),r.arc(h,l,o,0,i)}r.fillStyle=s.fillStyle||"red",r.fill(),r.closePath()}},e.heatmap=function(e,n,s){function r(t){var e,i,n,s=t.data,r=0;for(e=3,i=s.length;e<i;e+=4)(n=s[e])>r&&(r=n);if(r>0){var a=255/r;for(e=3,i=s.length;e<i;e+=4)(n=s[e])>0&&(s[e]=n=n*a|0,n<<=2,s[e-3]=o[n],s[e-2]=o[n+1],s[e-1]=o[n+2])}return t}function a(){var t=e.mapMode.ratio;l.width=e.width,l.height=e.height,l.style.width=e.width/t,l.style.width=e.width/t,h=200*(e.width+e.height),c.shadowOffsetX=-h,c.shadowOffsetY=-h,c.shadowBlur=25*t}var o,h=2*((e=t(e)).width+e.height),l=document.createElement("canvas"),c=l.getContext("2d");s=s||{},function(){l.height=1,l.width=256;var t=s.gradient||{.25:"blue",.55:"green",.8:"yellow",1:"red"},e=c.createLinearGradient(0,0,256,1);for(var i in t)e.addColorStop(parseFloat(i),t[i]);c.fillStyle=e,c.fillRect(0,0,256,1),o=c.getImageData(0,0,256,1).data}(),a(),this.adjustSize=a,this.render=function(){var t=e.mapMode.ratio;c.setTransform(1,0,0,1,0,0),c.clearRect(0,0,e.width,e.height),c.translate(h,h),c.scale(t,t);for(var s,a=n.get(),o=n.maxVal;null!=(s=a.next());){var l=s.x,u=s.y,f=(s.count||0)/o,d="rgba(0,0,0,"+(f||"0.1")+")";c.beginPath(),c.arc(l,u,16*t,0,i,!0),c.shadowColor=d,c.fill(),c.closePath()}var m=c.getImageData(0,0,e.width,e.height);r(m),e.context.putImageData(m,0,0)}}}(),function(){var e=Math.PI,n=2*e,s=e/180,r=p.GeoUtils,a=r;p.Point=function(){if(1==arguments.length){var t=arguments[0];t instanceof Array?(this.lon=t[0],this.lat=t[1]):(this.lon=t.lon,this.lat=t.lat)}else this.lon=arguments[0],this.lat=arguments[1],arguments.length>2&&(this.headmark=1);this.lon=a.fixlon(this.lon),this.lat=a.fixlat(this.lat)},p.Point.prototype={equals:function(t){return this.lon==t.lon&&this.lat==t.lat},distance:function(t,e){var i,n;return t instanceof Number&&e instanceof Number?(i=t,n=e):t instanceof p.Point&&(i=t.lon,n=t.lat),a.arc_points(this.lon,this.lat,i,n)*a.TK_EARTH_RADIUS},normalize:function(){this.lon=a.fixlon(this.lon),this.lat=a.fixlat(this.lat)}};var o=p.Point.toPoint=function(){if(arguments.length){var t=arguments[0],e=null;if(null==t)return null;if(arguments.length>=2&&(e=arguments[1]),"number"==typeof t&&"number"==typeof e)return new p.Point(t,e);if(null!=t.lon&&null!=t.lat)return t;if(t instanceof Array)return t.length>2&&"number"!=typeof t[0]?t.map(o):new p.Point(t)}return null};p.Pixel=function(){if(1==arguments.length){var t=arguments[0];t instanceof Array?(this.x=t[0],this.y=t[1]):(this.x=t.x,this.y=t.y)}else this.x=arguments[0],this.y=arguments[1]},p.Pixel.prototype={equals:function(t){return this.x==t.x&&this.y==t.y}};var h=p.Pixel.toPixel=function(){if(arguments.length){var t=arguments[0],e=null;if(null==t)return null;if(arguments.length>=2&&(e=arguments[1]),"number"==typeof t&&"number"==typeof e)return new p.Pixel(t,e);if(null!=t.x&&null!=t.y)return t;if(t instanceof Array)return t.length>2&&"number"!=typeof t[0]?t.map(h):new p.Pixel(t)}return null};p.Size=function(t,e){this.width=t,this.height=e},p.Size.prototype={equals:function(t){return this.width==t.width&&this.height==t.height}},p.Bounds=function(t,e){this.sw=new p.Point(t),this.ne=new p.Point(e)},p.Bounds.prototype={equals:function(t){return t instanceof p.Bounds&&this.sw.equals(t.sw)&&this.ne.equals(t.ne)},containsPoint:function(t){return this.sw.lon<=t.lon&&t.lon<=this.ne.lon&&this.sw.lat<=t.lat&&t.lat<=this.ne.lat},getCenter:function(){return new p.Point((this.sw.lon+this.ne.lon)/2,(this.sw.lat+this.ne.lat)/2)},isEmpty:function(){return!1},getSouthWest:function(){return this.sw},getNorthEast:function(){return this.ne},toSpan:function(){return new p.Size(this.ne.lon-this.sw.lon,this.ne.lat-this.sw.lat)},extend:function(t){this.sw.lon>t.lon&&(this.sw.lon=t.lon),this.sw.lat>t.lat&&(this.sw.lat=t.lat),this.ne.lon<t.lon&&(this.ne.lon=t.lon),this.ne.lat<t.lat&&(this.ne.lat=t.lat)}};var l=0;p.Overlay=function(){this._visible=!0,this._owner=null,this._map=null,this._id=l++},p.Overlay.prototype={_addToView:function(t){this._owner=t,this._map=t._map},_removeFromView:function(){this._owner=null,this._map=null},show:function(){this._visible=!0},hide:function(){this._visible=!1},toggle:function(){this._visible?this.hide():this.show()},getVisible:function(){return this._visible},getMap:function(){return this._map}},p.Shape=function(){t(this,p.Overlay,arguments),this.color="#ff8800"},i(p.Shape,p.Overlay,{_draw:function(t,e){},_resetTransform:function(t){var e=this._owner.mapMode.ratio;t.setTransform(e,0,0,e,0,0)}}),p.Circle=function(e,i,n){t(this,p.Shape,arguments),this.point=p.Point.toPoint(e),this.radius=i,i/=6378137*s,this._Point={lon:e.lon,lat:e.lat-i},this.mctPoint={},this.mctLength={},this.width=3,this.color="#ff0000",this.fillColor="rgba(255,192,0,0.2)",n&&$.extend(this,n)},i(p.Circle,p.Shape,{_draw:function(t,e){if(this._visible){var i=this.getMctPt(e),s=this.mctLength[e]*this._map.view.mapMode.scale/this._map.view.mapMode.ratio;t.beginPath(),t.arc(i[0],i[1],s,0,n),this._resetTransform(t),this.color&&(t.setLineDash(this.dash||[]),t.lineWidth=this.width,t.strokeStyle=this.color,t.stroke()),this.fillColor&&(t.fillStyle=this.fillColor,t.fill()),t.closePath()}},getMctPt:function(t){var e=this.mctPoint[t];if(null==e){var i=a.ll2mct(this._Point.lon,this._Point.lat,t);e=a.ll2mct(this.point.lon,this.point.lat,t),this.mctPoint[t]=e,this.mctLength[t]=i[1]-e[1]}return e}}),p.MultiPoint=function(e){t(this,p.Shape,arguments),this.lonlats=(e||[]).map(o),this.mctPoint={},this.continuous=!1},i(p.MultiPoint,p.Shape,{getMctPts:function(t){var e=this.mctPoint[t];if(e)return e;if(e=[],this.continuous){this.lonlats.forEach(function i(n){var s=e.length;if(n instanceof Array)n.forEach(i),e[s]&&e[s].push(0);else if(n instanceof p.Point){var r=a.ll2mct(n.lon,n.lat,t);n.headmark&&r.push(0),e.push(r)}})}else{var i=new Set(this.lonlats.map(function(e){var i=a.ll2mct(e.lon,e.lat,t);return(0|i[0])+","+(0|i[1])}));e=Array.from(i).map(function(t){var e=t.split(",");return[+e[0],+e[1]]})}return this.mctPoint[t]=e,e},_draw:function(t,e){if(this._visible){var i,s=this.getMctPts(e);if(s.length>0){t.beginPath();for(var r=0,a=s.length;r<a;++r)i=s[r],t.arc(i[0],i[1],1,0,n);t.fillStyle=this.color,t.fill(),t.closePath()}}},addPoint:function(t){this.lonlats.push(o(t)),this.mctPoint={}}}),p.Polyline=function(){t(this,p.MultiPoint,arguments),this.continuous=!0,this.width=3,this.dash=[]},i(p.Polyline,p.MultiPoint,{_draw:function(t,e){if(this._visible){var i=this.getMctPts(e);if(i.length>0){var n=i[0];t.beginPath(),t.moveTo(n[0],n[1]);for(var s=1,r=i.length;s<r;++s)(n=i[s]).length>2?t.moveTo(n[0],n[1]):t.lineTo(n[0],n[1]);this._resetTransform(t),t.setLineDash(this.dash||[]),t.lineWidth=this.width,t.strokeStyle=this.color,t.stroke(),t.closePath()}}},getLength:function(){for(var t=0,e=0,i=this.lonlats.length-1;e<i;++e)t+=r.getDistance(this.lonlats[e],this.lonlats[e+1]);return t}}),p.Polygon=function(){t(this,p.MultiPoint,arguments),this.continuous=!0,this.strokeColor="red",this.color="rgba(255,192,0,0.2)"},i(p.Polygon,p.MultiPoint,{_draw:function(t,e){if(this._visible){var i=this.getMctPts(e);if(0==i.length)return;var n=i[0],s=0;t.beginPath(),t.moveTo(n[0],n[1]);for(var r=1,a=i.length;r<a;++r)if((n=i[r]).length>2){var o=i[s];t.lineTo(o[0],o[1]),t.moveTo(n[0],n[1]),s=r}else t.lineTo(n[0],n[1]);n=i[s],t.lineTo(n[0],n[1]),this._resetTransform(t),this.strokeColor&&(t.setLineDash(this.dash||[]),t.lineWidth=this.width||3,t.strokeStyle=this.strokeColor,t.stroke()),this.color&&(t.mozFillRule="evenodd",t.fillStyle=this.color,t.fill("evenodd")),t.closePath()}}}),p.DOMTagOverlay=function(e){t(this,p.Overlay,arguments),this.point=p.Point.toPoint(e),this.listener=0,this._sv=null,this._attached=!1,this._clickProc=null,this.width=this.height=10},i(p.DOMTagOverlay,p.Overlay,{setPoint:function(t){var e=o(t);e&&(this.point=e)},getPoint:function(){return this.point},_addToView:function(t){if(!this._owner){p.Overlay.prototype._addToView.bind(this)(t),this._sv.appendTo(t.domsv),this._attached=!0,this.update(),this._clickProc&&this.click(this._clickProc);var e=this;this.listener=t.mapMode.addListener(function(){e.update()},["zoom","move","rotate","resize"]),this._sv.mouseover(function(){e._oldzindex=e._sv.css("z-index"),e._sv.css({"z-index":100})}).mouseout(function(){e._sv.css({"z-index":e._oldzindex||20})})}},_removeFromView:function(){this._sv.detach(),this._sv._attached=!1,this._owner&&this._owner.mapMode.removeListener(this.listener),this.listener=0,this._owner=null,this._sv.unbind(),p.Overlay.prototype._removeFromView.bind(this)()},getUpdatedPosition:function(){if(this._owner&&this.point){var t=this._owner.mapMode.pointAtLonlat(this.point.lon,this.point.lat);return t.push(t[0]+this.width),t.push(t[1]+this.height),t}},update:function(){if(this._owner&&this.point){var t=this.getUpdatedPosition(),e=this._owner,i=t[2]>0&&t[3]>0&&t[0]<e.width&&t[1]<e.height;i?(this._attached||this._sv.appendTo(this._owner.domsv),this._sv.css({left:t[0],top:t[1]})):this._attached&&this._sv.detach(),this._attached=i}},hide:function(){this._sv.hide(),this._visible=!1},show:function(){this._sv.show(),this._visible=!0},click:function(t){this._clickProc=t,this._sv.unbind("click"),this._sv.bind("click",t)}}),p.Marker=function(e){t(this,p.DOMTagOverlay,arguments),this._sv=$("<DIV>").attr({class:"tkm-map-pin"}),this.width=this.height=16,this.offsetX=this.offsetY=0,this._getAnchor=this._getCenter0,this._anchor=0,this.onclick=null},i(p.Marker,p.DOMTagOverlay,{_getCenter0:function(){return[-this.width/2,-this.height/2]},_getCenter1:function(){return[-this.width/2,-this.height]},_getCenter2:function(){return[0,-this.height]},_getCenter3:function(){return[0,-this.height/2]},_getCenter4:function(){return[0,0]},_getCenter5:function(){return[-this.width/2,0]},_getCenter6:function(){return[-this.width,0]},_getCenter7:function(){return[-this.width,-this.height/2]},_getCenter8:function(){return[-this.width,-this.height]},setImage:function(t){this._sv.css({"background-image":'url("'+t+'")'});var e=this,i=new Image;i.onload=function(){e._sizeSet||e.setSize(i.width,i.height)},i.src=t},getImage:function(){return this._sv.css("background-image")},setSize:function(t,e){this.width=t,this.height=e,this._sizeSet=!0,this._sv.css({width:t+"px",height:e+"px"}),this.update()},setOffset:function(t,e){"number"==typeof t.x?(this.offsetX=t.x,this.offsetY=t.y):(this.offsetX=t,this.offsetY=e),this.update()},getOffset:function(){return new p.Pixel(this.offsetX,this.offsetY)},setAnchor:function(t){this._anchor=t,this._getAnchor=this["_getCenter"+t]},getAnchor:function(){return this._anchor},getUpdatedPosition:function(){if(this._owner&&this.point){var t=this._getAnchor(),e=this._owner.mapMode.pointAtLonlat(this.point.lon,this.point.lat);return e[0]+=t[0]+this.offsetX,e[1]+=t[1]+this.offsetY,e.push(e[0]+this.width),e.push(e[1]+this.height),e}}}),p.TextIconOverlay=function(e,i,n){t(this,p.Marker,arguments),this._sv=$("<DIV>").text(i).attr({class:"tkm-pin-overlay"}).css({"font-size":"10px","font-family":"Arial, sans-serif","font-weight":"bold"}),this._sv.css({"line-height":this._sv.css("height")})},i(p.TextIconOverlay,p.DOMTagOverlay,{setPoint:function(t){this.point=p.Point.toPoint(t),this.update()},setText:function(t){this._sv.text(t)}}),p.Bubble=function(e){t(this,p.Marker,arguments),this._style=1,this.width=26.9,this.height=40,this._sv=$("<DIV>").attr({class:"tkm-map-pin"}).css({"background-image":'url("img/mappin-'+this._style+'.png")',width:this.width+"px",height:this.height+"px"}),this.onclick=null,this.setAnchor(1)},i(p.Bubble,p.Marker,{getStyle:function(){return this._style},setStyle:function(t){0<t&&t<=6&&(this._style=t,this._sv.css({"background-image":'url("img/mappin-'+this._style+'.png")'}))}}),p.InfoWindow=function(e){t(this,p.DOMTagOverlay,arguments),this.arrow=$("<tktrs>").append($("<tktri>")),this.contentBox=$("<DIV>").attr({class:"tkm-bubble-content"}),this._sv=$("<DIV>").attr({class:"tkm-bubble"}).append(this.contentBox,this.arrow),this.width=this.height=40,this._resize(100,40),this.offset=0},i(p.InfoWindow,p.DOMTagOverlay,{getUpdatedPosition:function(){var t=p.DOMTagOverlay.prototype.getUpdatedPosition.bind(this)();if(t)return t[0]+=-this.width/2,t[1]+=-this.height-this.offset-12,t},text:function(t){var e={"font-size":"14px"};this.contentBox.text(t),this.contentBox.css(e);var i=t.visualLength(e);this._resize(i+20,40)},setSize:function(t,e){t.x,this._resize(t,e),this.update()},getSize:function(){return new p.Size(this.width,this.height)},getOffset:function(){return this.offset},setOffset:function(t){this.offset=t||0,this.update()},_resize:function(t,e){t<=40&&(t=40),this.width=t,this.height=e,this._sv.css({width:t+"px",height:e+"px"}),this.arrow.css({left:t/2-10+"px"})}})}(),h.prototype={intersect:function(t){return this.left<=t.right&&t.left<=this.right&&this.top<=t.bottom&&t.top<=this.bottom},inrect:function(t,e){return this.left<=t&&t<=this.right&&this.top<=e&&e<=this.bottom},incore:function(t){var e=t.x,i=t.y;return this.left<=e-this.margin&&e+this.margin<=this.right&&this.top<=i-this.margin&&i+this.margin<=this.bottom}},l.prototype={enumerate:function(t,e){var i,n,s,r=t.left>>8,a=t.right>>8,o=t.top>>8,h=t.bottom>>8;if(r<0&&(r=0),a>=this.w&&(a=this.w-1),o<0&&(o=0),h>=this.h&&(h=this.h-1),!(a<0||r>=this.w||h<0||o>=this.h))for(i=o;i<=h;++i)for(s=i*this.w,n=r;n<=a;++n)if(e(this.arr[s+n],t))return},putrect:function(t){this.enumerate(t,function(t,e){return t.push(e),0})},puttable:function(t){if(null==t)return 0;var e=1,i=0;return this.enumerate(t,function(t,n){i=1;for(var s=t.length-1;s>=0;s--)if(n.intersect(t[s]))return e=0;return 0}),i&&e},pointed:function(t){var e=t.x>>8,i=t.y>>8;if(!(e<0||e>=this.w||i<0||i>=this.h)){var n=this.arr[i*this.w+e];for(e=0,i=n.length;e<i;++e)if(n[e].incore(t))return n[e]}}},c.prototype={get:function(t,e){var i=this.cache[t];if(null!=i&&!e){var n=this.header;i.prev.next=i.next,i.next.prev=i.prev,i.next=n,i.prev=n.prev,n.prev.next=i,n.prev=i}return i},setObject:function(t){if(t.key){var e=this.header,i=this.cache[t.key];i&&(i.prev.next=i.next,i.next.prev=i.prev),t.next=e,t.prev=e.prev,e.prev.next=t,e.prev=t,this.cache[t.key]=t,++this.size>this.capacity&&(i=e.next,e.next=i.next,i.next.prev=e,delete this.cache[i.key],this.delFunc&&this.delFunc(i),--this.size)}},clear:function(){var t=this.header.next,e=t.next;for(this.cache={},this.size=0,this.header.next=this.header,this.header.prev=this.header;t!=this.header;)t.next=null,t.prev=null,this.delFunc&&this.delFunc(t),e=(t=e).next},filtObjects:function(t){for(var e=this.header,i=e.next;i!=e;)t(i)&&(i.next.prev=i.prev,i.prev.next=i.next,delete this.cache[i.key],this.delFunc&&this.delFunc(i)),i=i.next},replaceObjects:function(t){for(var e,i=this.header,n=i.prev;n!=i;)(e=t(n))&&(n.next.prev=e,n.prev.next=e,this.delFunc&&this.delFunc(n),e.next=n.next,e.prev=n.prev,this.cache[e.key]=e),n=n.prev}};var g=function(t,e,i){e=y(e);var n=t.pointToPixel(e.getNorthEast()),s=t.pointToPixel(e.getSouthWest());n.x+=i,n.y-=i,s.x-=i,s.y+=i;var r=t.pixelToPoint(n),a=t.pixelToPoint(s);return new p.Bounds(a,r)},y=function(t){var e=w(t.getNorthEast().lon,-180,180),i=w(t.getSouthWest().lon,-180,180),n=w(t.getNorthEast().lat,-74,74),s=w(t.getSouthWest().lat,-74,74);return new p.Bounds(new p.Point(i,s),new p.Point(e,n))},w=function(t,e,i){return e&&(t=Math.max(t,e)),i&&(t=Math.min(t,i)),t},x=function(t){return"[object Array]"===Object.prototype.toString.call(t)},_=function(t,e){var i=-1;if(x(e))if(e.indexOf)i=e.indexOf(t);else for(var n,s=0;n=e[s];s++)if(n===t){i=s;break}return i};(p.MarkerClusterer=function(t,e){if(t){this._map=t,this._markers=[],this._clusters=[];var i=e||{};this._gridSize=i.gridSize||90,this._maxZoom=i.maxZoom||18,this._minClusterSize=i.minClusterSize||2,this._genStyle=i.styler||d,this._isAverageCenter=!0,void 0!=i.isAverageCenter&&(this._isAverageCenter=i.isAverageCenter),this._styles=i.styles||[];var n=this;this._listener=this._map.addEventListener(function(){n._redraw()},["zoomend","moveend"]);var s=i.markers;x(s)&&this.addMarkers(s)}}).prototype={addMarkers:function(t){for(var e=0,i=t.length;e<i;e++)this._pushMarkerTo(t[e]);this._createClusters()},_pushMarkerTo:function(t){-1===_(t,this._markers)&&(t.isInCluster=!1,this._markers.push(t))},addMarker:function(t){this._pushMarkerTo(t),this._createClusters()},_createClusters:function(){for(var t,e=this._map.getBounds(),i=g(this._map,e,this._gridSize),n=0;t=this._markers[n];n++)!t.isInCluster&&i.containsPoint(t.getPoint())&&this._addToClosestCluster(t)},_addToClosestCluster:function(t){t.getPoint();for(var e,i=0;e=this._clusters[i];i++)if(e.isMarkerInClusterBounds(t))return void e.addMarker(t);(e=new m(this)).addMarker(t),this._clusters.push(e)},_clearLastClusters:function(){for(var t,e=0;t=this._clusters[e];e++)t.remove();this._clusters=[],this._removeMarkersFromCluster()},_removeMarkersFromCluster:function(){for(var t,e=0;t=this._markers[e];e++)t.isInCluster=!1},_removeMarkersFromMap:function(){for(var t,e=0;t=this._markers[e];e++)t.isInCluster=!1,this._map.removeOverlay(t)},_removeMarker:function(t){var e=_(t,this._markers);return-1!==e&&(this._map.removeOverlay(t),this._markers.splice(e,1),!0)},removeMarker:function(t){var e=this._removeMarker(t);return e&&(this._clearLastClusters(),this._createClusters()),e},removeMarkers:function(t){for(var e=!1,i=0;i<t.length;i++){var n=this._removeMarker(t[i]);e=e||n}return e&&(this._clearLastClusters(),this._createClusters()),e},clearMarkers:function(){this._clearLastClusters(),this._removeMarkersFromMap(),this._markers=[]},_redraw:function(){this._clearLastClusters(),this._createClusters()},getGridSize:function(){return this._gridSize},setGridSize:function(t){this._gridSize=t,this._redraw()},getMaxZoom:function(){return this._maxZoom},setMaxZoom:function(t){this._maxZoom=t,this._redraw()},getStyles:function(){return this._styles},setStyles:function(t){this._styles=t,this._redraw()},getMinClusterSize:function(){return this._minClusterSize},setMinClusterSize:function(t){this._minClusterSize=t,this._redraw()},isAverageCenter:function(){return this._isAverageCenter},getMap:function(){return this._map},getMarkers:function(){return this._markers},getClustersCount:function(){for(var t,e=0,i=0;t=this._clusters[i];i++)t.isReal()&&e++;return e},uninstall:function(){this.clearMarkers(),this._map.removeListener(this._listener)}},m.prototype={addMarker:function(t){if(this.isMarkerInCluster(t))return!1;if(this._center){if(this._isAverageCenter){var e=this._markers.length+1,i=t.getPoint(),n=(this._center.lat*(e-1)+i.lat)/e,s=(this._center.lon*(e-1)+i.lon)/e;this._center=new p.Point(s,n),this.updateGridBounds()}}else this._center=t.getPoint(),this.updateGridBounds();t.isInCluster=!0,this._markers.push(t);var r=this._markers.length;if(r<this._minClusterSize)return this._map.addOverlay(t),!0;if(r===this._minClusterSize)for(var a=0;a<r;a++)this._map.removeOverlay(this._markers[a]);return this._isReal=!0,this.updateClusterMarker(),!0},isMarkerInCluster:function(t){if(this._markers.indexOf)return-1!=this._markers.indexOf(t);for(var e,i=0;e=this._markers[i];i++)if(e===t)return!0;return!1},isMarkerInClusterBounds:function(t){return this._gridBounds.containsPoint(t.getPoint())},isReal:function(t){return this._isReal},updateGridBounds:function(){var t=new p.Bounds(this._center,this._center);this._gridBounds=g(this._map,t,this._markerClusterer.getGridSize())},updateClusterMarker:function(){if(this._map.getZoom()>this._markerClusterer.getMaxZoom()){this._map.removeOverlay(this._clusterMarker);for(var t,e=0;t=this._markers[e];++e)this._map.addOverlay(t)}else if(this._markers.length<this._minClusterSize)this._clusterMarker.hide();else{this._map.addOverlay(this._clusterMarker),this._clusterMarker._sv.css(this._markerClusterer._genStyle(this._markers.length)),this._clusterMarker.setPoint(this._center),this._clusterMarker.setText(this._markers.length);var i=this;this._clusterMarker.click(function(t){i._map.setViewport(i.getBounds())})}},remove:function(){for(var t=0;this._markers[t];t++)this._map.removeOverlay(this._markers[t]);this._map.removeOverlay(this._clusterMarker),this._markers.length=0,delete this._markers},getBounds:function(){for(var t,e=new p.Bounds(this._center,this._center),i=0;t=this._markers[i];i++)e.extend(t.getPoint());return e},getCenter:function(){return this._center}}}();