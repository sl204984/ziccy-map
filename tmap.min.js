/**
 * TMap - A webmap framework for showing custom map data oriented
 * @version v1.0.1
 * @link http://www.tigerknows.com
 * @license MIT
 */
"use strict";function Extends(t,e,i){i?$.extend(t,new e(i[0])):$.extend(t,new e);for(var s in e.prototype)t[s]&&delete t[s]}function extendsFrom(t,e){for(var i in e.prototype)null==t.prototype[i]&&(t.prototype[i]=e.prototype[i])}function inherit(t,e,i){t.prototype=$.extend(t.prototype,e.prototype,i)}function factoryWrap(t,e){return function(){var i=new t;return"function"==typeof e&&e(i),i}}function benchmark(){this.count=0,this.elapse=0,this.average=0,this.maximum=0}function tkEventTarget(){}function tkEnvironment(){var t=navigator.userAgent;navigator.appVersion,t.toLowerCase();this.trident=t.indexOf("Trident")>-1,this.presto=t.indexOf("Presto")>-1,this.tasman=t.indexOf("Tasman")>-1,this.webKit=t.indexOf("AppleWebKit")>-1,this.khtml=t.indexOf("KHTML")>-1,this.gecko=t.indexOf("Gecko")>-1&&!this.khtml,this.webApp=-1==t.indexOf("Safari"),this.msie=t.indexOf("MSIE")>-1,this.edge=t.indexOf("Edge")>-1,this.firefox=t.indexOf("Firefox")>-1,this.opera=t.indexOf("Opera")>-1,this.safari=t.indexOf("Safari")>-1,this.chrome=t.indexOf("Chrome")>-1||0,this.microsoft=this.msie||this.edge,this.ios=!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),this.android=t.indexOf("Android")>-1||t.indexOf("Linux")>-1,this.linux=t.indexOf("Linux")>-1,this.windows=t.indexOf("Windows")>-1,this.macintosh=t.indexOf("Macintosh")>-1,this.mobile=!!t.match(/AppleWebKit.*Mobile.*/)||!!t.match(/AppleWebKit/),this.iPhone=t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,this.iPad=t.indexOf("iPad")>-1,this.language=(navigator.browserLanguage||navigator.language).toLowerCase()}function tkLayer(t){function e(){this.name=arguments[0]||"unknown",this.model=null,this.dataComplete=!0,this.shouldDraw=new Set,this.lonlatBox=[71,128,3,54],this.bboxDict={},this.visible=!0,this.minZ=4,this.maxZ=19}function i(){Extends(this,e,arguments),this.filters=new Set,this.bolds={},TMap.private.egaki(this,o),this.hasLabel=!0,this.showLabel=!0,this.drawTiles=[],this.mapPackage="horae",this.styleViewName="",this.viewId=0}function s(){Extends(this,e,arguments)}function n(){Extends(this,s,arguments),this.urlPattern=null}function a(){Extends(this,s,arguments),this.urlPattern=null}var r=TMap.Layer={},o=256,h=TMap.GeoUtils,l=h.ll2mct,c=(h.mct2ll,h.t2ll),u=(h.wmt2mct,h.mct2wmt),c=(h.morton,h.t2ll),f=h.clamp,p=h.cloop,d=h.makekey;h.rect_intersect;e.prototype={draw:function(t){},seek:function(t,e,i,s){},transrange:function(t,e){var i=1<<e;return[t[0]>>8,t[1]+256>>8,f(t[2]>>8,0,i),f(t[3]+256>>8,0,i)]},request:function(){},send:function(){},bbox:function(t){var e=this.bboxDict[t];if(e)return e;var i,s;return t>7?(i=l(this.lonlatBox[0],this.lonlatBox[2],t),s=l(this.lonlatBox[1],this.lonlatBox[3],t)):(i=l(71,3,t),s=l(128,54,t)),e=[i[0],s[0],s[1],i[1]],e=this.transrange(e,t),this.bboxDict[t]=e,e},tilegen:function(t,e,i){},keygen:d,setVisible:function(t){this.visible=t}},r.LayerVector=i,inherit(i,e,{draw:function(e,i){null!=this.boldGeo?this.boldGeos=t.styler.filtBoldFeature(this,this.drawTiles):this.boldGeos=null,this.vectorDraw(i,e,this.drawTiles)},request:function(e){t.dataPool.setRequestTiles(e)},seek:function(e,i,s,n){var a,r,o,h,l,c=[],u=new Set,f=1<<i,d=e[0],m=e[1],v=e[2],g=e[3],y=new Set;for(a=d;a<=m;++a)for(l=p(a,f),r=v;r<=g;++r)if(h=this.tilegen(l,r,i),y.add(h.key),o=t.dataPool.get(h.key,n))c.push(o),u.add(o.key);else{s.push(h);var w,x=l>>1,M=r>>1,_=i-1;w=this.keygen(x,M,_),u.has(w)||(o=t.dataPool.get(w,n))&&(c.push(o),u.add(w))}if(s.length>0){var k=d+m>>1,T=v+g>>1;s=s.sort(function(t,e){return Math.abs(e.tx-k)+Math.abs(e.ty-T)-Math.abs(t.tx-k)-Math.abs(t.ty-T)}),this.dataComplete=!1}else this.dataComplete=!0;n||(this.drawTiles=c,this.shouldDraw=y)},tilegen:function(t,e,i){var s={tx:t,ty:e,z:i,okey:d(t,e,i),layer:this};return s.key=s.okey+"z"+this.viewId,s},keygen:function(t,e,i){return d(t,e,i)+"z"+this.viewId},_updateStyleTiles:function(){var e="z"+this.viewId,i=this;t.dataPool.updateTiles(function(s){if(s.key&&s.key.endsWith(e)){var n=t.dataPool.scache.get(s.okey);if(null!=n)return t.styler.styling(n,i,s.z)}return null})},toggleFilter:function(t){var e=this,i=function(t){e.filters.has(t)?e.filters.delete(t):e.filters.add(t)};if(t instanceof Array)for(var s in t)i(t[s]);else i(t);this._updateStyleTiles()},checkFilter:function(t){return this.filters.has(t)},boldFeature:function(t){var e=this,i=function(t){e.bolds[t]?delete e.bolds[t]:e.bolds[t]={f:"red"}};if(t instanceof Array)for(var s in t)i(t[s]);else i(t);this._updateStyleTiles()},checkBoldFeature:function(t){return this.bolds[t]},customStyle:function(e,i){var s=t.styler.getRenderConfig(this.mapPackage);s.duplicateView(this.styleViewName,this.styleViewName+"-origin"),s.setStyle({view:this.styleViewName,offset:i.offset||"fillColor",value:i.value,typeCode:e}),this._updateStyleTiles()},clearCustomStyle:function(){var e=t.styler.getRenderConfig(this.mapPackage);null!=e.views[this.styleViewName+"-origin"]&&(e.deleteView(this.styleViewName),e.duplicateView(this.styleViewName+"-origin",this.styleViewName),this._updateStyleTiles())},styleViewNames:function(){var e=[];for(var i in t.styler.mapRenderConfig[this.mapPackage].views)e.push(i);return i},setStyleView:function(e){var i=t.styler.mapRenderConfig[this.mapPackage].views[e];null!=i&&(this.styleViewName=e,this.viewId=i.index)}}),inherit(s,e,{request:function(e){t.dataPool.setRequestTiles(e)},send:function(t){t.img.crossOrigin="anonymous",t.img.src=this.getTileURL(t)},getTileURL:function(t){return""},tilegen:function(t,e,i){return{tx:t,ty:e,z:i,key:d(t,e,i)+"z"+this.name,img:!1,layer:this}},keygen:function(t,e,i){return d(t,e,i)+"z"+this.name}}),r.LayerRaster=s,r.LayerWMTS=n,inherit(n,s,{draw:function(t,e){for(var i=0,s=this.drawTiles.length;i<s;++i)this.rasterDraw(e,t,this.drawTiles[i])},getTileURL:function(t){return this.urlPattern.replace("%{svr}",t.svr).replace("%{z}",t.z).replace("%{x}",t.tx).replace("%{y}",t.ty)},transrange:function(t,e){var i=1<<e,s=u(t[0],t[2],e),n=u(t[1],t[3],e);return[Math.floor(s[0]),Math.ceil(n[0]),f(Math.floor(s[1]),0,i),f(Math.ceil(n[1]),0,i)]},seek:function(e,i,s,n){var a,r,o,h,l,c=new Set,u=[],f=1<<i,d=e[0],m=e[1],v=e[2],g=e[3],y=new Set;for(a=d;a<=m;++a)for(l=p(a,f),r=v;r<=g;++r)if(h=this.tilegen(l,r,i),o=t.dataPool.get(h.key),y.add(h.key),o)u.push(o),c.add(o.key);else{s.push(h);var w,x=l>>1,M=r>>1,_=i-1;w=this.keygen(x,M,_),c.has(w)||(o=t.dataPool.get(w))&&(u.push(o),c.add(w))}if(s.length>0){var k=d+m>>1,T=v+g>>1;s=s.sort(function(t,e){return Math.abs(e.tx-k)+Math.abs(e.ty-T)-Math.abs(t.tx-k)-Math.abs(t.ty-T)})}n||(this.drawTiles=u,this.shouldDraw=y)},rasterDraw:function(t,e,i){if(i.img){t.save();var s=e.initTransformR(t,i);i.img.crossOrigin="anonymous",t.drawImage(i.img,e.deltaX,e.deltaY,o,s),t.restore()}}}),inherit(a,s,{getTileURL:function(t){var e=c(t.tx,t.ty,t.z),i=c(t.tx+1,t.ty+1,t.z);return this.urlPattern.replace("%{svr}",t.svr).replace("%{lon}",e[0]).replace("%{LON}",i[0]).replace("%{lat}",i[1]).replace("%{LAT}",e[1])},draw:function(t,e){for(var i=0,s=this.drawTiles.length;i<s;++i)this.rasterDraw(e,t,this.drawTiles[i])},seek:i.prototype.seek,rasterDraw:function(t,e,i){i.img&&(t.save(),e.initTransform(t,i),i.img.crossOrigin="Anonymous",t.drawImage(i.img,0,0,o,o),t.restore())}}),r.LayerWMS=a}function tkDaemon(t,e,i,s){if(this&&this instanceof tkDaemon){if(arguments.length<2)throw new TypeError("tkDaemon - not enough arguments");t&&(this.owner=t),this.task=e,isFinite(i)&&i>0&&(this.rate=Math.floor(i)),s>0&&(this.length=Math.floor(s))}}function tssh(t,e){function i(t){this.dataPool=t,this.queue=[],this.proqueue=new Set}function s(){Extends(this,i,arguments),window.XMLHttpRequest||window.ActiveXObject?(this.XHR=!0,this.netWorking=!1):alert("Your browser does not support XMLHttpRequest.")}function n(){Extends(this,i,arguments),this.downloadCount=0,this.netWorking=0}var a=TMap.domain+"/perseus/webmap";i.prototype={setTaskQueue:function(t){},startQuery:function(){}},inherit(s,i,{loadData:function(t,i){var s=this;s.netWorking=!0,$.ajax({type:"POST",url:a,timeout:TMap.timeout,data:t,dataType:"json",success:function(t,n,a){if(t){if(t instanceof Array)for(var r in t)s.dataPool.setObject(t[r]);else t&&s.dataPool.setObject(t);i&&e()}},complete:function(t,e){s.netWorking=!1,"success"!=e&&console.log("fuck")}})},setTaskQueue:function(t){this.queue=t,this.netWorking||this.queue.length>0&&this.startQuery()},startQuery:function(){var e,i=[];this.proqueue.clear();for(var s=0;s<4&&this.queue.length>0;)e=this.queue.pop(),this.proqueue.has(e.key)||t.get(e.key)||(this.proqueue.add(e.key),i.push(e.key),++s);i.length?(i="at=wm&v=1&key="+i.join("-"),this.loadData(i,this.queue.needDraw)):this.netWorking=!1}}),inherit(n,i,{setTaskQueue:function(t){this.queue=t,this.netWorking<1&&this.queue.length>0&&this.startQuery()},startQuery:function(){for(var i=this.queue.pop();(t.get(i.key)||this.proqueue.has(i.key))&&this.queue.length>0;)i=this.queue.pop();if(!t.get(i.key)&&!this.proqueue.has(i.key)){++this.netWorking,this.proqueue.add(i.key);var s=this,n=this.queue.needDraw,a=new Image;a.onerror=function(){--s.netWorking},a.onload=function(){i.img.crossOrigin="anonymous",s.dataPool.setTile(i),s.proqueue.delete(i.key),s.queue.length,--s.netWorking,n&&e()},a.crossOrigin="anonymous",i.img=a,i.svr=this.downloadCount++%8,i.layer.send(i)}}}),t.tssh={gMsg:new s(t),grMsg:new n(t)}}var TMap=window.TMap={domain:"http://"+window.location.host,timeout:1e4,private:{}};null==Set.prototype.entries?Set.prototype.merge=function(t){if(t instanceof Set)for(var e in t)this.add(e)}:Set.prototype.merge=function(t){if(t instanceof Set){var e,i=t.entries();for(e=i.next();e.value;)this.add(e.value[0]),e=i.next()}},String.prototype.visualLength=function(t){var e=$("#tkm-text-ruler");return t&&e.css(t),e.text(this),e.width()},Date.prototype.format=function(t){var e={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S+":this.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var i in e)new RegExp("("+i+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[i]:("00"+e[i]).substr((""+e[i]).length)));return t},benchmark.prototype={begin:function(){this.tick=Date.now()},end:function(){var t=Date.now()-this.tick;t>this.maximum&&(this.maximum=t),this.elapse+=t,this.average=this.elapse/++this.count},reset:function(){this.count=0,this.elapse=0,this.average=0,this.maximum=0}},tkEventTarget.prototype={_addListener:function(t,e){var i=this._listeners[e];null==i&&(this._listeners[e]=i=[]),i.push({id:this._listeners._count,f:t})},addListener:function(t,e,i){if(null==this._listeners&&(this._listeners={}),null==this._listeners._count&&(this._listeners._count=0),++this._listeners._count,e instanceof Array)for(var s=0,n=e.length;s<n;++s)this._addListener(t,e[s]);else this._addListener(t,e);return i&&t(),this._listeners._count},removeListener:function(t){if(0!=t&&null!=this._listeners){var e=0;for(var i in this._listeners){var s=this._listeners[i],n=-1;if(s instanceof Array){for(var a=0,r=s.length;a<r;++a)if(s[a].id==t||s[a].f==t){e=s[a].id,n=a;break}n>=0&&s.splice(n,1)}}return e}},_notifyListener:function(t,e){var i=this._listeners[t];if(null!=i){null==e&&(e={}),null==e.target&&(e.target=this._listenerTargetGetter?this._listenerTargetGetter(this):this),null==e.type&&(e.type=t);for(var s,n=0;s=i[n++];)s.f(e)}},listenerNotify:function(t,e){if(null!=this._listeners)if(t instanceof Array)for(var i in t)this._notifyListener(t[i],e);else this._notifyListener(t,e)}},function(){TMap.Dataset=function(t,e){this.maxVal=20,this.frameCount=1;var i=this;i.data=e?e(t):t,this.get=function(){return{cur:0,next:function(){if(this.cur<i.data.length){var t={};if($.extend(t,i.data[this.cur++]),null==t.x){var e=i._owner.pointToPixel(t);t.x=e.x,t.y=e.y}return t}return null}}}},TMap.Dataset.prototype.get=function(){return null},TMap.Animater={},TMap.private.kanimate=function(t,e,i,s){function n(){!c||u||h.frameCount<1||(1==h.frameCount?a():(P||(P=setInterval(n,t.interval||125)),a(),b._animeIsNotPausedButPlaying&&++l>=h.frameCount&&(l=0),h.update&&h.update(l)))}function a(){if(h.drawing){var e=C[l];e?k.putImageData(e,0,0):(o(),h.render(l),C[l]=k.getImageData(0,0,b.width,b.height))}else o();t._notifyFrameCallback(l)}function r(){b._animeIsNotPausedButPlaying=!b._animeIsNotPausedButPlaying,b._animeIsNotPausedButPlaying?n():(clearInterval(P),P=null)}function o(){k.setTransform(1,0,0,1,0,0),k.clearRect(0,0,T.width,T.height)}var h,l,c,u,f,p,d,m,v,g,y,w,x,M,_=t._owner,k=t.context,T=_.mapMode,b={},C={},P=null;b.setTimer=function(t){0<=t&&t<h.frameCount&&(l=t)},b.show=function(){b._animeIsNotPausedButPlaying=!0,b.animating()},b.hide=function(t){b._animeIsNotPausedButPlaying=!1,t||setTimeout(o,35)},b.pause=r,b.stutter=function(){c&&(u=!0)},b.checkStutter=function(){c&&(u=!1,b._animeIsNotPausedButPlaying&&b.animating())},b.clear=o,b.listening=function(){v=23-T.z,f=T.mctX<<v,p=T.mctY<<v,d=T.width/2,m=T.height/2,b.width=T.width,b.height=T.height,g=T.scale/(1<<v),T.rotate&&(y=g*T.cos0,w=g*T.sin0,x=-w,M=y);var t=h.bbox;if(t){for(var e=T.calcRange(),s=0;s<4;++s)e[s]<<=v;t.xl>e[1]||t.xr<e[0]||t.yt>e[3]||t.yb<e[2]?h.drawing=!1:h.drawing=!0}b.DBox=e,b.dataset=i,C={},h.modeChange()},b.animating=n,b.initContext=function(t,e){if(T.rotate){var i=(e.x-f)*g,s=(e.y-p)*g,n=i*T.cos0-s*T.sin0+d,a=i*T.sin0+s*T.cos0+m;k.setTransform(y,w,x,M,n,a)}else{var i=(e.x-f)*g+d,s=(e.y-p)*g+m;k.setTransform(g,0,0,g,i,s)}},b.isInBBox=function(t,e){return this.DBox[0]<=t&&t<=this.DBox[1]&&this.DBox[2]<=e&&e<=this.DBox[3]},b.isRectIntersect=function(t){return!(this.DBox[1]<t[0]||this.DBox[0]>t[1]||this.DBox[2]>t[3]||this.DBox[3]<t[2])},b.mapMode=T,b.dataset=i,b.options=s,t.start=function(e){c=!0,u=!1,null==b.kaListener&&(b.kaListener=T.addListener(b.listening,["zoom","move","rotate","resize"],!0)),t.show(),e?(b._animeIsNotPausedButPlaying=!1,a()):(b._animeIsNotPausedButPlaying=!0,b.animating())},t.setTimer=function(t){0<=t&&t<h.frameCount&&(l=t,a())},t.getTimer=function(){return 1==h.frameCount?0:0==l?h.frameCount-1:l-1},t.getFrameCount=function(){return h.frameCount},t.pause=r,t.isPausing=function(){return b._animeIsNotPausedButPlaying},t.stop=b.hide,t.stutter=b.stutter,t.checkStutter=b.checkStutter,t.setTimerInterval=function(e){t.interval=e,clearInterval(P),P=null,b._animeIsNotPausedButPlaying&&n()},t.uninstall=function(){T.removeListener(b.kaListener),clearInterval(P),c=!1,u=!0,b._animeIsNotPausedButPlaying=!1,h.drawing=!1,C=null,h=null,b=null,delete t.getFrameCount,delete t.isPausing,delete t.setTimer,delete t.start,delete t.pause,delete t.stop,delete t.stutter,delete t.checkStutter,delete t.uninstall,delete t.setTimerInterval},l=0,c=!1,u=!0,b._animeIsNotPausedButPlaying=!1,b.context=k,b.sv=_.mapsv,h=new e(b),t.start(!0)},TMap.Animater.Voronoi=function(t){function e(t){t.textBaseline="top",t.fillText("平湖溃堤淹没点图例",0,0),t.translate(0,20);var e=t.createLinearGradient(0,200,0,0);e.addColorStop(0,"rgba(0,255,0,0)"),e.addColorStop(.25,"yellow"),e.addColorStop(.5,"blue"),e.addColorStop(.75,"red"),e.addColorStop(1,"black"),t.fillStyle=e,t.fillRect(0,0,20,200),t.strokeRect(0,0,20,200),t.beginPath();for(var i=0;i<5;++i)t.moveTo(20,50*i),t.lineTo(23,50*i);t.stroke(),t.closePath(),t.fillStyle="green",t.textBaseline="bottom",t.fillText("0米",25,200),t.fillStyle="yellow",t.textBaseline="middle",t.fillText("1米",25,150),t.fillStyle="blue",t.fillText("2米",25,100),t.fillStyle="red",t.fillText("3米",25,50),t.fillStyle="black",t.textBaseline="top",t.fillText("4米及以上",25,0)}function i(t){if(t<=0)return null;if(t>=5)return"#000";var e=(256*t/5|0)<<2,i=e<256?e/255:1;return"rgba("+o[e]+","+o[e+1]+","+o[e+2]+","+i+")"}function s(t,e){var i=Math.floor(e/c),s=e%c;if(s&&i<7){var n=t.data[i],a=t.data[i+1];return s/=c,n+(a-n)*s}return t.data[i]}function n(e){t.clear();for(var n=t.context,r=0;r<a;++r){var o=h[r],l=i(s(o,e));if(null!=l){var c=o.bound;t.initContext(n,o),n.beginPath(),n.moveTo(c[0],c[1]);for(var u=2,f=c.length;u<f;u+=2)n.lineTo(c[u],c[u+1]);n.fillStyle=l,n.fill(),n.closePath()}}}var a,r,o,h=[],l={},c=10;this.DBox=null,this.drawing=!0;this.modeChange=function(){var e=t.dataset;h=[];for(var i=0,s=e.length;i<s;++i){var n=e[i];n.bound&&t.isInBBox(n.x,n.y)&&h.push(n)}a=h.length,l={}},this.render=n,this.frameCount=80,this.bbox={xl:1795215321,xr:1797133859,yt:880059313,yb:881988333},this.update=function(t){r.css({left:2.5*t+"px"})},function(i){var s=$("<canvas>").attr({width:"150px",height:"220px"}).css({position:"absolute",left:"5px",top:"5px"}),n=$("<div>").attr({width:50,style:"position:absolute;left:55px;bottom:5px;background-color:rgb(246,172,22);"}).text("暂停").click(function(){t.pause(),"暂停"==n.text()?n.text("继续"):n.text("暂停")});e(s[0].getContext("2d"));var a=$("<div>").attr({class:"tkm-animate-control-panel"}).hide().append(s,n);i.append(a)}(t.sv),function(e){var i=$("<div>").attr({class:"tkm-animate-control-slider"}).hide().append($("<div>").attr({class:"tkm-animate-control-slot"}),r=$("<div>").attr({class:"tkm-animate-control-button"}));e.append(i);for(var s=0;s<=8;++s){var a=$("<div>").attr({class:"tkm-animate-control-slotmark"}).css({left:10+200*s/8+"px"});i.append(a)}$(function(){var e,i,s=r,a=!1,o=null;s.click(function(){}).mousedown(function(n){a=!0,i=n.pageX-parseInt(s.css("left")),e=t._animeIsNotPausedButPlaying,t._animeIsNotPausedButPlaying=!1}),$(document).mousemove(function(e){if(a){var r=e.pageX-i;r<0?r=0:r>194&&(r=194),s.css({left:r}),t.setTimer(79*r/194),o||(o=setTimeout(function(){o=null,n()},66))}}).mouseup(function(){a&&(a=!1,t._animeIsNotPausedButPlaying=e,e&&t.animating())})})}(t.sv),o=function(){var t=document.createElement("canvas");t.height=1,t.width=256;var e=t.getContext("2d"),i=e.createLinearGradient(0,0,256,0);return i.addColorStop(0,"green"),i.addColorStop(.25,"yellow"),i.addColorStop(.5,"blue"),i.addColorStop(.75,"red"),i.addColorStop(1,"black"),e.fillStyle=i,e.fillRect(0,0,256,1),e.getImageData(0,0,256,1).data}()},TMap.Animater.scatter=function(t){var e=t.dataset,i=t.options,s=new TMap.Drawer.scattermap(t,e,i);this.modeChange=function(){},this.render=function(t){e.sec=t,s.render()},this.frameCount=e.frameCount,this.bbox=[-1/0,1/0,-1/0,1/0],this.drawing=!0},TMap.Animater.heatmap=function(t){var e;this.DBox=null,this.drawing=!0,this.modeChange=function(){e=new TMap.Drawer.heatmap(t,t.dataset,t.options)},this.render=function(i){t.dataset.sec=i,e.render()},this.frameCount=t.dataset.frameCount}}(),function(){var t=Math.PI,e=Math.PI/2,i=2*Math.PI,s=4*Math.PI,n=t/180,a=180/t,r=0x3a052cf8639b6a,o=window.TMap.GeoUtils=window.TMap.GeoUtils||function(){};o.ll2mct=function(t,e,a){var r=256*(1<<a);return[(t+180)/360*r,(i-Math.log(2/(1-Math.sin(e*n))-1))/s*r]},o.mct2ll=function(t,e,n){var r=1/(256*(1<<n));return[360*t*r-180,Math.asin(1-2/(1+Math.exp(i-s*e*r)))*a]},o.t2ll=function(t,e,n){var r=1/(1<<n);return[360*t*r-180,Math.asin(1-2/(1+Math.exp(i-s*e*r)))*a]},o.mct2wmt=function(t,e,n){var r=1/(256*(1<<n)),o=360*t*r-180,h=Math.asin(1-2/(1+Math.exp(i-s*e*r)))*a;return r=(1<<n)/360,[(o+180)*r,(90-h)*r]},o.wmt2mct=function(t,e,a){var r=1<<a,o=360/r,h=256*r,l=t*o-180;if(l=(l+180)/360*h,0==e)return[l,0];if(e+e==r)return[l,r<<8];var c=90-e*o;return[l,(i-Math.log(2/(1-Math.sin(c*n))-1))/s*h]},o.fixrlon=function(e){return(e%i+t)%i-t},o.fixrlat=function(i){return(i%t+e)%t-e},o.fixlon=function(t){return(t%360+180)%360-180},o.fixlat=function(t){return(t%180+90)%180-90},o.morton=function(t,e){for(var i=0,s=0;t||e;)i|=(1&t)<<s++,t>>=1,i|=(1&e)<<s++,e>>=1;return i},o.makekey=function(t,e,i){for(var s,n,a,r=0,o=0;t||e;)r|=(1&t)<<o++,t>>=1,r|=(1&e)<<o++,e>>=1,o>29&&(s=(s=r%32^i).toString(32),n=r.toString(32),r=o=0);return a=r?r.toString(32):"",null==s&&(s=(s=r%32^i).toString(32)),null==n&&(n=r?"":"0"),s+a+n};o.clamp=function(t,e,i){return t<e&&(t=e),t>=i&&(t=i-1),t},o.cloop=function(t,e){return t<0&&(t+=e),t>=e&&(t-=e),t},o.TK_EARTH_RADIUS=6378137,o.rightCoordinateSystem=function(t,e){t*=n,e*=n;var i=R*Math.cos(t)*Math.cos(e),s=R*Math.sin(t)*Math.cos(e);return[i,-(R*Math.sin(e)),s]},o.nor_points=function(t,i,s,a){if(i==a){if(t==s)return null;if(0==i)return[0,e]}t*=n,i*=n,s*=n,a*=n;var o=Math.tan(i),h=Math.tan(a);if(-r<o&&o<r&&-r<h&&h<r){var l=h*Math.sin(t)-o*Math.sin(s),c=Math.atan((o*Math.cos(s)-h*Math.cos(t))/l),u=0!=o?-Math.cos(t-c)/o:-Math.cos(s-c)/h;return[c,Math.atan(u)]}return o==h?null:-r<o&&o<r?[s+e,0]:-r<h&&h<r?[t+e,0]:null},o.dis_point_curveseg=function(t,i,s,n,a,r){var h=o.nor_points(s,n,a,r),l=o.arc_points(t,i,h[0],h[1]);return 6378137*Math.abs(l-e)},o.arc_points=function(e,i,s,a){var r=e*n,o=i*n,h=s*n,l=a*n,c=Math.cos(o)*Math.cos(l)*Math.cos(r-h)+Math.sin(o)*Math.sin(l);return c>1?0:c<-1?t:(c=Math.acos(c))<0?c+t:c},o.dis_points=function(t,e){return 6378137*o.arc_points(t.lon,t.lat,e.lon,e.lat)},o.rect_intersect=function(t,e){var i=[];return i[0]=t[0]>e[0]?t[0]:e[0],i[1]=t[1]<e[1]?t[1]:e[1],i[2]=t[2]>e[2]?t[2]:e[2],i[3]=t[3]<e[3]?t[3]:e[3],i},o.is_rect_in_rect=function(t,e){return t[0]>=e[0]&&t[1]<=e[1]&&t[2]>=e[2]&&t[3]<=e[3]},o.rect_get_area=function(t){return(t[1]-t[0])*(t[3]-t[2])};var h=function(t,e){var i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)},l=function(t,e,i){var s=(i.x-e.x)*(t.x-e.x)+(i.y-e.y)*(t.y-e.y);if(s<=0)return h(e,t);var n=(i.x-e.x)*(i.x-e.x)+(i.y-e.y)*(i.y-e.y);if(s>=n)return h(i,t);var a=s/n,r=e.x+(i.x-e.x)*a,o=e.y+(i.y-e.y)*a;return Math.sqrt((r-t.x)*(r-t.x)+(o-t.y)*(o-t.y))},c=function(t,e,i,s){if(e.x==t.x&&e.y==t.y)return 1;if(i.x==t.x&&i.y==t.y)return 2;var n=l(t,e,i);return n>s?-1:0==n?3:0},u=function(t,e,i){for(var s=0,n=e.length-1;s<n;++s){var a=c(t,e[s],e[s+1],i);if(a>=0)return a}return-1},f=(o.point_in_line=function(t,e,i){for(var s=[],n=0,a=e.length;n<a;n+=2)s.push({x:e[n],y:e[n+1]});return u({x:t[0],y:t[1]},s,i)},function(t,e,i,s){return t*s-e*i}),p=function(t,e,i,s,n,a){var r,o,h,l,c;if(t[s].y>=t[n].y?(r=t[s].x,o=t[s].y,h=t[n].x,l=t[n].y):(r=t[n].x,o=t[n].y,h=t[s].x,l=t[s].y),i<l||o<i);else if(l<i&&i<o){if(h<e){if(r<e)a=!a;else if((c=f(e-h,i-l,r-e,o-i))>0)a=!a;else if(0==c)return 1}else if(r<=e)if((c=f(e-h,i-l,r-e,o-i))>0)a=!a;else if(0==c)return 1}else if(o==i)if(l==i){if(r<e&&e<h||h<e&&e<r)return 1;if(r==e||h==e)return 2}else{if(r==e)return 2;r<e&&(a=!a)}return[a]},d=function(t,e){var i,s=t.x,n=t.y,a=e.length,r=a-1,o=0;for(i=0;i<a;r=i++){var h=p(e,s,n,i,r,o);if(!(h instanceof Array))return h;o=h[0]}return o?0:-1};o.point_in_polygon=function(t,e){for(var i=[],s=0,n=e.length;s<n;s+=2)i.push({x:e[s],y:e[s+1]});return d({x:t[0],y:t[1]},i)};o.degreeToRad=function(t){return t*n},o.getDistance=function(t,e){return t instanceof TMap.Point&&e instanceof TMap.Point?o.dis_points(t,e):0},o.getPolygonArea=function(e){if(!(e instanceof TMap.Polygon||e instanceof Array))return 0;var i;if((i=e instanceof TMap.Polygon?e.lonlats:e).length<3)return 0;for(var s=0,a=0,r=0,o=0,h=0,l=0,c=0,u=0,f=0,p=0,d=0,m=0,v=0,g=0,y=0,w=0,x=0,M=0,_=0,k=0,T=0,b=0,C=0,P=0,A=0,S=0,z=0,D=0,L=0,I=0,O=0,B=0,E=i.length,V=0;V<E;V++)0==V?(s=i[E-1].lon*n,a=i[E-1].lat*n,r=i[0].lon*n,o=i[0].lat*n,h=i[1].lon*n,l=i[1].lat*n):V==E-1?(s=i[E-2].lon*n,a=i[E-2].lat*n,r=i[E-1].lon*n,o=i[E-1].lat*n,h=i[0].lon*n,l=i[0].lat*n):(s=i[V-1].lon*n,a=i[V-1].lat*n,r=i[V].lon*n,o=i[V].lat*n,h=i[V+1].lon*n,l=i[V+1].lat*n),c=Math.cos(o)*Math.cos(r),u=Math.cos(o)*Math.sin(r),f=Math.sin(o),p=Math.cos(a)*Math.cos(s),d=Math.cos(a)*Math.sin(s),m=Math.sin(a),z=((T=(x=(c*c+u*u+f*f)/(c*(v=Math.cos(l)*Math.cos(h))+u*(g=Math.cos(l)*Math.sin(h))+f*(y=Math.sin(l))))*v-c)*(M=(w=(c*c+u*u+f*f)/(c*p+u*d+f*m))*p-c)+(b=x*g-u)*(_=w*d-u)+(C=x*y-f)*(k=w*m-f))/(Math.sqrt(T*T+b*b+C*C)*Math.sqrt(M*M+_*_+k*k)),z=Math.acos(z),P=b*k-C*_,A=0-(T*k-C*M),S=T*_-b*M,(0!=c?P/c:0!=u?A/u:S/f)>0?(D+=z,O++):(L+=z,I++);var N,X;return N=D+(2*t*I-L),X=2*t*O-D+L,B=D>L?N-(E-2)*t<1?N:X:X-(E-2)*t<1?X:N,6378137*(B-(E-2)*t)*6378137}}(),function(){function t(t){this._owner=t,this._visible=!0;var e=document.createElement("canvas");e.style.cssText="position:absolute;background-color:rgba(0,0,0,0);z-index:"+t.canvases.length,t.mapsv.append(e),this.canvas=e,this.originImage={}}function e(){Extends(this,t,arguments),this.context=this.canvas.getContext("2d")}function i(){Extends(this,t,arguments),this.context=this.canvas.getContext("2d")}function s(){Extends(this,t,arguments),this.context=this.canvas.getContext("2d"),TMap.private.tkShiori(this,this._owner.mapMode,r)}function n(){Extends(this,t,arguments),this.context=this.canvas.getContext("2d")}var a=TMap.Canvas={},r=8;t.prototype={drawNew:function(){},snapView:function(){var t=this.context,e=this._owner.mapMode,i=1<<23-e.z;this.originImage=t.getImageData(0,0,e.width,e.height),this.originState={x:e.mctX*i,y:e.mctY*i,z:e.z,s:(1<<e.z)*e.scale/e.ratio,scale:e.scale,rotate:e.rotate}},drawSnap:function(){if(null!=this.originState){var t=this.context,e=this._owner.mapMode,i=this.originState;t.clearRect(0,0,e.width,e.height);var s=1<<23-e.z,n=e.mctX*s,a=e.mctY*s,r=(1<<e.z)*e.scale/e.ratio,o=i.s-r,h=i.x-n,l=i.y-a,c=(i.z,e.z,i.rotate-e.rotate);if(0==o&&0==c)if(h=(h>>23-i.z)*i.scale,l=(l>>23-i.z)*i.scale,e.rotate){var u=e.cos0*h-e.sin0*l,f=e.sin0*h+e.cos0*l;t.putImageData(this.originImage,u,f)}else t.putImageData(this.originImage,h,l);else if(o&&0==c){var p=r/i.s;if(h=h/(1<<23-e.z)*e.scale,l=l/(1<<23-e.z)*e.scale,h+=e.halfWidth*(1-p),l+=e.halfHeight*(1-p),e.rotate){var n=e.cos0*h-e.sin0*l,a=e.sin0*h+e.cos0*l,d=this.stretch(p);t.putImageData(d,n,a)}else p<1?t.putImageData(this._stretch(p),h,l):t.putImageData(this._stretchEx(p,h,l),0,0)}}},_stretch:function(t){for(var e,i=this._owner.mapMode,s=i.width,n=i.height,a=Math.ceil(t*s),r=Math.ceil(t*n),o=this.originImage.data,h=this.context.createImageData(a,r),l=4*s,c=4*a,u=1/t,f=0,p=0,d=0;f<r&&(e=0|d)<n;++f,p+=c,d+=u)for(var m,v=l*e,g=0,y=0;g<a&&(m=0|y)<s;++g,y+=u){var w=p+(g<<2),x=v+(m<<2);h.data[w]=o[x],h.data[w+1]=o[x+1],h.data[w+2]=o[x+2],h.data[w+3]=o[x+3]}return h},_stretchEx:function(t,e,i){var s=this._owner.mapMode,n=s.width,a=s.height,r=(Math.ceil(t*n),Math.ceil(t*a),this.originImage.data),o=this.context.createImageData(n,a),h=4*n,l=h,c=1/t;e*=-c;for(var u,f=0,p=0,d=i*=-c;f<a&&(u=0|d)<a;++f,p+=l,d+=c)if(!(u<0))for(var m,v=h*u,g=0,y=e;g<n&&(m=0|y)<n;++g,y+=c)if(!(m<0)){var w=p+(g<<2),x=v+(m<<2);o.data[w]=r[x],o.data[w+1]=r[x+1],o.data[w+2]=r[x+2],o.data[w+3]=r[x+3]}return o},clear:function(){var t=this.context,e=this.canvas;t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,e.width,e.height)},owner:function(){return this._owner},visible:function(){return this._visible},setVisible:function(t){t=!!t,this._visible!=t&&(this._visible=t,this.canvas.style.display=this._visible?"block":"none")},hide:function(){this.canvas.style.display="none",this._visible=!1},show:function(){this.canvas.style.display="block",this._visible=!0},toggle:function(){this._visible=!this._visible,this.canvas.style.display=this._visible?"block":"none"}},inherit(e,t,{drawNew:function(){this.drawLayers()},drawLayers:function(){var t=this._owner,e=this.context,i=t.mapMode;e.clearRect(0,0,i.width,i.height),e.save();for(var s,n=0,a=t.layers.length;n<a;++n)(s=t.layers[n]).visible&&s.draw(i,e);e.restore()}}),a.MapCanvasBasic=e,inherit(i,t,{drawNew:function(){var t=this._owner;t.overlays&&t.overlays.length?this.drawOverlay():this.needClear&&(this.needClear=!1,this.clearOverlay())},drawOverlay:function(){var t=this._owner,e=this.context,i=t.mapMode;e.clearRect(0,0,i.width,i.height),e.save(),i.initTransform(e,{z:i.z,tx:0,ty:0});for(var s,n=0,a=t.overlays.length;n<a;++n)null!=(s=t.overlays[n]).draw&&(e.save(),s.draw(e,i.z),e.restore()),this.needClear=!0;e.restore()},clearOverlay:function(){var t=this.context,e=this._owner.mapMode;t.clearRect(0,0,e.width,e.height)}}),a.MapCanvasOverlay=i,inherit(s,t,{drawNew:function(){this.labels=this.shiori(this.context)},highlightPOILabel:function(t){if(this.labels){var e=this._owner.mapMode,i=this.labels.grid.pointed(t),s=this.poiLabel,n=this.context;n.save(),n.lineCap=n.lineJoin="round",n.miterLimit=2,n.textBaseline="middle",n.setTransform(e.ratio,0,0,e.ratio,0,0),i?i.label&&i.label!=s&&(this.poiLabel=i.label,this.poiLabel.draw(),s&&s.draw()):(this.poiLabel=null,s&&s.draw()),n.restore()}}}),a.MapCanvasLabel=s,inherit(n,t,{drawNew:function(){},snapView:function(){this.stutter&&this.stutter(),t.prototype.snapView.apply(this)},clear:function(){var t=this._owner.mapMode;this.context.setTransform(1,0,0,1,0,0),this.context.clearRect(0,0,t.width,t.height)},setAnimation:function(t,e,i){this.clearAnimation(),e._owner=this._owner._map,TMap.private.kanimate(this,t,e,i)},clearAnimation:function(t){this.stop&&this.stop(t),this.uninstall&&this.uninstall()},addFrameCallback:function(t){if(t){if(null==this._animeCursorCB)this._animeCursorCB=[],this._animeCursorCB.top=0;else for(var e=0,i=this._animeCursorCB.length;e<i;++e)if(this._animeCursorCB[e].f==t)return this._animeCursorCB[e].id;return this._animeCursorCB.push({id:++this._animeCursorCB.top,f:t}),this._animeCursorCB.top}return null},removeFrameCallback:function(t){if(t&&this._animeCursorCB)for(var e=0,i=this._animeCursorCB.length;e<i;++e)if(this._animeCursorCB[e].id==t){this._animeCursorCB.splice(e,1);break}},_notifyFrameCallback:function(t){if(this._animeCursorCB)for(var e=0,i=this._animeCursorCB.length;e<i;++e)this._animeCursorCB[e].f(t)}}),a.MapCanvasDynamic=n,inherit(function(){Extends(this,t,arguments)},t,{drawNew:function(){},snapView:function(){},drawSnap:function(){}})}(),tkDaemon.prototype.owner=null,tkDaemon.prototype.task=null,tkDaemon.prototype.rate=100,tkDaemon.prototype.length=1/0,tkDaemon.prototype.SESSION=-1,tkDaemon.prototype.INDEX=0,tkDaemon.prototype.PAUSED=!0,tkDaemon.prototype.BACKW=!0,tkDaemon.forceCall=function(t){return t.INDEX+=t.BACKW?-1:1,!1!==t.task.call(t.owner,t.INDEX,t.length,t.BACKW)&&!t.isAtEnd()||(t.pause(),!1)},tkDaemon.prototype.isAtEnd=function(){return this.BACKW?isFinite(this.length)&&this.INDEX<1:this.INDEX+1>this.length},tkDaemon.prototype.synchronize=function(){this.PAUSED||(clearInterval(this.SESSION),this.SESSION=setInterval(tkDaemon.forceCall,this.rate,this))},tkDaemon.prototype.pause=function(){clearInterval(this.SESSION),this.PAUSED=!0},tkDaemon.prototype.start=function(t){var e=Boolean(t);(this.BACKW!==e||!this.isAtEnd()&&this.PAUSED)&&(this.BACKW=e,this.PAUSED=!1,this.synchronize())},function(){function t(t){this.mapRenderConfig={},this.maplist=["horae"],this.engine=t;for(var e in this.maplist)this.fillConfig(this.maplist[e])}function e(t,e){var i=t.boldGeo;return i==e?1:i[o]==e[o]&&i.k==e.k&&(e[n]&&i[n]==e[n]||!e[n]&&i[r]==e[r])?1:0}function i(t,e,i,s,r,o,h){var l=s.v[e];if(null!=l){var c=o.renders[l.r];if(null!=c&&i==c.t&&(this.subtype=h,this.lv=r.z,this.cid=r.c,this.name=t[n],this.extend(c.style),this.override(c.overrides),this.extend(s.d),this.override(s.o),this.extend(l.defaults),this.override(l.overrides),this.m<=this.lv&&this.lv<=this.M)){if(delete this.m,delete this.M,"0"==i){if(this.t=0,this.r=this.name,this.i>=0)this.imgInfo=o.iconConfig[2][this.i];else if(!this.r)return}else if("2"==i)this.t=2;else if("1"==i)this.t=1;else{if("3"!=i)return;this.t=3}delete this.name,this.a=t[a],this.a.geo=t}}}function s(t,e){this.mapPack=e,this.views=t.vs,this.renders=t.rs,this.outlineConfig=t.oc,this.regionConfig=t.rc,this.iconConfig=t.ic,this._viewsPrepare(),this._rendersPrepare(),this._regionConfigPrepare(),this._outlineConfigPrepare(),this._iconConfigPrepare()}var n=3,a=2,r=1,o=0,h={Points:"a",Type:"t",Text:"r",fillColor:"f",strokeColor:"s",lineDash:"d",lineWidth:"l",strokeWidth:"w",iconId:"i",iconStyle:"j",fontSize:"n",font:"o",pattern:"p",zIndex:"z"},l=TMap.Styler={};t.prototype={styling:function(t,e,s){if(null!=t&&null!=t.d){var n,a,r,h=t.d,l=e.styleViewName,c=e.mapPackage,u=this.mapRenderConfig[c],f=s>=8?u.regionConfig:u.outlineConfig,p=[],d=[],m=u.views[l],v={key:e.keygen(t.tx,t.ty,s),okey:t.key,c:t.c,m:t.m,v:l,z:t.z,tx:t.tx,ty:t.ty,g:p,l:d};if(m.f&&(v.f=m.f),m.s&&(v.s=m.s),!h._prestyle){for(a in h)for(var g=0,y=(T=h[a]).length;g<y;++g)T[g].k=a;h._prestyle=1}for(var w in h){var x,M,_=w.split("x");if(x=_[1],M=_[2],""==x&&(x="0"),""==M?M=0:(M=parseInt(M,32))>127&&(M-=256),!e.checkFilter(x)){n=e.bolds[x];var k,T=h[w],b=f[x];if(null!=b)for(var C,g=0,y=T.length;g<y;++g)if(C=T[g],null!=(k=b[C[o]]))for(var P in k){var A=new i(C,l,P,r=k[P],t,u,M);null!=A.a&&(n&&$.extend(A,n),A.t?p.push(A):d.push(A))}}}if(d.length&&(v.l=d.sort(function(t,e){return t.z-e.z})),p.length){p=p.sort(i.comparator);for(var S,z,D={},L=new Set,I=p[0],O=1,B=p.length;O<=B;++O)z=p[O],I.absorb(z)||(null==(S=D[I.z])&&(D[I.z]=S=[],L.add(I.z)),S.push(I),delete I._absorbed,I=z);v.g=D,v.zIndexKeys=L}return v}},getRenderConfig:function(t){return this.mapRenderConfig[t]},filtBoldFeature:function(t,i){for(var s=null,n=0,a=i.length;n<a;++n){var r,o,h=i[n];if(null!=h.g)for(var l in h.g)for(var c=0,u=(r=h.g[l]).length;c<u;++c)for(var f,p=0,d=(o=r[c]).a.length;p<d;++p)e(t,(f=o.a[p]).geo)&&(null==s&&(s=[],$.extend(s,o),delete s.a,delete s.z,s.f="red"),s.push([h,f]))}return s},fillConfig:function(t){var e=this.mapRenderConfig,i=this.engine;$.ajax({type:"POST",url:TMap.domain+"/perseus/webmap",timeout:TMap.timeout,data:"at=es&key="+t,dataType:"json",success:function(n,a,r){for(var o,h,l=e[t]=new s(n,t),c=0,u=i.mapViews.length;c<u;++c)(o=(h=i.mapViews[c]).basicLayer).mapPackage==t&&o.setStyleView(l.defaultView),h.mapMode.listenerNotify("ready")},complete:function(t,e){"success"!=e&&console.log("render_config failed")}})}},l.tkStyler=t,i.comparator=function(t,e){return t.z-e.z},i.prototype={hash:function(){return null==this.hashValue&&(this.hashValue=this.f+","+this.s+","+this.l+","+this.w+","+this.d+","+this.p),this.hashValue},extend:function(t){if(null!=t)for(var e,i="Mmfslwijnozdrp",s=0,n=i.length;s<n;++s)null!=t[e=i.substr(s,1)]&&(this[e]=t[e])},override:function(t){if(null!=t)for(var e,i,s=0,n=t.length;s<n;++s){e=t[s],i=!0;for(var a in e.cond)if(e.cond[a]!=this[a]){i=!1;break}if(i){for(var r in e.value)this[r]=e.value[r];break}}},absorb:function(t){if(null==this._absorbed){if(3==this.t){e=this.a.geo;this.a.forEach(function(t){t.geo=e}),delete this.a.geo}else this.a=[this.a];this._absorbed=!0}if(t&&this.equal(t)){if(3==this.t){var e=t.a.geo;this.a=t.a.reduce(function(t,i){return t.push(i),i.geo=e,t},this.a)}else this.a.push(t.a);return!0}return!1},equal:function(t){return this.t==t.t&&this.f==t.f&&this.s==t.s&&this.l==t.l&&this.w==t.w&&this.i==t.i&&this.j==t.j&&this.n==t.n&&this.o==t.o&&this.d==t.d&&this.p==t.p},depoly:function(){}},s._duplicateView=function(t,e,i){s._foreachView(t,e,function(t){t[i]={},$.extend(t[i],t[e]);for(var s in t[i])if(t[i][s]instanceof Object){var n={};$.extend(n,t[i][s]),t[i][s]=n}return!1})},s._deleteView=function(t,e){s._foreachView(t,e,function(t){return delete t[e],!1})},s._foreachView=function(t,e,i){var s,n,a,r,o,h;for(s in t){r=t[s];for(n in r){o=r[n];for(a in o)if((h=o[a])&&h.v&&null!=h.v[e]&&i(h.v))return}}},s._setStyle=function(t,e,i){if(null!=(t=t[e]))for(var s in t){var n=t[s];for(var a in n){var r=n[a].v[i.view];r&&(null==r.defaults&&(r.defaults={}),r.defaults[h[i.offset]]=i.value)}}},s.prototype={setStyle:function(t){if(null!=t)if(t instanceof Array)for(var e in t)this.setStyle(t[e]);else{var i;if(null==(i=t.outline?this.outlineConfig:this.regionConfig))return;var n=t.typeCode;if(n instanceof Array)for(var a in n)s._setStyle(i,n[a],t);else s._setStyle(i,n,t)}},duplicateView:function(t,e){var i=this.views[t],n=this.views[e];null!=i&&null==n&&(this.views[e]=n={},$.extend(n,i),s._duplicateView(this.regionConfig,t,e),s._duplicateView(this.outlineConfig,t,e))},deleteView:function(t){null!=this.views[t]&&(delete this.views[t],s._deleteView(this.regionConfig,t),s._deleteView(this.outlineConfig,t))},_viewsPrepare:function(){var t,e,i,s=0;for(t in this.views)null==i&&(i=t),(e=this.views[t]).data&&delete e.data,e.index=s++;this.defaultView=i},_rendersPrepare:function(){var t,e;for(var i in this.renders)t=this.renders[i],e=this._overrideMake(t[2]),this.renders[i]={t:t[0],style:t[1]},e&&(this.renders[i].overrides=e)},_overrideMake:function(t){if(t instanceof Array)for(var e,i=0,s=t.length;i<s;++i)e=t[i],t[i]={cond:e[0],value:e[1]};return t},_regionConfigPrepare:function(){this._datasetConfigPrepare(this.regionConfig)},_outlineConfigPrepare:function(){this._datasetConfigPrepare(this.outlineConfig)},_iconConfigPrepare:function(){var t,e,i,s,n,a,r={};for(t in this.iconConfig){e=this.iconConfig[t],r[t]=a={};for(i in e)6==(s=e[i]).length?a[i]={x:s[0],y:s[1],w:s[2],h:s[3],iw:s[4],ih:s[5],t:0}:a[i]={x:s[0],y:s[1],w:s[2],h:s[3],t:9};a.img=n=new Image,n.father=a,n.crossOrigin="anonymous",n.onload=function(){var t=this.father;for(var e in t)t[e].img=this;delete this.father},n.src=TMap.domain+"/perseus/webres?rs=icon&key="+this.mapPack+"@"+t}this.iconConfig=r},_datasetConfigPrepare:function(t){var e,i,s,n,a,r,o,h,l,c;for(e in t){i=t[e],a={};for(s in i){for(r={},h=0,l=(n=i[s]).length;h<l;++h){o={},(c=n[h])[1]&&(o.d=c[1]),c[2]&&(o.o=c[2]),c[3]&&(o.v=c[3]);for(var u in o.v)o.v[u].override&&(o.v[u].overrides=this._overrideMake(o.v[u].override),delete o.v[u].override);r[c[0]]=o}a[s]=r}$.extend(i,a)}}}}(),function(){function t(t){if(!v){v=this,t=t||{},this.bbox=t.bbox,this.pullEngineConfig(),this.mapViews=[],this.ratio=2,this.dataPool=new a,this.styler=new TMap.Styler.tkStyler(this),tkLayer(this);var e=this.bbox;this.layerMgr={horae:factoryWrap(TMap.Layer.LayerVector,function(t){t.name="horae",t.lonlatBox=e}),satellite:factoryWrap(TMap.Layer.LayerWMTS,function(t){t.name="satellite",t.lonlatBox=e,t.urlPattern=TMap.domain+"/perseus/cors?url=http://t%{svr}.tianditu.cn/img_c/wmts?service=wmts&style=default&format=tiles&request=GetTile&version=1.0.0&LAYER=img&tileMatrixSet=c&TileMatrix=%{z}&TileRow=%{y}&TileCol=%{x}",t.visible=!1})},t.layerFactories&&$.extend(this.layerMgr,t.layerFactories);var i=document.createElement("pre");i.id="tkm-text-ruler",document.body.appendChild(i)}}function e(t){if($.extend(this,t),this.mode=0,this.container==document.body&&(this.fullScreen=!0),this.fullScreen)this.width=window.innerWidth,this.height=window.innerHeight;else{var e=$(this.container);this.width=$(e).width(),this.height=$(e).height()}if(r(this),this.mapMode=new i(this.width,this.height,v.ratio),this.mapMode.view=this,this.mapMode._listenerTargetGetter=function(t){return t.view._map},t.center)this.mapMode.lon=t.center.lon,this.mapMode.lat=t.center.lat;else if(v.cityConfig){var s=v.cityConfig.city[1];s&&(this.mapMode.lon=s.lon,this.mapMode.lat=s.lat,this.mapMode.z=s.zoom)}this.layers=(this.layers||["satellite","horae"]).map(function(t){return v.layerMgr[t]()});var n=this.basicLayer=this.getLayer("horae");this.imageLayer=this.getLayer("satellite");var a=v.styler.mapRenderConfig[n.mapPackage];a&&n.setStyleView(t.defaultView||a.defaultView),this.overlays=[],this.markers=[];var l="<div>",c=$(l).addClass("tkm-map-mainview");this.mapsv=c,this.container.appendChild(c[0]);var f,p=this;if(this.canvases=[],this.canvases.push(new TMap.Canvas.MapCanvasBasic(this)),this.noDynamicShow||(this.dynamicCanvas=new TMap.Canvas.MapCanvasDynamic(this),this.canvases.push(this.dynamicCanvas),this.dynamicCanvas.hide(),this.mapMode.addListener(function(t){p.dynamicCanvas.stutter&&p.dynamicCanvas.stutter()},["move","zoom","rotate"]),this.mapMode.addListener(function(t){p.dynamicCanvas.checkStutter&&p.dynamicCanvas.checkStutter()},["moveend","zoomend","rotateend"])),this.labelCanvas=new TMap.Canvas.MapCanvasLabel(this),this.canvases.push(this.labelCanvas),this.overlayCanvas=new TMap.Canvas.MapCanvasOverlay(this),this.canvases.push(this.overlayCanvas),this.annotationCanvas=new TMap.Canvas.MapCanvasOverlay(this),this.canvases.push(this.annotationCanvas),this.annotationCanvas.hide(),this.resizeCanvases(),!this.noZoomButtons){var d=$(l).addClass("tkm-button-zooms");c.append(d),d.append($(l).addClass("tkm-button-zoomin").click(function(){p.zoomIn()}),$(l).addClass("tkm-button-zoomout").click(function(){p.zoomOut()}))}f=$(l).addClass("tkm-locmark"),c.append(f),this.locationMark=f[0],f=$(l).addClass("tkm-button-locate").click(function(t){p.moveToLocation()}),c.append(f),f=$(l).addClass("tkm-button-compass").click(function(){p.rotateNorth()}),c.append(f),this.compassView=f[0],this.mapMode.addListener(function(){p.compassView.style.transform="rotate("+this.rotate*_+"deg)"},"rotate"),this._scrollWheelZooming=!0;this.mapMode;f=$(l).addClass("tkm-logo"),c.append(f),f=$(l).addClass("tkm-scale").append($("<center>").append(this.scaleText=$(l).addClass("tkm-scale-text")),$(l).addClass("tkm-scale-line")),c.append(f),this.scaleView=f[0],this.scaleText=this.scaleText[0],o(c,this),h(c,this),u(this),v.mapViews.push(this),this.mapMode.fixToLonlat(),this.mapMode.listenerNotify("init"),this.queryDatasource(),this.lastDrawTick=0,this.daemon=new tkDaemon(this,this.dataDaemon,100),this.daemon.start(!0),this.benchmark=new benchmark}function i(t,e,i){this.z=14,this.maxZ=18,this.minZ=4,this.lat=39.904156,this.lon=116.39777,this.locateLon=116.30542,this.locateLat=40.052443,this.scale=i,this.ratio=i,this.x=0,this.y=0,this.mctX=0,this.mctY=0,this.tileX=0,this.tileY=0,this.deltaX=0,this.deltaY=0,this.rotate=0,this.cos0=1,this.sin0=0,this.bbox=null,this.projection="Mercator",this.mctUpper=1<<this.z+8,this.width=t*i,this.height=e*i,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.radius=Math.sqrt(this.width*this.width+this.height*this.height)/2;var s=this;this.addListener(function(){s._moving=!1},"moveend"),this.addListener(function(){s._zooming=!1},"zoomend"),this.addListener(function(){s._rotating=!1},"rotateend")}function s(t){this.capacity=t||256,this.cache={},this.size=0,this.header={},this.header.next=this.header,this.header.prev=this.header}function n(){for(var t=v.mapViews,e=t.length-1;e>=0;--e)t[e].refreshMap()}function a(){this.cache=new s(900),this.scache=new s(900),tssh(this,n)}function r(t){var e=function(){t.fitContainerSize()};window.addEventListener("resize",function(){t.resizeTimeout||(t.resizeTimeout=setTimeout(function(){t.resizeTimeout=null,e()},66))})}function o(t,e){var i={touching:!1,ox:0,oy:0,nx:0,ny:0,lx:0,ly:0},s=null;t.on("touchstart",function(){i.lx=event.targetTouches[0].pageX,i.ly=event.targetTouches[0].pageY,i.nx=i.lx,i.ny=i.ly,event.targetTouches>1&&(i.num=2),e.onDrawFrame(0),s=setInterval(function(){i.button&&(e.onDrawFrame(),e.onDrawFrame(0))},250)}),t.on("touchmove",function(){event.preventDefault(),i.nx=event.targetTouches[0].pageX,i.ny=event.targetTouches[0].pageY,e.mapMode.moveDelta(i.nx-i.lx,i.ny-i.ly),e.onDrawFrame(1),i.lx=i.nx,i.ly=i.ny}),t.on("touchend",function(){clearInterval(s)})}function h(t,e){var i={x:0,y:0,lx:0,ly:0,tick:0,button:0,dragMove:!1},s=null;t.mousedown(function(t){"canvas"==t.target.tagName.toLowerCase()&&(i.x=i.lx=t.offsetX,i.y=i.ly=t.offsetY,i.button=1,i.tick=Date.now(),e.onDrawFrame(0),e.geoPicker?e.geoPicker.mousedown_proc&&e.geoPicker.mousedown_proc(i):s=setInterval(function(){i.button&&(e.onDrawFrame(),e.onDrawFrame(0))},250))});var n;t.mouseup(n=function(t){var n=Date.now()-i.tick;if(i.button=0,i.tick=0,e.dragging=!1,clearInterval(s),s=null,e.geoPicker){if(e.geoPicker.mouseup_proc&&e.geoPicker.mouseup_proc(i),e.geoPicker&&e.geoPicker.click_proc&&n<=400&&"canvas"==t.target.tagName.toLowerCase()){a=e.mapMode.lonlatAtPoint(i.x,i.y);e.geoPicker.click_proc(a)}}else{if(n<=400&&"canvas"==t.target.tagName.toLowerCase()){var a=e.mapMode.lonlatAtPoint(i.x,i.y);e.onClick(a)}i.dragMove&&(i.dragMove=!1,e.mapMode.listenerNotify("moveend")),e.onDrawFrame()}}),t.mouseout(function(t){null==e.geoPicker&&(i.button=0,e.dragging=!1,e.onDrawFrame())}),t.mousemove(function(t){i.lx=i.x,i.ly=i.y,i.x=t.offsetX,i.y=t.offsetY,e.geoPicker?e.geoPicker.mousemove_proc&&e.geoPicker.mousemove_proc(i):t.buttons?i.button&&(e.mapMode.moveDelta(i.x-i.lx,i.y-i.ly),e.dragging=!0,e.onDrawFrame(1),i.dragMove=!0):(i.button&&n(t),e.labelCanvas.highlightPOILabel(i))});var a={delay:0,handle:null,delta:0,type:null},r=function(t){if("canvas"==t.target.tagName.toLowerCase()){var i=Date.now(),s=t||window.event,n=s.wheelDelta||-150*s.detail;a.delta+=n,s.ctrlKey&&(s.returnValue=!1),null==a.handle?(s.altKey&&e.scrollWheelZoom?a.type="rotate":!s.altKey&&e._scrollWheelZooming&&(a.type="zoom"),a.type&&(e.daemon.pause(),e.lastDrawTick=0,e.onDrawFrame(),e.onDrawFrame(0))):clearTimeout(a.handle),a.handle=setTimeout(o,200);var r=z.edge?8:1;if(i-a.delay>e.benchmark.average*r&&(a.delay=i,a.delta)){var h=a.delta>0?1:-1;a.delta=h*Math.log(h*a.delta)/10,"rotate"==a.type?e.mapMode.rotateDelta(a.delta):"zoom"==a.type&&e.mapMode.zoomDelta(a.delta,c(s,e.mapsv[0])),a.type&&(e.onDrawFrame(1),e.queryDatasource()),a.delta=0}}},o=function(){a.handle=null,e.daemon.start(!0),a.delta=0,e.onDrawFrame(),e.onDrawFrame(0),a.type&&(e.mapMode.listenerNotify(a.type+"end"),a.type=null)};document.addEventListener&&document.addEventListener("DOMMouseScroll",r,!1),window.onmousewheel=document.onmousewheel=r}function l(t){for(var e={x:t.offsetLeft,y:t.offsetTop},i=t.offsetParent;i!=document.body&&i;)e.x+=i.offsetLeft,e.y+=i.offsetTop,i=i.offsetParent;return e}function c(t,e){for(var i={x:t.pageX,y:t.pageY},s=e.offsetLeft,n=e.offsetTop,a=e.offsetParent;a!=document.body&&a;)s+=a.offsetLeft,n+=a.offsetTop,a=a.offsetParent;return i.x-=s,i.y-=n,i}function u(t){if(navigator.geolocation){navigator.geolocation.watchPosition(function(e){t.locationMark.style.display="block",t.mapMode.locateLat=e.coords.latitude,t.mapMode.locateLon=e.coords.longitude},function(e){t.locationMark.style.display="none"})}}function f(t){var e=Math.floor(t),i=e+"°",s=60*(t-e);return e=Math.floor(s),s-=e,i+=e+"'",i+=Math.floor(600*s)/10+'"'}function p(t){return t>=1e6?(t/1e6).toFixed(2)+"平方千米":t.toFixed(2)+"平方米"}function d(t){return t>=1e3?(t/1e3).toFixed(2)+"千米":t.toFixed(2)+"米"}function m(t,e,i){this.points=[],this.Map=t,this.type=i,this.view=e,null==i&&(i="free"),this.mousedown_proc=m["mdp_"+i],this.mousemove_proc=m["mmp_"+i],this.mouseup_proc=m["mup_"+i],this.exit_proc=m["ep_"+i],this.rate=this.view.mapMode.ratio,this.view.annotationCanvas.context.setTransform(this.rate,0,0,this.rate,0,0),this.view.annotationCanvas.show()}var v,g=[2e7,1e7,5e6,2e6,1e6,5e5,2e5,1e5,5e4,25e3,1e4,5e3,2e3,1e3,500,200,100,50,25,10,5,2.5],y=g.map(function(t){return t>=1e3?t/1e3+"千米":t+"米"}),w=Math.PI,x=(Math.PI,2*Math.PI),M=(Math.PI,w/180),_=180/w,k=Math.log(2),T=6378137*x,b=TMap.GeoUtils,C=b.ll2mct,P=b.mct2ll,A=b.wmt2mct,S=b.rect_intersect,z=new tkEnvironment,D=z.microsoft?2:5;t.prototype={pullEngineConfig:function(){var t=$.ajax({type:"POST",url:TMap.domain+"/perseus/webmap",timeout:TMap.timeout,data:"at=cz",async:!1,dataType:"json"}).responseJSON;if(t&&(null==this.bbox&&(this.bbox=t.bbox),t.city)){var e=t.city,i={},s={count:0};for(var n in e)e[n].length>2&&(i[n]={name:e[n][0],parent:e[n][1],lon:e[n][2],lat:e[n][3],zoom:e[n][4]},null==s[i[n].parent]&&(s.count++,s[i[n].parent]=n));this.cityConfig={city:i,province:s}}}},e.prototype={dataDaemon:function(){this.queryDatasource()},onDrawFrame:function(t){this.benchmark.begin();var e=Date.now();if(void 0===t)e-this.lastDrawTick>this.benchmark.average&&(this.canvasesForEach("drawNew"),this.lastDrawTick=e);else{if(0==t)return void this.canvasesForEach("snapView");1==t&&this.canvasesForEach("drawSnap")}var i=this.mapMode,s=i.pointAtLonlat(i.locateLon,i.locateLat);this.locationMark.style.left=s[0]-8+"px",this.locationMark.style.top=s[1]-8+"px",this.scaleView.style.width=i.lengthInScreen(g[i.z])+"px",this.scaleText.innerHTML=y[i.z],this.debugInfo&&(this.debugInfo.innerHTML=i.lon+","+i.lat+"<br>"+f(i.lon)+","+f(i.lat)+"@ "+i.z+"<br>"+i.mctX+","+i.mctY+"<br>"+s[0]+","+s[1]),this.benchmark.end()},onClick:function(t){if(this.funcClickPoint&&this.funcClickPoint(t),this.clickProcs&&this.clickProcs.length)for(var e=new TMap.Point(t),i=0,s=this.clickProcs.length;i<s;++i)this.clickProcs[i](e)},toggleMeasureMode:function(t){var e=1==t?TMap.Map.func_press_for_measure:TMap.Map.func_press_for_measure_area;this.funcClickPoint&&this.funcClickPoint(null),this.mode==t?(this.mode=0,this.funcClickPoint=null):(this.mode=t,this.funcClickPoint=e)},togglePickPin:function(){this.funcClickPoint&&this.funcClickPoint(null),3==this.mode?(this.mode=0,this.funcClickPoint=null):(this.mode=3,this.funcClickPoint=TMap.Map.func_press_for_pin_mark)},toggleQueryMode:function(){this.funcClickPoint&&this.funcClickPoint(null),4==this.mode?(this.mode=0,this.funcClickPoint=null):(this.mode=4,this.funcClickPoint=TMap.Map.func_press_for_query)},canvasesForEach:function(t){for(var e=0,i=this.canvases.length;e<i;++e){var s=this.canvases[e];s.visible()&&s[t]()}},refreshMap:function(){this.animation||(this.queryDatasource(),this.lastDrawTick=0,this.onDrawFrame())},refreshMapForTiles:function(t){if(!this.animation){this.queryDatasource();for(var e=0,i=t.length;e<i;++e);}},queryDatasource:function(){for(var t=this.mapMode.bboxRange(),e=this.mapMode.z,i=!0,s=0,n=this.layers.length;s<n;++s){o=[];if(((h=this.layers[s]).visible||h==this.basicLayer)&&h.minZ<=e&&e<=h.maxZ){var a=h.transrange(t,e),r=h.bbox(e);a=S(a,r);h.seek(a,e,o,!1);o.length>0&&(o.needDraw=!0,i=!1,h.request(o))}}if(i){this.mapMode.listenerNotify("tileready");var o=[],h=this.basicLayer,l=t[1]-t[0],c=t[3]-t[2];t[0]-=l,t[1]+=l,t[2]-=c,t[3]+=c;var a=h.transrange(t,e),r=h.bbox(e);a=S(a,r),h.seek(a,e,o,!0),e>this.mapMode.minZ&&(--e,l/=2,c/=2,t[0]-=l,t[1]+=l,t[2]-=c,t[3]+=c,t[0]>>=1,t[1]>>=1,t[2]>>=1,t[3]>>=1,a=h.transrange(t,e),r=h.bbox(e),a=S(a,r),h.seek(a,e,o,!0)),o.length>0&&h.request(o)}},zoomIn:function(){var t=this;this.startAnimation(function(){t.mapMode.zoomDelta(.2)},function(){t.mapMode.listenerNotify("zoomend")})},zoomOut:function(){var t=this;this.startAnimation(function(){t.mapMode.zoomDelta(-.2)},function(){t.mapMode.listenerNotify("zoomend")})},moveToLocation:function(){if(void 0==this.mapMode.locateLon)alert("暂未获得定位信息");else{var t=this;this.startAnimation(function(){var e=t.mapMode,i=e.pointAtLonlat(e.locateLon,e.locateLat),s=t.width/2-i[0],n=t.height/2-i[1];e.moveDelta(s/2,n/2)},function(){var e=t.mapMode,i=e.pointAtLonlat(e.locateLon,e.locateLat),s=t.width/2-i[0],n=t.height/2-i[1];e.moveDelta(s,n),t.mapMode.listenerNotify("moveend")})}},rotateNorth:function(){var t=this;this.startAnimation(function(){var e=w>t.mapMode.rotate?0:w;t.mapMode.rotateDelta(e-t.mapMode.rotate/2)},function(){t.mapMode.rotateDelta(-t.mapMode.rotate)})},startAnimation:function(t,e){if(!this.animation){var i=this;this.onDrawFrame(0),this.animationCnt=D,this.animation=setInterval(function(){var s=i;--s.animationCnt?(t(),s.onDrawFrame(1)):(t(),e&&e(),clearInterval(s.animation),s.animation=null,s.onDrawFrame())},66)}},featureAtPoint:function(t){var e,i,s,n,a=t.x,r=t.y,o=this.mapMode.z;a=(t=this.mapMode.mercatorAtPoint(a,r))[0]>>8,r=t[1]>>8,s=t[0]%256,n=t[1]%256;for(var h,l=this.layers.length-1;l>=0;--l)if((h=this.layers[l])instanceof TMap.Layer.LayerVector){if(h.boldGeo=null,e=h.keygen(a,r,o),null==(i=v.dataPool.get(e))||null==i.zIndexKeys)continue;for(var c=Array.from(i.zIndexKeys).sort(function(t,e){return e-t}),u=0,f=c.length;u<f;++u)for(var p,d=i.g[c[u]],m=0,g=d.length;m<g;++m){var y,w=(p=d[m]).l+2*p.w;if(1==p.t)y=b.point_in_line;else{if(2!=p.t)continue;y=b.point_in_polygon}for(var x=0,M=p.a.length;x<M;++x)if(y([s,n],p.a[x],w)>=0)return h.boldGeo=p.a[x].geo,p.a[x].geo}}},clearBoldFeature:function(){for(var t,e=this.layers.length-1;e>=0;--e)(t=this.layers[e])instanceof TMap.Layer.LayerVector&&(t.boldGeo=null)},resizeCanvases:function(){for(var t=0,e=this.canvases.length;t<e;++t)!function(t,e){e.width=t.width,e.height=t.height,e.style.width=t.width/t.ratio+"px",e.style.height=t.height/t.ratio+"px"}(this.mapMode,this.canvases[t].canvas)},getBounds:function(){var t=this.mapMode.bboxRange();return[P(t[0],t[3],this.mapMode.z),P(t[1],t[2],this.mapMode.z)]},pointAtLonlat:function(t,e){return this.mapMode.pointAtLonlat(t,e)},resize:function(t,e){var i=this.mapMode;this.width=t,this.height=e;var s=i.mercatorAtPoint(t/2,e/2);i.mctX=s[0],i.mctY=s[1],i.width=t*i.ratio,i.height=e*i.ratio,i.halfWidth=i.width/2,i.halfHeight=i.height/2,i.radius=Math.sqrt(i.width*i.width+i.height*i.height)/2,i.fixToMercator(),i.listenerNotify("resize"),this.resizeCanvases(),this.queryDatasource(),this.refreshMap()},fitContainerSize:function(){if(this.fullScreen)this.resize(window.innerWidth,window.innerHeight);else{var t=$(this.container);this.resize(t.width(),t.height())}},viewStyleChange:function(t){this.basicLayer.styleViewName!=t&&(this.imageLayer.setVisible("satellite"==t),this.basicLayer.setVisible(!0),this.basicLayer.setStyleView(t),this.queryDatasource(),this.onDrawFrame())},getLayer:function(t){for(var e=null,i=0,s=this.layers.length;i<s&&(e=this.layers[i]).name!=t;++i);return e},getBodyOffset:function(){return l(this.mapsv[0])}},i.prototype={initTransform:function(t,e){var i,s,n,a=this.x,r=this.y,o=e.z-this.z;0==o?(s=e.tx-this.tileX,n=e.ty-this.tileY,i=this.scale):o<0?(s=(e.tx<<1)-this.tileX,n=(e.ty<<1)-this.tileY,i=2*this.scale):o>0&&(s=(e.tx>>1)-this.tileX,n=(e.ty>>1)-this.tileY,i=this.scale),(s||n)&&(s=(s<<8)*this.scale,n=(n<<8)*this.scale,a+=s*this.cos0-n*this.sin0,r+=s*this.sin0+n*this.cos0),t.setTransform(1,0,0,1,0,0),t.translate(a,r),t.scale(i,i),t.rotate(this.rotate),t.lineCap=t.lineJoin="round",t.miterLimit=2},initTransformR:function(t,e){var i=this.x,s=this.y;e.z,this.z;8==e.ty&&4==e.z&&(e.ty=8);var n=A(e.tx,e.ty,e.z),a=A(e.tx+1,e.ty+1,e.z),r=n[0]-this.mctX,o=n[1]-this.mctY,h=a[1]-n[1],l=this.mctUpper/2;r>l?r-=this.mctUpper:r<-l&&(r+=this.mctUpper);var c=this.scale;return r*=this.scale,o*=this.scale,i+=r*this.cos0-o*this.sin0,s+=r*this.sin0+o*this.cos0,t.setTransform(1,0,0,1,0,0),t.translate(i,s),t.rotate(this.rotate),t.scale(c,c),h},setPoint:function(t,e,i){this.lon=t,this.lat=e,this.z=null!=i?i:this.z,this.fixToLonlat(),this.listenerNotify("move"),this.listenerNotify("moveend")},identiteContext:function(t){t.setTransform(this.ratio,0,0,this.ratio,0,0)},fixToMercator:function(t){var e=P(this.mctX,this.mctY,this.z);this.lon=e[0],this.lat=e[1],this.deltaX=this.mctX%256,this.deltaY=this.mctY%256;var i=this.mctX>>8,s=this.mctY>>8;(i!=this.tileX||s!=this.tileY||t)&&(this.tileX=i,this.tileY=s,this.fixXY())},fixToLonlat:function(){var t=C(this.lon,this.lat,this.z);this.mctX=t[0],this.mctY=t[1],this.tileX=this.mctX>>8,this.tileY=this.mctY>>8,this.deltaX=this.mctX%256,this.deltaY=this.mctY%256,this.mctUpper=1<<this.z+8,this.fixXY()},fixXY:function(){0==this.rotate?(this.x=this.halfWidth-this.deltaX*this.scale,this.y=this.halfHeight-this.deltaY*this.scale):(this.x=this.halfWidth-this.deltaX*this.scale*this.cos0+this.deltaY*this.scale*this.sin0,this.y=this.halfHeight-this.deltaX*this.scale*this.sin0-this.deltaY*this.scale*this.cos0)},calcRange:function(){var t=this.width/this.ratio,e=this.height/this.ratio,i=t/e,s=1/this.scale;if(i>2||i<.5)if(0==this.rotate)t=this.halfWidth*s,e=this.halfHeight*s;else{var n=Math.abs((this.sin0/this.cos0*t+e)*this.cos0)/2,a=Math.abs((this.cos0/this.sin0*t-e)*this.sin0)/2,r=Math.abs((this.sin0/this.cos0*t-e)*this.cos0)/2,o=Math.abs((this.cos0/this.sin0*t+e)*this.sin0)/2;t=a>o?a:o,e=n>r?n:r}else t=e=this.radius*s;return[this.mctX-t,this.mctX+t,this.mctY-e,this.mctY+e]},calcSize:function(){var t=this.width/this.ratio,e=this.height/this.ratio,i=t/e,s=1/this.scale;if(0==this.rotate)t=this.halfWidth*s,e=this.halfHeight*s;else if(i>2||i<.5){var n=Math.abs((this.sin0/this.cos0*t+e)*this.cos0)/2,a=Math.abs((this.cos0/this.sin0*t-e)*this.sin0)/2,r=Math.abs((this.sin0/this.cos0*t-e)*this.cos0)/2,o=Math.abs((this.cos0/this.sin0*t+e)*this.sin0)/2;t=a>o?a:o,e=n>r?n:r}else t=e=this.radius*s;return[t,e]},bboxRange:function(){var t,e,i=1/this.scale;if(0==this.rotate)t=this.halfWidth*i,e=this.halfHeight*i;else{var s=Math.abs((this.sin0/this.cos0*t+e)*this.cos0)/2,n=Math.abs((this.cos0/this.sin0*t-e)*this.sin0)/2,a=Math.abs((this.sin0/this.cos0*t-e)*this.cos0)/2,r=Math.abs((this.cos0/this.sin0*t+e)*this.sin0)/2;t=n>r?n:r,e=s>a?s:a}return[this.mctX-t,this.mctX+t,this.mctY-e,this.mctY+e]},pointAtLonlat:function(t,e){var i=C(t,e,this.z),s=this.mctUpper>>1,n=i[0]-this.mctX,a=i[1]-this.mctY;return n>s?n-=this.mctUpper:n<-s&&(n+=this.mctUpper),0==this.rotate?[(this.halfWidth+this.scale*n)/this.ratio,(this.halfHeight+this.scale*a)/this.ratio]:[(this.halfWidth+this.scale*n*this.cos0-this.scale*a*this.sin0)/this.ratio,(this.halfHeight+this.scale*n*this.sin0+this.scale*a*this.cos0)/this.ratio]},pixelAtLonlat:function(t,e){var i=C(t,e,this.z),s=this.mctUpper>>1,n=i[0]-this.mctX,a=i[1]-this.mctY;return n>s?n-=this.mctUpper:n<-s&&(n+=this.mctUpper),0==this.rotate?{x:this.halfWidth+this.scale*n,y:this.halfHeight+this.scale*a}:{x:this.halfWidth+this.scale*n*this.cos0-this.scale*a*this.sin0,y:this.halfHeight+this.scale*n*this.sin0+this.scale*a*this.cos0}},lonlatAtPoint:function(t,e){var i=this.mercatorAtPoint(t,e);return P(i[0],i[1],this.z)},mercatorAtPoint:function(t,e){var i=(t*this.ratio-this.halfWidth)/this.scale,s=(e*this.ratio-this.halfHeight)/this.scale;if(0!=this.rotate){var n=Math.sqrt(i*i+s*s),a=Math.atan2(s,i);i=Math.sin(this.rotate-a)*n,s=Math.cos(this.rotate-a)*n}return[i+this.mctX,s+this.mctY]},moveDelta:function(t,e){if(!this.view.moveLock){t*=this.ratio,e*=this.ratio;var i=this.mctUpper,s=1/this.scale;if(this.bbox&&this.bbox[this.z]){var n=this.bbox[this.z],a=this.calcSize();a[0]/=2,a[1]/=2;var r=t*s,o=e*s,h=[this.mctX-a[0],this.mctX+a[0],this.mctY-a[1],this.mctY+a[1]],l=[h[0]-r,h[1]-r,h[2]-o,h[3]-o];if(l=b.rect_intersect(l,n),h=b.rect_intersect(h,n),b.rect_get_area(h)>b.rect_get_area(l))return}this.x+=t,this.y+=e,t*=s,e*=s,this.rotate?(this.mctX-=t*this.cos0+e*this.sin0,this.mctY+=t*this.sin0-e*this.cos0):(this.mctX-=t,this.mctY-=e),this.mctX>i?this.mctX-=i:this.mctX<0&&(this.mctX+=i),this.fixToMercator(),this.view.queryDatasource(),this._moving||(this.listenerNotify("movebegin"),this._moving=!0),this.listenerNotify("move")}},zoomDelta:function(t,e){if(!this.view.zoomLock&&0!=t){var i=this.scale*Math.pow(2,t),s=this.z+t;if(s>=this.maxZ&&(i=Math.pow(2,this.maxZ-this.z)*this.ratio),s<=this.minZ&&(i=Math.pow(2,this.minZ-this.z)*this.ratio),i!=this.scale){var n=this.scale,a=i/this.ratio;if(this.scale=i,e){var r,o,h=1/n-1/this.scale,l=e.x*this.ratio-this.halfWidth,c=e.y*this.ratio-this.halfHeight;this.rotate?(r=(l*this.cos0+c*this.sin0)*h,o=(-l*this.sin0+c*this.cos0)*h):(r=l*h,o=c*h),this.mctX+=r,this.mctY+=o}for(;a>=1.5;)this.mctUpper<<=1,this.scale/=2,this.mctX*=2,this.mctY*=2,++this.z,a/=2;for(;a<.75;)this.mctUpper>>=1,this.scale*=2,this.mctX/=2,this.mctY/=2,--this.z,a*=2;this.fixToMercator(!0),this.view.queryDatasource(),this._zooming||(this.listenerNotify("zoombegin"),this._zooming=!0),this.listenerNotify("zoom")}}},rotateDelta:function(t){if(!this.view.rotateLock&&0!=t){var e=this.halfWidth,i=this.halfHeight,s=e-this.x,n=i-this.y,a=Math.cos(t),r=Math.sin(t);this.rotate+=t,this.rotate>x?this.rotate-=x:this.rotate<0&&(this.rotate+=x),-.01<=this.rotate&&this.rotate<=.01?(t-=this.rotate,this.rotate=this.sin0=0,this.cos0=1,a=Math.cos(t),r=Math.sin(t)):(this.cos0=Math.cos(this.rotate),this.sin0=Math.sin(this.rotate)),this.x=e-s*a+n*r,this.y=i-s*r-n*a,this.view.queryDatasource(),this._rotating||(this.listenerNotify("rotatebegin"),this._rotating=!0),this.listenerNotify("rotate")}},lengthInScreen:function(t){return t/this.ratio*this.scale/(T/(1<<this.z+8)*Math.cos(this.lat*M))},setViewport:function(t,e,i,s){var n=C(t,i,23),a=C(e,s,23),r=Math.log((a[0]-n[0])*this.ratio/(this.width-20))/k,o=Math.log((n[1]-a[1])*this.ratio/(this.height-20))/k,h=23-(r>o?r:o);h<this.minZ?h=this.minZ:h>this.maxZ&&(h=this.maxZ),this.lon=(t+e)/2,this.lat=(i+s)/2,this.z=Math.round(h),this.fixToLonlat(),this.zoomDelta(this.z-h),this.listenerNotify("moveend"),this.listenerNotify("zoomend")},setZoom:function(t){if(t|=0,this.z!=t&&this.minZ<=t&&t<=this.maxZ){var e=P(this.mctX,this.mctY,this.z);this.lon=e[0],this.lat=e[1],this.z=t,this.fixToLonlat(),this.listenerNotify("zoomend")}},setZoomUpper:function(t){t<this.z&&this.setZoom(t),this.maxZ=t},setZoomLower:function(t){t>this.z&&this.setZoom(t),this.minZ=t},setBorderBounds:function(t){this.bounds=t,this.bbox=[];for(var e,i,s=0;s<20;++s)e=C(t.ne.lon,t.ne.lat,s),i=C(t.sw.lon,t.sw.lat,s),this.bbox.push([i[0],e[0],e[1],i[1]])}},extendsFrom(i,tkEventTarget),s.prototype={get:function(t,e){var i=this.cache[t];if(null!=i&&!e){var s=this.header;i.prev.next=i.next,i.next.prev=i.prev,i.next=s,i.prev=s.prev,s.prev.next=i,s.prev=i}return i},setObject:function(t){if(t.key){var e=this.header,i=this.cache[t.key];i&&(i.prev.next=i.next,i.next.prev=i.prev),t.next=e,t.prev=e.prev,e.prev.next=t,e.prev=t,this.cache[t.key]=t,++this.size>this.capacity&&(i=e.next,e.next=i.next,i.next.prev=e,delete this.cache[i.key],--this.size)}},clear:function(){var t=this.header.next,e=t.next;for(this.cache={},this.size=0,this.header.next=this.header,this.header.prev=this.header;t!=this.header;)t.next=null,t.prev=null,e=(t=e).next},filtObjects:function(t){for(var e=this.header,i=e.next;i!=e;)t(i)&&(i.next.prev=i.prev,i.prev.next=i.next,delete this.cache[i.key]),i=i.next},replaceObjects:function(t){for(var e,i=this.header,s=i.prev;s!=i;)(e=t(s))&&(s.next.prev=e,s.prev.next=e,e.next=s.next,e.prev=s.prev,this.cache[e.key]=e),s=s.prev}},a.prototype={get:function(t,e){return this.cache.get(t,e)},setObject:function(t){null!=t.key&&this.scache.setObject(t)},setTile:function(t){null!=t.key&&this.cache.setObject(t)},setRequestTiles:function(t){for(var e=[],i=t[0].layer instanceof TMap.Layer.LayerVector?this.tssh.gMsg:this.tssh.grMsg,s=0,a=t[0];a;a=t[++s]){if(i.XHR&&a.okey){var r=this.scache.get(a.okey);if(null!=r){r=v.styler.styling(r,a.layer,a.z),this.setTile(r);continue}a.key=a.okey}e.push(a)}e.length>0?(e.needDraw=t.needDraw,i.setTaskQueue(e)):n()},clearTiles:function(t){t?this.cache.filtObjects(t):this.cache.clear()},updateTiles:function(t){this.cache.replaceObjects(t)}},m.prototype.exit=function(){return this.exit_proc()},m.mdp_free=function(t){this.points.push({x:t.x,y:t.y,headmark:1});var e=this.view.annotationCanvas.context;e.beginPath(),e.strokeStyle="red",e.lineWidth=4,e.moveTo(t.x,t.y)},m.mmp_free=function(t){if(t.button&&this.points.length>0){var e=this.points[this.points.length-1];if(t.x!=e.x||t.y!=e.y){this.points.push({x:t.x,y:t.y});var i=this.view.annotationCanvas.context;i.lineTo(t.x,t.y),i.stroke()}}},m.mup_free=function(t){},m.ep_free=function(){var t=null;if(this.points.length>0){var e=this.Map;t=new TMap.Polyline(this.points.map(function(t){var i=e.pixelToPoint(t);return $.extend(i,t),i}))}return t},m.mdp_circle=function(t){if(this.points.push({x:t.x,y:t.y,headmark:1}),null==this.result_circle){this.circle_mask=$("<div>").addClass("tkm-map-mask").css({"border-radius":"1px",left:t.x-1+"px",top:t.y-1+"px",width:"2px",height:"2px"}),this.view.mapsv.append(this.circle_mask)}},m.mmp_circle=function(t){if(t.button&&1==this.points.length){var e=this.points[0],i=t.x-e.x,s=t.y-e.y,n=Math.sqrt(i*i+s*s)-4|0;n<=0&&(n=2),this.circle_mask.css({"border-radius":n+"px",left:e.x-n+"px",top:e.y-n+"px",width:2*n+"px",height:2*n+"px"})}},m.mup_circle=function(t){if(1==this.points.length){this.points.push({x:t.x,y:t.y});var e,i,s=this.Map,n=s.pixelToPoint(this.points[0]);e=s.pixelToPoint(this.points[1]),i=n.distance(e),this.result_circle=new TMap.Circle(s.pixelToPoint(this.points[0]),i),this.autoExit&&this.autoExit(s)}},m.ep_circle=function(){var t=null;if(this.result_circle)t=this.result_circle;else if(this.points.length>0){var e,i,s=this.Map,n=s.pixelToPoint(this.points[0]);if(this.points.length>1)e=s.pixelToPoint(this.points[1]),i=n.distance(e);else{var a=this.points[0];e={x:a.x,y:a.y+5},i=n.distance(s.pixelToPoint(e))}t=new TMap.Circle(s.pixelToPoint(this.points[0]),i)}return this.circle_mask&&this.circle_mask.detach(),t},m.mdp_rectangle=function(t){this.points.push({x:t.x,y:t.y,headmark:1}),null==this.result_rectangle&&(this.rectangle_mask=$("<div>").addClass("tkm-map-mask").css({left:t.x+"px",top:t.y+"px",width:"2px",height:"2px"}),this.view.mapsv.append(this.rectangle_mask))},m.mmp_rectangle=function(t){if(t.button&&1==this.points.length){var e=this.points[0],i=t.x-e.x,s=t.y-e.y;this.rectangle_mask.css({left:(i>=0?e.x:e.x+i)+"px",top:(s>=0?e.y:e.y+s)+"px",width:Math.abs(i)+"px",height:Math.abs(s)+"px"})}},m.mup_rectangle=function(t){if(1==this.points.length){var e=[],i=this.Map,s={x:t.x,y:t.y};this.points.push(s),e.push(i.pixelToPoint(s)),s.y=this.points[0].y,e.push(i.pixelToPoint(s)),s.x=this.points[0].x,e.push(i.pixelToPoint(s)),s.y=t.y,e.push(i.pixelToPoint(s)),this.result_rectangle=new TMap.Polygon(e),this.autoExit&&this.autoExit(i)}},m.ep_rectangle=function(){var t=null;return this.result_rectangle?t=this.result_rectangle:this.points.length,this.rectangle_mask&&this.rectangle_mask.detach(),t},TMap.Map=function(i){v||new t(i?i.engineOption:null),null!=i.container&&("string"==typeof i.container&&(i.container=document.getElementById(i.container)),this.view=new e(i),this.view._map=this)},TMap.Map.func_press_for_measure=function(t){if(null!=t){var e,i=this;null==this._messureOverlay&&(this._messureOverlay=new TMap.Polyline([]),this._messureOverlay._addToView(this),this.overlays.push(this._messureOverlay),this.measureTip=new TMap.InfoWindow,this.measureTip._addToView(this),this.measureTip.hide()),(e=i._messureOverlay).addPoint(t);var s=d(e.getLength());this.measureTip.text(s),null==this.mapPinArray&&(this.mapPinArray=[]);var n=new TMap.Marker(t);n.setImage("img/node.png"),n._addToView(this),n.click(function(e){i.measureTip.text(s),i.measureTip.setPoint(t),i.measureTip.update()}),this.mapPinArray.push(n),this.measureTip.show(),this.measureTip.setPoint(t),this.measureTip.update(),this.refreshMap()}else{if(this.measureTip&&(this.measureTip._removeFromView(),this.measureTip=null),this._messureOverlay){var a=this.overlays.indexOf(this._messureOverlay);this.overlays.splice(a,1),this._messureOverlay=null,this.refreshMap()}if(this.mapPinArray){for(var r=0,o=this.mapPinArray.length;r<o;++r)this.mapPinArray[r]._removeFromView(this);this.mapPinArray=null}}},TMap.Map.func_press_for_measure_area=function(t){if(null!=t){var e;null==this._messureOverlay&&(this._messureOverlay=new TMap.Polygon([]),this._messureOverlay._addToView(this),this.overlays.push(this._messureOverlay),this.measureTip=new TMap.InfoWindow,this.measureTip._addToView(this),this.measureTip.hide()),(e=this._messureOverlay).addPoint(t);var i=TMap.GeoUtils.getPolygonArea(e);this.measureTip.text(p(i)),this.measureTip.show(),this.measureTip.setPoint(t),this.measureTip.update(),this.refreshMap()}else{if(this.measureTip&&(this.measureTip._removeFromView(),this.measureTip=null),this._messureOverlay){var s=this.overlays.indexOf(this._messureOverlay);this.overlays.splice(s,1),this._messureOverlay=null,this.refreshMap()}if(this.mapPinArray){for(var n=0,a=this.mapPinArray.length;n<a;++n)this.mapPinArray[n]._removeFromView(this);this.mapPinArray=null}}},TMap.Map.func_press_for_pin_mark=function(t){if(null!=t){null==this.mapPinArray&&(this.mapPinArray=[]);var e=new TMap.Bubble(t);e._addToView(this),this.mapPinArray.push(e);var i=this.mapPinArray.length;e.click(function(){alert(i)}),e.setStyle(i%6)}else{if(this.mapPinArray)for(var s=0,n=this.mapPinArray.length;s<n;++s)this.mapPinArray[s]._removeFromView(this);this.mapPinArray=null}},TMap.Map.func_press_for_query=function(t){if(null==t)return this.clearBoldFeature(),void(this.featureTip&&(this.featureTip._removeFromView(),this.featureTip=null,this.refreshMap()));var e=this.mapMode.pixelAtLonlat(t[0],t[1]);e.x/=this.mapMode.ratio,e.y/=this.mapMode.ratio;var i=this.featureAtPoint(e);if(this.featureTip&&this.featureTip._removeFromView(),i){this.featureTip=new TMap.InfoWindow,this.featureTip._addToView(this),this.featureTip.text(i[3]||"无名要素"),this.featureTip.setPoint(t),this.featureTip.update();var s=this.featureTip,n=TMap.domain+"/detail/query?at=dt&v=1&c_x="+t[0]+"&c_y="+t[1]+"&tn=horae&tp="+(1+(i[0]>>1))+"&name="+(i[3]||"");$.ajax({type:"GET",url:n,timeout:1e4,dataType:"json",success:function(t,e,i){var n,a=[];for(var r in t)(n=r.split("_")).length<2||a.push([parseInt(n.pop()),n.join("_"),t[r]]);a.sort(function(t,e){return t[0]-e[0]});var o,h=$("<table>").css({"border-collapse":"collapse","border-spacing":0,"border-left":"1px solid #888","border-top":"1px solid #888"}),l={"border-right":"1px solid #888","border-bottom":"1px solid #888",padding:"2px 2px"};for(o=0;o<a.length;++o)h.append($("<tr>").append($("<td>").css(l).text(a[o][1]),$("<td>"),$("<td>").css(l).text(a[o][2])));var c,u;s.contentBox.append(c=$("<div>").css({width:120,overflow:"scroll"}).append(h)),(u=h.height()+2)>300&&(u=300),c.css({height:u}),s._resize(140,u+40),s.update()}}),this.refreshMap()}else this.featureTip=null,this._featurePicked&&this.refreshMap();this._featurePicked=i},TMap.Map.prototype={getSize:function(){var t=this.view.mapMode;return new TMap.Size(t.width,t.height)},getBounds:function(){var t=this.view.getBounds();return new TMap.Bounds(t[0],t[1])},pointToOverlayPixel:function(t){var e=this.view.pointAtLonlat(t.lon,t.lat);return new TMap.Pixel(e[0],e[1])},centerAndZoom:function(t,e){var i=this.view,s=i.mapMode;s.lon=t.lon,s.lat=t.lat,s.z=e,s.fixToLonlat(),s.listenerNotify(["move","zoom"]),i.refreshMap()},enableScrollZooming:function(){this.view._scrollWheelZooming=!0},disableScrollZooming:function(){this.view._scrollWheelZooming=!1},panTo:function(t){var e=this.view,i=e.mapMode;i.lon=t.lon,i.lat=t.lat,i.fixToLonlat(),i.listenerNotify("move"),e.refreshMap()},zoom:function(){return this.view.mapMode.z},getZoom:function(){return this.view.mapMode.z},setZoom:function(t){var e=this.view,i=e.mapMode;i.z=t,i.fixToLonlat(),i.listenerNotify("zoom"),e.refreshMap()},setCenter:function(){var t,e=this.view,i=this.view.mapMode,s=null;if(2==arguments.length)s=arguments[0],t=arguments[1];else if(1==arguments.length){var n=arguments[0];null!=n.lon&&null!=n.lat?(s=n.lon,t=n.lat):n instanceof Array&&2==n.length&&(s=n[0],t=n[1])}null!=s&&(i.lon=s,i.lat=t,i.fixToLonlat(),i.listenerNotify("move"),e.refreshMap())},getCenter:function(){var t=this.view.mapMode;return new TMap.Point(t.lon,t.lat)},maxZoom:function(){return this.view.mapMode.maxZ},setMaxZoom:function(t){t|=0,this.view.mapMode.minZ<=t&&t<=23&&(this.view.mapMode.z>t&&this.setZoom(t),this.view.mapMode.maxZ=t)},minZoom:function(){return this.view.mapMode.minZ},setMinZoom:function(t){0<=(t|=0)<=this.view.mapMode.maxZ&&(this.view.mapMode.z<t&&this.setZoom(t),this.view.mapMode.minZ=t)},getBorderBounds:function(){return this.view.mapMode.bounds},setBorderBounds:function(t){this.view.mapMode.setBorderBounds(t)},enableDragging:function(){},addOverlay:function(t,e){t._map||(t._addToView(this.view),this.view.overlays.push(t),null==t.draw||e||this.view.onDrawFrame())},removeOverlay:function(t,e){if(t._map==this){var i=this.view.overlays.indexOf(t);if(i>=0)this.view.overlays.splice(i,1),t._removeFromView();else for(var s=0,n=this.view.overlays.length;s<n;++s)this.view.overlays[s]._id,t._id;null==t.draw||e||this.view.onDrawFrame()}},clearOverlays:function(){for(var t,e=0,i=this.view.overlays.length;e<i;++e)(t=this.view.overlays[e])&&t._removeFromView&&t._removeFromView();this.view.overlays=[]},addEventListener:function(t,e){return this.view.mapMode.addListener(t,e)},removeEventListener:function(t){return this.view.mapMode.removeListener(t)},pointToPixel:function(t){var e=this.view.mapMode.pointAtLonlat(t.lon,t.lat);return new TMap.Pixel(0|e[0],0|e[1])},pixelToPoint:function(t){var e=this.view.mapMode.lonlatAtPoint(t.x,t.y);return new TMap.Point(e[0],e[1])},setViewport:function(t){this.view.mapMode.setViewport(t.sw.lon,t.ne.lon,t.sw.lat,t.ne.lat),this.view.refreshMap()},getViewport:function(){},getLayers:function(){return this.view.layers},getBasicLayer:function(){return this.view.basicLayer},getImageLayer:function(){return this.view.imageLayer},getDynamicCanvas:function(t){for(var e=0,i=this.view.layers.length;e<i;++e)if(this.view.layers[e]instanceof TMap.Canvas.MapCanvasDynamic&&0==t--)return this.view.layers[e];return null},enterDrawMode:function(t,e){this.lockMap(),null==this.view.geoPicker&&(this.view.geoPicker=new m(this,this.view,t),e&&$.extend(this.view.geoPicker,e))},exitDrawMode:function(){var t=null;return this.view.geoPicker&&(t=this.view.geoPicker.exit(),delete this.view.geoPicker,this.unlockMap()),t},click:function(t){null==this.view.clickProcs&&(this.view.clickProcs=[]),this.view.clickProcs.push(t)},removeClick:function(t){this.view.clickProcs&&("number"==typeof t?t>=0&&t<this.view.clickProcs.length&&this.view.clickProcs.splice(t):(t=this.view.clickProcs.index(t))>=0&&this.view.clickProcs.splice(t),0==this.view.clickProcs.length&&delete this.view.clickProcs)},lockMap:function(){this._oldLockFlag=[this.view.moveLock,this.view.zoomLock,this.view.rotateLock],this.view.moveLock=this.view.zoomLock=this.view.rotateLock=!0},unlockMap:function(){this.view.moveLock=this._oldLockFlag[0],this.view.zoomLock=this._oldLockFlag[1],this.view.rotateLock=this._oldLockFlag[2]}}}(),TMap.private.egaki=function(t,e){function i(t){return s[t.t]}var s=[function(t,e,i){},function(t,e,i){var s=e.ratio/e.scale;i.w>=0&&(null==i.wlw&&(i.wlw=(i.l||0)+2*(i.w||0),0==i.wlw&&(i.wlw=1)),t.lineWidth=i.wlw*s,t.strokeStyle=i.s,t.setLineDash([]),t.stroke()),i.l>=0&&(t.lineWidth=i.l*s,t.strokeStyle=i.f,t.setLineDash(i.d||[]),t.stroke())},function(t,e,i){t.fillStyle=i.f,t.fill()},function(t,e,i){t.fillStyle=i.f,t.fill()}];(new Image).src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAEL0lEQVR4Xu2dYXKdMAyE/U6W9GQvOVmaXqwZBUjJm8zUSDvIRl9+tgiLZd9qsYW5tdb+Nv7KInBbCfDeWvvtQOGptWbn8MTacMTn4fds+G8EeG2tvTgIcF8J4Im14YhfCJCBn415hwB5NyD7ByAhgEM0CBkEAQgwyI3ISkNCAGr4vCUEAhQ3oRAAAvAUULmESRQgy8AwbhwBCBDHcOozSAhQWUKzJ3Ki40MATCAmsLKCfVMAW83bVvRsYWiTl32R++nfbTXvz7qYYWD+73j7//159quBR8bdzmNj2qrWfjXyyHkq5/9m2P20HLytTD2uUPHvC72vgoP9aMLLwVPb4OLJYwIxgZhATODaEkZHkK8ezEwgSgAlIF4CfL8bokZAQKIAI1wIOfgQkBBg5hoYnUufPR4C4AHiHgAFoCcw7cWG2SU4O39JCfDZD6JGQAACjHAXEnOQEAAPcBEPQD/A8qJqpX4GST+ANVTYq+UmJ57+gX1DiGed3W7ar4eGkCPnqZy/pB+AEnCREuBdDUz0MAwdREBiAoM5EJ6IgIQAlIDiJQACQACmgpP2+IlOJVMCWA2MrwYmehiGDiIgUYBgDoQnIiAhACYQE4gJxATm7HQZdcHV4ykBPAXwFJDowdKHluwPYFdx5H18jv9337Nxox9g3a6+aj8D/QB4gLgHYB6AeQDmASrPA6RbWRJwIyCZB3CPTmA6AhIC4AHwAHiAyh4ABUABUIDKCpDuZEjAjYDEBLpHJzAdAQkB8AB4ADxAZQ+AAlxEAdgfgP0Bvj66cOT9enMyHL/4udlwkPQDpFtZEnAjwFMADSE0hFQ2sSgACoACoADBL4a4HQiB6QhISkD6VZCAGwEJASpL6OzvFkIATCAmsLKCoQAoQFwB3A6EwHQEJAqQfhUk4EZAQoDKNfRSTwH0A9AP4OoHqLzfvknozN87kPQDUAIu0hLG9wLcXmraQIkJnPbqSfyzhe1+C64GUgKKlwAIAAF4MYQXQ9gq9vGTeb0WI1NBJR6g90I5bjwEIMB49+TUjCQEyJSw2efis/OHAPQDMA9QWcFQABQgrgCnuhYGkyLA9wJWOLP37bcytP87Kx++F8D3AtoTi0HzzuVHHyMxgZjAuAms/BgV/QVmx0sUQGpLOdmpCECAU+EebzAJASgB85pICIAJxARWVjAUAAWIK8B41oaMehGQKEDvYBw3HgISAlSuodkTOdHxIQAeIO4BUICLzAOwPwD7A7j2B7A6NNs++Y8vcVTNX7I/wHjelox6EcAEYgIxgZVNLAqAAqAAKEBwh5Bew8Fx4yEgKQHjXRYZ9SIgIUBlCY3OxWfHQwBMICawsoKhAChAXAF6DQfHjYeARAHGuywy6kXgGwHeW/taDew9gR233y37SNx2LPFLP4GtzHn+Ivg92/3b3g72DE7MBRD4AB+X7j1A9PfvAAAAAElFTkSuQmCC",t.vectorDraw=function(e,s,n){var a=n[0];if(null!=a){var r=s.ratio,o=a[s.z>7?"f":"s"];o&&(e.fillStyle=o,e.beginPath(),e.rect(0,0,s.width,s.height),e.fill()),e.lineCap="butt",e.lineJoin="round",e.miterLimit=2;for(var h=new Set,l=0,c=n.length;l<c;++l)h.merge(n[l].zIndexKeys);for(var u,f=0,p=(h=Array.from(h).sort()).length;f<p;++f){u=h[f];for(var d,m=!0,v=new Set;m;){d=null,m=!1,e.beginPath();for(var l=0,c=n.length;l<c;++l){if(null!=(a=n[l]).g&&!(null==(L=a.g[u])||L.length<=0)){e.save(),s.initTransform(e,a);for(var g,y=0,w=L.length;y<w;++y){var x=L[y],M=x.hash();if(null==d){if(v.has(M))continue;d=x,v.add(M)}else if(d.hash()!=M){v.has(M)||(m=!0);continue}for(var _=0,k=(g=x.a).length;_<k;++_)for(var T=g[_],b=0,C=T.length;b<C;b+=2)0==b?e.moveTo(T[b],T[b+1]):e.lineTo(T[b],T[b+1])}e.restore()}}e.setTransform(r,0,0,r,0,0),i(d)(e,s,d)}}if(t.boldGeos){var P=null,A=t.boldGeos;e.beginPath();for(var S=0,z=A.length;S<z;++S){var D=A[S],L=D[1];P!=D[0]&&(P&&e.restore(),e.save(),s.initTransform(e,D[0]),P=D[0]);for(var I=0,O=L.length;I<O;I+=2)0==I?e.moveTo(L[I],L[I+1]):e.lineTo(L[I],L[I+1])}P&&e.restore(),e.setTransform(r,0,0,r,0,0),i(A)(e,s,A)}}}},function(){function t(t){return null==t.mapMode&&t._owner?{context:t.context,mapMode:t._owner.mapMode,width:t._owner.mapMode.width,height:t._owner.mapMode.height}:t}var e=TMap.Drawer||(TMap.Drawer={}),i=2*Math.PI;e.scattermap=function(e,s,n){var a=(e=t(e)).context,r=e.mapMode.ratio;n=n||{};this.adjustSize=function(){},this.render=function(){var t,e=s.get(),o=(n.size||.7)*r;for(a.setTransform(r,0,0,r,0,0),a.beginPath();null!=(t=e.next());){var h=t.x,l=t.y;a.moveTo(h,l),a.arc(h,l,o,0,i)}a.fillStyle=n.fillStyle||"red",a.fill(),a.closePath()}},e.heatmap=function(e,s,n){function a(t){var e,i,s,n=t.data,a=0;for(e=3,i=n.length;e<i;e+=4)(s=n[e])>a&&(a=s);if(a>0){var r=255/a;for(e=3,i=n.length;e<i;e+=4)(s=n[e])>0&&(n[e]=s=s*r|0,s<<=2,n[e-3]=o[s],n[e-2]=o[s+1],n[e-1]=o[s+2])}return t}function r(){var t=e.mapMode.ratio;l.width=e.width,l.height=e.height,l.style.width=e.width/t,l.style.width=e.width/t,h=200*(e.width+e.height),c.shadowOffsetX=-h,c.shadowOffsetY=-h,c.shadowBlur=25*t}var o,h=2*((e=t(e)).width+e.height),l=document.createElement("canvas"),c=l.getContext("2d");n=n||{},function(){l.height=1,l.width=256;var t=n.gradient||{.25:"blue",.55:"green",.8:"yellow",1:"red"},e=c.createLinearGradient(0,0,256,1);for(var i in t)e.addColorStop(parseFloat(i),t[i]);c.fillStyle=e,c.fillRect(0,0,256,1),o=c.getImageData(0,0,256,1).data}(),r(),this.adjustSize=r,this.render=function(){var t=e.mapMode.ratio;c.setTransform(1,0,0,1,0,0),c.clearRect(0,0,e.width,e.height),c.translate(h,h),c.scale(t,t);for(var n,r=s.get(),o=s.maxVal;null!=(n=r.next());){var l=n.x,u=n.y,f=(n.count||0)/o,p="rgba(0,0,0,"+(f||"0.1")+")";c.beginPath(),c.arc(l,u,16*t,0,i,!0),c.shadowColor=p,c.fill(),c.closePath()}var d=c.getImageData(0,0,e.width,e.height);a(d),e.context.putImageData(d,0,0)}}}(),function(){var t=Math.PI,e=2*t,i=t/180,s=TMap.GeoUtils,n=s;TMap.Point=function(){if(1==arguments.length){var t=arguments[0];t instanceof Array?(this.lon=t[0],this.lat=t[1]):(this.lon=t.lon,this.lat=t.lat)}else this.lon=arguments[0],this.lat=arguments[1],arguments.length>2&&(this.headmark=1);this.lon=n.fixlon(this.lon),this.lat=n.fixlat(this.lat)},TMap.Point.prototype={equals:function(t){return this.lon==t.lon&&this.lat==t.lat},distance:function(t,e){var i,s;return t instanceof Number&&e instanceof Number?(i=t,s=e):t instanceof TMap.Point&&(i=t.lon,s=t.lat),n.arc_points(this.lon,this.lat,i,s)*n.TK_EARTH_RADIUS},normalize:function(){this.lon=n.fixlon(this.lon),this.lat=n.fixlat(this.lat)}};var a=TMap.Point.toPoint=function(){if(arguments.length){var t=arguments[0],e=null;if(null==t)return null;if(arguments.length>=2&&(e=arguments[1]),"number"==typeof t&&"number"==typeof e)return new TMap.Point(t,e);if(null!=t.lon&&null!=t.lat)return t;if(t instanceof Array)return t.length>2&&"number"!=typeof t[0]?t.map(a):new TMap.Point(t)}return null};TMap.Pixel=function(){if(1==arguments.length){var t=arguments[0];t instanceof Array?(this.x=t[0],this.y=t[1]):(this.x=t.x,this.y=t.y)}else this.x=arguments[0],this.y=arguments[1]},TMap.Pixel.prototype={equals:function(t){return this.x==t.x&&this.y==t.y}};var r=TMap.Pixel.toPixel=function(){if(arguments.length){var t=arguments[0],e=null;if(null==t)return null;if(arguments.length>=2&&(e=arguments[1]),"number"==typeof t&&"number"==typeof e)return new TMap.Pixel(t,e);if(null!=t.x&&null!=t.y)return t;if(t instanceof Array)return t.length>2&&"number"!=typeof t[0]?t.map(r):new TMap.Pixel(t)}return null};TMap.Size=function(t,e){this.width=t,this.height=e},TMap.Size.prototype={equals:function(t){return this.width==t.width&&this.height==t.height}},TMap.Bounds=function(t,e){this.sw=new TMap.Point(t),this.ne=new TMap.Point(e)},TMap.Bounds.prototype={equals:function(t){return t instanceof TMap.Bounds&&this.sw.equals(t.sw)&&this.ne.equals(t.ne)},containsPoint:function(t){return this.sw.lon<=t.lon&&t.lon<=this.ne.lon&&this.sw.lat<=t.lat&&t.lat<=this.ne.lat},getCenter:function(){return new TMap.Point((this.sw.lon+this.ne.lon)/2,(this.sw.lat+this.ne.lat)/2)},isEmpty:function(){return!1},getSouthWest:function(){return this.sw},getNorthEast:function(){return this.ne},toSpan:function(){return new TMap.Size(this.ne.lon-this.sw.lon,this.ne.lat-this.sw.lat)},extend:function(t){this.sw.lon>t.lon&&(this.sw.lon=t.lon),this.sw.lat>t.lat&&(this.sw.lat=t.lat),this.ne.lon<t.lon&&(this.ne.lon=t.lon),this.ne.lat<t.lat&&(this.ne.lat=t.lat)}};var o=0;TMap.Overlay=function(){this._visible=!0,this._owner=null,this._map=null,this._id=o++},TMap.Overlay.prototype={_addToView:function(t){this._owner=t,this._map=t._map},_removeFromView:function(){this._owner=null,this._map=null},show:function(){this._visible=!0},hide:function(){this._visible=!1},toggle:function(){this._visible?this.hide():this.show()},getVisible:function(){return this._visible},getMap:function(){return this._map}},TMap.Shape=function(){Extends(this,TMap.Overlay,arguments),this.color="#ff8800"},inherit(TMap.Shape,TMap.Overlay,{draw:function(t,e){},_resetTransform:function(t){var e=this._owner.mapMode.ratio;t.setTransform(e,0,0,e,0,0)}}),TMap.Circle=function(t,e,s){Extends(this,TMap.Shape,arguments),this.point=TMap.Point.toPoint(t),this.radius=e,e/=6378137*i,this._Point={lon:t.lon,lat:t.lat-e},this.mctPoint={},this.mctLength={},this.width=3,this.color="#ff0000",this.fillColor="rgba(255,192,0,0.2)",s&&$.extend(this,s)},inherit(TMap.Circle,TMap.Shape,{draw:function(t,i){if(this._visible){var s=this.getMctPt(i),n=this.mctLength[i]*this._map.view.mapMode.scale/this._map.view.mapMode.ratio;t.beginPath(),t.arc(s[0],s[1],n,0,e),this._resetTransform(t),this.color&&(t.setLineDash(this.dash||[]),t.lineWidth=this.width,t.strokeStyle=this.color,t.stroke()),this.fillColor&&(t.fillStyle=this.fillColor,t.fill()),t.closePath()}},getMctPt:function(t){var e=this.mctPoint[t];if(null==e){var i=n.ll2mct(this._Point.lon,this._Point.lat,t);e=n.ll2mct(this.point.lon,this.point.lat,t),this.mctPoint[t]=e,this.mctLength[t]=i[1]-e[1]}return e}}),TMap.MultiPoint=function(t){Extends(this,TMap.Shape,arguments),this.lonlats=(t||[]).map(a),this.mctPoint={},this.continuous=!1},inherit(TMap.MultiPoint,TMap.Shape,{getMctPts:function(t){var e=this.mctPoint[t];if(e)return e;if(e=[],this.continuous){this.lonlats.forEach(function i(s){var a=e.length;if(s instanceof Array)s.forEach(i),e[a]&&e[a].push(0);else if(s instanceof TMap.Point){var r=n.ll2mct(s.lon,s.lat,t);s.headmark&&r.push(0),e.push(r)}})}else{var i=new Set(this.lonlats.map(function(e){var i=n.ll2mct(e.lon,e.lat,t);return(0|i[0])+","+(0|i[1])}));e=Array.from(i).map(function(t){var e=t.split(",");return[+e[0],+e[1]]})}return this.mctPoint[t]=e,e},draw:function(t,i){if(this._visible){var s,n=this.getMctPts(i);if(n.length>0){t.beginPath();for(var a=0,r=n.length;a<r;++a)s=n[a],t.arc(s[0],s[1],1,0,e);t.fillStyle=this.color,t.fill(),t.closePath()}}},addPoint:function(t){this.lonlats.push(a(t)),this.mctPoint={}}}),TMap.Polyline=function(){Extends(this,TMap.MultiPoint,arguments),this.continuous=!0,this.width=3,this.dash=[]},inherit(TMap.Polyline,TMap.MultiPoint,{draw:function(t,e){if(this._visible){var i=this.getMctPts(e);if(i.length>0){var s=i[0];t.beginPath(),t.moveTo(s[0],s[1]);for(var n=1,a=i.length;n<a;++n)(s=i[n]).length>2?t.moveTo(s[0],s[1]):t.lineTo(s[0],s[1]);this._resetTransform(t),t.setLineDash(this.dash||[]),t.lineWidth=this.width,t.strokeStyle=this.color,t.stroke(),t.closePath()}}},getLength:function(){for(var t=0,e=0,i=this.lonlats.length-1;e<i;++e)t+=s.getDistance(this.lonlats[e],this.lonlats[e+1]);return t}}),TMap.Polygon=function(){Extends(this,TMap.MultiPoint,arguments),this.continuous=!0,this.strokeColor="red",this.color="rgba(255,192,0,0.2)"},inherit(TMap.Polygon,TMap.MultiPoint,{draw:function(t,e){if(this._visible){var i=this.getMctPts(e);if(0==i.length)return;var s=i[0],n=0;t.beginPath(),t.moveTo(s[0],s[1]);for(var a=1,r=i.length;a<r;++a)if((s=i[a]).length>2){var o=i[n];t.lineTo(o[0],o[1]),t.moveTo(s[0],s[1]),n=a}else t.lineTo(s[0],s[1]);s=i[n],t.lineTo(s[0],s[1]),this._resetTransform(t),this.strokeColor&&(t.setLineDash(this.dash||[]),t.lineWidth=this.width||3,t.strokeStyle=this.strokeColor,t.stroke()),this.color&&(t.mozFillRule="evenodd",t.fillStyle=this.color,t.fill("evenodd")),t.closePath()}}}),TMap.DOMTagOverlay=function(t){Extends(this,TMap.Overlay,arguments),this.point=TMap.Point.toPoint(t),this.listener=0,this._sv=null,this._clickProc=null},inherit(TMap.DOMTagOverlay,TMap.Overlay,{setPoint:function(t){var e=a(t);e&&(this.point=e)},getPoint:function(){return this.point},_addToView:function(t){if(!this._owner){TMap.Overlay.prototype._addToView.bind(this)(t),this._sv.appendTo(t.mapsv),this.update(),this._clickProc&&this.click(this._clickProc);var e=this;this.listener=t.mapMode.addListener(function(){e.update()},["zoom","move","rotate","resize"]),this._sv.mouseover(function(){e._oldzindex=e._sv.css("z-index"),e._sv.css({"z-index":100})}).mouseout(function(){e._sv.css({"z-index":e._oldzindex||20})})}},_removeFromView:function(){this._sv.detach(),this._owner&&this._owner.mapMode.removeListener(this.listener),this.listener=0,this._sv.unbind(),TMap.Overlay.prototype._removeFromView.bind(this)()},update:function(){if(this._owner&&this.point){var t=this._owner.getBodyOffset(),e=this._owner.mapMode.pointAtLonlat(this.point.lon,this.point.lat);return e[0]+=t.x,e[1]+=t.y,e}},hide:function(){this._sv.hide(),this._visible=!1},show:function(){this._sv.show(),this._visible=!0},click:function(t){this._clickProc=t,this._sv.unbind("click"),this._sv.bind("click",t)}}),TMap.TextIconOverlay=function(t,e,i){Extends(this,TMap.DOMTagOverlay,arguments),this._sv=$("<DIV>").text(e).attr({class:"tkm-pin-overlay"}).css({"font-size":"10px","font-family":"Arial, sans-serif","font-weight":"bold"}),this._sv.css({"line-height":this._sv.css("height")})},inherit(TMap.TextIconOverlay,TMap.DOMTagOverlay,{update:function(){var t=TMap.DOMTagOverlay.prototype.update.bind(this)();t&&(console.log(t),this._sv.css({left:t[0]-this._sv.width()/2,top:t[1]-this._sv.height()/2}))},setPoint:function(t){this.point=TMap.Point.toPoint(t),this.update()},setText:function(t){this._sv.text(t)}}),TMap.Marker=function(t){Extends(this,TMap.DOMTagOverlay,arguments),this._sv=$("<DIV>").attr({class:"tkm-map-pin"}),this.width=this.height=16,this.offsetX=this.offsetY=0,this._getAnchor=this._getCenter0,this._anchor=0,this.onclick=null},inherit(TMap.Marker,TMap.DOMTagOverlay,{update:function(){var t=TMap.DOMTagOverlay.prototype.update.bind(this)();if(t){var e=this._getAnchor();this._sv.css({left:t[0]+e[0]+this.offsetX,top:t[1]+e[1]+this.offsetY})}},_getCenter0:function(){return[-this.width/2,-this.height/2]},_getCenter1:function(){return[-this.width/2,-this.height]},_getCenter2:function(){return[0,-this.height]},_getCenter3:function(){return[0,-this.height/2]},_getCenter4:function(){return[0,0]},_getCenter5:function(){return[-this.width/2,0]},_getCenter6:function(){return[-this.width,0]},_getCenter7:function(){return[-this.width,-this.height/2]},_getCenter8:function(){return[-this.width,-this.height]},setImage:function(t){this._sv.css({"background-image":'url("'+t+'")'});var e=this,i=new Image;i.onload=function(){e._sizeSet||e.setSize(i.width,i.height)},i.src=t},getImage:function(){return this._sv.css("background-image")},setSize:function(t,e){this.width=t,this.height=e,this._sizeSet=!0,this._sv.css({width:t+"px",height:e+"px"}),this.update()},setOffset:function(t,e){"number"==typeof t.x?(this.offsetX=t.x,this.offsetY=t.y):(this.offsetX=t,this.offsetY=e),this.update()},getOffset:function(){return new TMap.Pixel(this.offsetX,this.offsetY)},setAnchor:function(t){this._anchor=t,this._getAnchor=this["_getCenter"+t]},getAnchor:function(){return this._anchor}}),TMap.Bubble=function(t){Extends(this,TMap.Marker,arguments),this._style=1,this.width=26.9,this.height=40,this._sv=$("<DIV>").attr({class:"tkm-map-pin"}).css({"background-image":'url("img/mappin-'+this._style+'.png")',width:this.width+"px",height:this.height+"px"}),this.onclick=null},inherit(TMap.Bubble,TMap.Marker,{update:function(){var t=TMap.DOMTagOverlay.prototype.update.bind(this)();t&&this._sv.css({left:t[0]-this.width/2,top:t[1]-this.height})},getStyle:function(){return this._style},setStyle:function(t){0<t&&t<=6&&(this._style=t,this._sv.css({"background-image":'url("img/mappin-'+this._style+'.png")'}))}}),TMap.InfoWindow=function(t){Extends(this,TMap.DOMTagOverlay,arguments),this.arrow=$("<tktrs>").append($("<tktri>")),this.contentBox=$("<DIV>").attr({class:"tkm-bubble-content"}),this._sv=$("<DIV>").attr({class:"tkm-bubble"}).append(this.contentBox,this.arrow),this.width=this.height=40,this._resize(100,40),this.offset=0},inherit(TMap.InfoWindow,TMap.DOMTagOverlay,{update:function(){var t=TMap.DOMTagOverlay.prototype.update.bind(this)();t&&this._sv.css({left:t[0]-this.width/2,top:t[1]-this.height-this.offset-12})},text:function(t){var e={"font-size":"14px"};this.contentBox.text(t),this.contentBox.css(e);var i=t.visualLength(e);this._resize(i+20,40)},setSize:function(t,e){t.x,this._resize(t,e),this.update()},getSize:function(){return new TMap.Size(this.width,this.height)},getOffset:function(){return this.offset},setOffset:function(t){this.offset=t||0,this.update()},_resize:function(t,e){t<=40&&(t=40),this.width=t,this.height=e,this._sv.css({width:t+"px",height:e+"px"}),this.arrow.css({left:t/2-10+"px"})}})}(),TMap.private.tkShiori=function(t,e,i){function s(t,e,i,s,n){this.margin=n,this.top=t-n,this.bottom=e+n,this.left=i-n,this.right=s+n}function n(t,e){this.w=t=(t>>8)+(255&t?1:0),this.h=e=(e>>8)+(255&e?1:0),this.arr=[];for(var i=0;i<t*e;++i)this.arr.push([])}function a(t,e){this.grid=new n(t,e),this.shownSet=new Set,this.shownLabels=[]}function r(t,e,i,s){var n=[0,g,p,p,w,m],a=[0,y,d,d,x,v];t.tile=i,t.context=e,e.textAlign="left",t.lctrl=s,t.fixXY=l,t.textTrim=u,5==t.j&&t.a.length>=2?t.r&&t.r.length&&!s.shownSet.has(t.r)&&C.bind(t)():(t.budget=n[t.j],t.draw=a[t.j],f(t)||t.draw())}function o(t){t.context.setTransform(e.ratio,0,0,e.ratio,0,0)}function h(t,s,n){var a=e.scale,r=a*(s+(t.tdx<<i)),o=a*(n+(t.tdy<<i));return[(e.x+r*e.cos0-o*e.sin0)/e.ratio,(e.y+r*e.sin0+o*e.cos0)/e.ratio]}function l(){var t=e.scale,s=this.a;this.tdx=this.tile.tx-e.tileX,this.tdy=this.tile.ty-e.tileY;var n=t*(s[0]+(this.tdx<<i)),a=t*(this.a[1]+(this.tdy<<i));this.x=(e.x+n*e.cos0-a*e.sin0)/e.ratio,this.y=(e.y+n*e.sin0+a*e.cos0)/e.ratio}function c(t,s){var n=e.scale;t.tdx=t.tile.tx-e.tileX,t.tdy=t.tile.ty-e.tileY;var a=n*(s.x+(t.tdx<<i)),r=n*(s.y+(t.tdy<<i));s.x=(e.x+a*e.cos0-r*e.sin0)/e.ratio,s.y=(e.y+a*e.sin0+r*e.cos0)/e.ratio}function u(){if(!this.ll){null==this.n&&(this.n=10);var t,e=this.r.length,i=this.n,s=this.context;s.font=this.n+D,(t=this.r.indexOf("\n"))>0?(this.rr=[this.r.substr(0,t),this.r.substr(t+1)],this.rrl=this.rr.map(function(t){return s.measureText(t).width}),this.ll=Math.max.apply(null,this.rrl),this.hh=i+i):e>10?(t=Math.ceil(e/2),this.rr=[this.r.substr(0,t),this.r.substr(t)],this.rrl=this.rr.map(function(t){return s.measureText(t).width}),this.ll=Math.max.apply(null,this.rrl),this.hh=i+i):(this.ll=s.measureText(this.r).width,this.hh=i)}}function f(t){var e;return t.j&&t.lctrl.couldShow(t,e=t.budget())?(t.lctrl.prepare(t,e),0):1}function p(){if(null!=this.r&&0!=this.r.length&&this.imgInfo){this.fixXY(),this.textTrim();var t=this.x,e=this.y,i=this.ll,n=this.hh;this.iw=this.imgInfo.iw,this.ih=this.imgInfo.ih;var a=new s(e-n/2,e+n/2,t-this.iw/2,t+this.iw/2+i+3,z);return a.label=this,a}}function d(){var e=this.context,i=this.x,s=this.y,n=this.imgInfo,a=0;n&&0==n.t&&n.img&&(e.drawImage(n.img,n.x,n.y,n.w,n.h,i-this.iw/2,s-this.ih/2,n.iw,n.ih),a=this.iw/2+3),e.font=this.n+D,this.imgInfo&&0!=this.imgInfo.t||(e.lineWidth=2*(this.w||(this.w=1)),e.strokeStyle=this.s||S,M(this,a,A)),e.fillStyle=this==t.poiLabel?"#f00":this.f,M(this,a,P)}function m(){this.fixXY(),this.textTrim();var t=this.x,e=this.y,i=(this.ll||0)/2,n=(this.hh||0)/2,a=new s(e-n,e+n,t-i,t+i,z);return a.label=this,a}function v(){var e=this.context;this.x,this.y;e.font=this.n+D,e.lineWidth=2*(this.w||(this.w=2)),e.strokeStyle=this.s||S,_(this,0,A),e.fillStyle=this==t.poiLabel?"#f00":this.f,_(this,0,P)}function g(){this.fixXY(),this.textTrim();var t=this.x,e=this.y,i=this.ll/2+5,n=this.hh/2+5;return new s(e-n,e+n,t-i,t+i,z)}function y(){var t=this.context,e=this.x,i=this.y,s=this.imgInfo;s&&9==s.t&&s.img&&(t.drawImage(s.img,s.x,s.y,s.w,s.h,e-this.ll/2-5,i-this.hh/2-5,this.ll+10,this.hh+10),e-=this.ll/2),t.font=this.n+D,t.fillStyle=this.f,_(this,0,P)}function w(){this.fixXY();var t,e,i=this.x,n=this.y;return t=(this.iw||0)/2,e=(this.ih||0)/2,new s(n-e,n+e,i-t,i+t,z)}function x(){var e=this.context,i=this.x,s=this.y,n=this.imgInfo;n&&0==n.t&&n.img&&e.drawImage(n.img,n.x,n.y,n.w,n.h,i-this.iw/2,s-this.ih/2,n.iw,n.ih),t.poiLabel}function M(t,e,i){var s=t.x+e,n=t.y,a=t.context;if(t.rr){n-=t.n*(t.rr.length-1)/2;for(var r=0,o=t.rr.length;r<o;++r)a[i](t.rr[r],s,n),n+=t.n}else a[i](t.r,s,n)}function _(t,e,i){var s=t.x,n=t.y+e,a=t.context;if(t.rr){0==e&&(n-=t.n*(t.rr.length-1)/2);for(var r=0,o=t.rr.length;r<o;++r)a[i](t.rr[r],s-t.rrl[r]/2,n),n+=t.n}else a[i](t.r,s-t.ll/2,n)}function k(t,e,i,s,n,a){t.context[a](e,i,s)}function T(t,e){var i=t[e]-t[e+2],s=t[e+1]-t[e+3];return Math.sqrt(i*i+s*s)}function b(t,e,i,n,a,r){var o=a<<1,l=n[o]-e,c=n[o+1]-i,u=Math.sqrt(l*l+c*c);if(u>=r){var f=r/u,p=e+l*f,d=i+c*f,m=h(t,p,d),v=m[0],g=m[1];return{sx:v,sy:g,x:p,y:d,index:a,rect:new s(g-r,g+r,v-r,v+r,0)}}}function C(){var t=this.r.length,i=this.n*O,s=(T(this.a,0),1),n=this.lctrl.grid,a=this.a[0],r=this.a[1],h=[],l=t,c=this.a.length>>1;for(this.tdx=this.tile.tx-e.tileX,this.tdy=this.tile.ty-e.tileY;l;){var u=b(this,a,r,this.a,s,i);if(u&&n.puttable(u.rect))a=u.x,r=u.y,u.rect.x=a,u.rect.y=r,s=u.index,h.push(u),--l;else{if(++s>=c)return;h=[],l=t}}var f,p=h[0],d=[0,0,0,0];for(s=1;s<t;++s){f=h[s];var m=Math.atan2(p.sy-f.sy,p.sx-f.sx),v=Math.round(m/L*2+6)%4;d[v]++,f.ang=m,1==s&&(d[v]++,p.ang=m),p=f}for(var g=3,y=0,w=0;y<4;++y)w<d[y]&&(w=d[g=y]);g=B[g],--t;var x=Math.atan2(h[0].sy-h[t].sy,h[0].sx-h[t].sx);x=-I<x&&x<=3*I,i/=2;var M=this.context,_=[this,,[]];for(M.font=this.n+D,M.lineWidth=2*(this.w||(this.w=2)),M.strokeStyle=this.s||S,M.fillStyle=this.f,M.textAlign="center",s=t;s>=0;--s){var C=this.r.charAt(s),p=h[x?t-s:s];n.putrect(p.rect),_[2].push(p.rect),a=p.sx,r=p.sy,M.translate(a,r),M.rotate(p.ang+g),k(this,C,0,0,0,A),k(this,C,0,0,0,P),o(this)}this.lctrl.shownSet.add(this.r),this.lctrl.shownLabels.push(_)}var P="fillText",A="strokeText",S="#fff",z=10,D="px 黑体",L=Math.PI,I=L/4,O=Math.SQRT2,B=[-L,L/2,0,-L/2],E=t.owner().layers;s.prototype={intersect:function(t){return this.left<=t.right&&t.left<=this.right&&this.top<=t.bottom&&t.top<=this.bottom},inrect:function(t,e){return this.left<=t&&t<=this.right&&this.top<=e&&e<=this.bottom},incore:function(t){var e=t.x,i=t.y;return this.left<=e-this.margin&&e+this.margin<=this.right&&this.top<=i-this.margin&&i+this.margin<=this.bottom}},n.prototype={enumerate:function(t,e){var i,s,n,a=t.left>>8,r=t.right>>8,o=t.top>>8,h=t.bottom>>8;if(a<0&&(a=0),r>=this.w&&(r=this.w-1),o<0&&(o=0),h>=this.h&&(h=this.h-1),!(r<0||a>=this.w||h<0||o>=this.h))for(i=o;i<=h;++i)for(n=i*this.w,s=a;s<=r;++s)if(e(this.arr[n+s],t))return},putrect:function(t){this.enumerate(t,function(t,e){return t.push(e),0})},puttable:function(t){if(null==t)return 0;var e=1,i=0;return this.enumerate(t,function(t,s){i=1;for(var n=t.length-1;n>=0;n--)if(s.intersect(t[n]))return e=0;return 0}),i&&e},pointed:function(t){var e=t.x>>8,i=t.y>>8;if(!(e<0||e>=this.w||i<0||i>=this.h)){var s=this.arr[i*this.w+e];for(e=0,i=s.length;e<i;++e)if(s[e].incore(t))return s[e]}}},a.prototype={couldShow:function(t,e){return null!=e&&((4==t.j||!this.shownSet.has(t.r))&&!(e&&!this.grid.puttable(e)))},prepare:function(t,e){4!=t.j&&this.shownSet.add(t.r),this.grid.putrect(e),this.shownLabels.push([t,,[e]])},snapLabels:function(t){for(var i,s=0,n=this.shownLabels.length;s<n;++s){var a=(i=this.shownLabels[s])[2];i[1]=a.map(function(i){var s=e.ratio,n=i.label,a=i.right-i.left-2*i.margin,r=i.bottom-i.top-2*i.margin,o=i.left+i.margin,h=i.top+i.margin;return{image:t.getImageData(o*s,h*s,a*s,r*s),sx:n?n.x-o:a/2,sy:n?n.y-h:r/2}})}},putSnap:function(t){for(var i,s,n=0,a=this.shownLabels.length;n<a;++n){(s=(i=this.shownLabels[n])[0]).fixXY();var r=i[2],o=i[1];if(1==r.length)h=o[0],t.putImageData(h.image,(s.x-h.sx)*e.ratio,(s.y-h.sy)*e.ratio);else for(var h,l,u=0,f=r.length;u<f;++u)h=o[u],c(s,l=r[u]),t.putImageData(h.image,(l.x-h.sx)*e.ratio,(l.y-h.sy)*e.ratio)}}},t.shiori=function(t){t.clearRect(0,0,e.width,e.height);var i=new a(e.width,e.height);t.save(),t.lineCap=t.lineJoin="round",t.miterLimit=2,t.textBaseline="middle",t.setTransform(e.ratio,0,0,e.ratio,0,0);for(var s,n=0,o=E.length;n<o;++n)if((s=E[n]).hasLabel&&s.showLabel)for(var h,l=s.drawTiles,c=0,u=l.length;c<u;++c)if((h=l[c]).l)for(var f=0,p=h.l.length;f<p;++f)r(h.l[f],t,h,i);return t.restore(),i}},function(){function t(t){return t<5?{"background-image":'url("img/m0.png")',color:"black",width:"53px",height:"53px","line-height":"53px"}:t<20?{"background-image":'url("img/m1.png")',color:"black",width:"56px",height:"56px","line-height":"56px"}:t<100?{"background-image":'url("img/m2.png")',color:"black",width:"66px",height:"66px","line-height":"66px"}:t<400?{"background-image":'url("img/m3.png")',color:"black",width:"78px",height:"78px","line-height":"78px"}:{"background-image":'url("img/m4.png")',color:"black",width:"90px",height:"90px","line-height":"90px"}}function e(t){this._markerClusterer=t,this._map=t.getMap(),this._minClusterSize=t.getMinClusterSize(),this._isAverageCenter=t.isAverageCenter(),this._center=null,this._markers=[],this._gridBounds=null,this._isReal=!1,this._clusterMarker=new i.TextIconOverlay(this._center,this._markers.length,{styles:this._markerClusterer.getStyles()})}var i=window.TMap=TMap||{},s=function(t,e,s){e=n(e);var a=t.pointToPixel(e.getNorthEast()),r=t.pointToPixel(e.getSouthWest());a.x+=s,a.y-=s,r.x-=s,r.y+=s;var o=t.pixelToPoint(a),h=t.pixelToPoint(r);return new i.Bounds(h,o)},n=function(t){var e=a(t.getNorthEast().lon,-180,180),s=a(t.getSouthWest().lon,-180,180),n=a(t.getNorthEast().lat,-74,74),r=a(t.getSouthWest().lat,-74,74);return new i.Bounds(new i.Point(s,r),new i.Point(e,n))},a=function(t,e,i){return e&&(t=Math.max(t,e)),i&&(t=Math.min(t,i)),t},r=function(t){return"[object Array]"===Object.prototype.toString.call(t)},o=function(t,e){var i=-1;if(r(e))if(e.indexOf)i=e.indexOf(t);else for(var s,n=0;s=e[n];n++)if(s===t){i=n;break}return i};(i.MarkerClusterer=function(e,i){if(e){this._map=e,this._markers=[],this._clusters=[];var s=i||{};this._gridSize=s.gridSize||90,this._maxZoom=s.maxZoom||18,this._minClusterSize=s.minClusterSize||2,this._genStyle=s.styler||t,this._isAverageCenter=!0,void 0!=s.isAverageCenter&&(this._isAverageCenter=s.isAverageCenter),this._styles=s.styles||[];var n=this;this._listener=this._map.addEventListener(function(){n._redraw()},["zoomend","moveend"]);var a=s.markers;r(a)&&this.addMarkers(a)}}).prototype={addMarkers:function(t){for(var e=0,i=t.length;e<i;e++)this._pushMarkerTo(t[e]);this._createClusters()},_pushMarkerTo:function(t){-1===o(t,this._markers)&&(t.isInCluster=!1,this._markers.push(t))},addMarker:function(t){this._pushMarkerTo(t),this._createClusters()},_createClusters:function(){for(var t,e=this._map.getBounds(),i=s(this._map,e,this._gridSize),n=0;t=this._markers[n];n++)!t.isInCluster&&i.containsPoint(t.getPoint())&&this._addToClosestCluster(t)},_addToClosestCluster:function(t){t.getPoint();for(var i,s=0;i=this._clusters[s];s++)if(i.isMarkerInClusterBounds(t))return void i.addMarker(t);(i=new e(this)).addMarker(t),this._clusters.push(i)},_clearLastClusters:function(){for(var t,e=0;t=this._clusters[e];e++)t.remove();this._clusters=[],this._removeMarkersFromCluster()},_removeMarkersFromCluster:function(){for(var t,e=0;t=this._markers[e];e++)t.isInCluster=!1},_removeMarkersFromMap:function(){for(var t,e=0;t=this._markers[e];e++)t.isInCluster=!1,this._map.removeOverlay(t)},_removeMarker:function(t){var e=o(t,this._markers);return-1!==e&&(this._map.removeOverlay(t),this._markers.splice(e,1),!0)},removeMarker:function(t){var e=this._removeMarker(t);return e&&(this._clearLastClusters(),this._createClusters()),e},removeMarkers:function(t){for(var e=!1,i=0;i<t.length;i++){var s=this._removeMarker(t[i]);e=e||s}return e&&(this._clearLastClusters(),this._createClusters()),e},clearMarkers:function(){this._clearLastClusters(),this._removeMarkersFromMap(),this._markers=[]},_redraw:function(){this._clearLastClusters(),this._createClusters()},getGridSize:function(){return this._gridSize},setGridSize:function(t){this._gridSize=t,this._redraw()},getMaxZoom:function(){return this._maxZoom},setMaxZoom:function(t){this._maxZoom=t,this._redraw()},getStyles:function(){return this._styles},setStyles:function(t){this._styles=t,this._redraw()},getMinClusterSize:function(){return this._minClusterSize},setMinClusterSize:function(t){this._minClusterSize=t,this._redraw()},isAverageCenter:function(){return this._isAverageCenter},getMap:function(){return this._map},getMarkers:function(){return this._markers},getClustersCount:function(){for(var t,e=0,i=0;t=this._clusters[i];i++)t.isReal()&&e++;return e},uninstall:function(){this.clearMarkers(),this._map.removeListener(this._listener)}},e.prototype={addMarker:function(t){if(this.isMarkerInCluster(t))return!1;if(this._center){if(this._isAverageCenter){var e=this._markers.length+1,s=t.getPoint(),n=(this._center.lat*(e-1)+s.lat)/e,a=(this._center.lon*(e-1)+s.lon)/e;this._center=new i.Point(a,n),this.updateGridBounds()}}else this._center=t.getPoint(),this.updateGridBounds();t.isInCluster=!0,this._markers.push(t);var r=this._markers.length;if(r<this._minClusterSize)return this._map.addOverlay(t),!0;if(r===this._minClusterSize)for(var o=0;o<r;o++)this._map.removeOverlay(this._markers[o]);return this._isReal=!0,this.updateClusterMarker(),!0},isMarkerInCluster:function(t){if(this._markers.indexOf)return-1!=this._markers.indexOf(t);for(var e,i=0;e=this._markers[i];i++)if(e===t)return!0;return!1},isMarkerInClusterBounds:function(t){return this._gridBounds.containsPoint(t.getPoint())},isReal:function(t){return this._isReal},updateGridBounds:function(){var t=new i.Bounds(this._center,this._center);this._gridBounds=s(this._map,t,this._markerClusterer.getGridSize())},updateClusterMarker:function(){if(this._map.getZoom()>this._markerClusterer.getMaxZoom()){this._map.removeOverlay(this._clusterMarker);for(var t,e=0;t=this._markers[e];++e)this._map.addOverlay(t)}else if(this._markers.length<this._minClusterSize)this._clusterMarker.hide();else{this._map.addOverlay(this._clusterMarker),this._clusterMarker._sv.css(this._markerClusterer._genStyle(this._markers.length)),this._clusterMarker.setPoint(this._center),this._clusterMarker.setText(this._markers.length);var i=this;this._clusterMarker.click(function(t){i._map.setViewport(i.getBounds())})}},remove:function(){for(var t=0;this._markers[t];t++)this._map.removeOverlay(this._markers[t]);this._map.removeOverlay(this._clusterMarker),this._markers.length=0,delete this._markers},getBounds:function(){for(var t,e=new i.Bounds(this._center,this._center),s=0;t=this._markers[s];s++)e.extend(t.getPoint());return e},getCenter:function(){return this._center}}}();